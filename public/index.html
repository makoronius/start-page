<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2025-10-17-color-themes-debug -->
    <title>Local Services Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üöÄ</text></svg>">
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #718096;
            --text-header: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            --border-color: #e2e8f0;
            --input-bg: #f7fafc;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-card: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-header: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
            --border-color: #4a5568;
            --input-bg: #1a202c;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 2rem;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-header);
            position: relative;
            padding-top: 0.5rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .theme-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            z-index: 10;
        }

        .theme-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .theme-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .theme-btn:hover {
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .category-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
        }

        .sub-tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .sub-tab-btn:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .sub-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: var(--input-bg);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .tab-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .services-grid[data-columns="1"] {
            grid-template-columns: 1fr;
        }

        .services-grid[data-columns="2"] {
            grid-template-columns: repeat(2, 1fr);
        }

        .services-grid[data-columns="3"] {
            grid-template-columns: repeat(3, 1fr);
        }

        .services-grid[data-columns="4"] {
            grid-template-columns: repeat(4, 1fr);
        }

        .service-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto auto;
            gap: 0.5rem 1rem;
            align-items: start;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .service-icon {
            grid-row: 1 / 3;
            width: 40px;
            height: 40px;
            background: var(--button-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .service-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            grid-column: 2;
        }

        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-status {
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .service-url {
            grid-column: 2;
            color: #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin-top: -0.25rem;
        }

        .service-description {
            grid-column: 1 / -1;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .status-running {
            background: #c6f6d5;
            color: #22543d;
        }

        .config-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .config-section h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .services-editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .service-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: move;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .service-editor:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .service-list-item {
            padding: 0.75rem 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-list-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .service-list-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .service-list-info {
            flex: 1;
            min-width: 0;
        }

        .service-list-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .service-list-url {
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .service-list-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .service-list-actions button {
            padding: 0.4rem 0.75rem;
            font-size: 0.9rem;
        }

        .service-editor.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .service-editor.drag-over {
            border-color: #667eea;
            border-style: dashed;
            background: var(--input-bg);
        }

        .service-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
            margin-right: 0.5rem;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .service-editor h4 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
            grid-column: 1 / -1;
        }

        .service-editor-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .field-full-width {
            grid-column: 1 / -1;
        }

        .settings-editor {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .category-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .category-editor-content {
            flex: 1;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .category-drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
        }

        .category-drag-handle:active {
            cursor: grabbing;
        }

        .category-section {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .category-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .services-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            min-height: 100px;
        }

        .services-category-grid.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .user-card {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-roles {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            background: var(--button-bg);
            color: var(--button-text);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .role-editor-card {
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .role-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .role-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .role-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-group-inline label {
            margin-bottom: 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-header);
        }

        /* Login page styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: #fed7d7;
            color: #742a2a;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        [data-theme="dark"] .login-error {
            background: #742a2a;
            color: #fed7d7;
        }

        .header-user-info {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-user-info span {
            color: var(--text-primary);
            font-weight: 500;
        }

        .logout-btn {
            padding: 0.4rem 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f56565;
            color: white;
            border-color: #f56565;
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Profile modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .modal-close {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Dialog modal styles */
        .dialog-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            animation: slideIn 0.3s ease;
        }

        .dialog-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .dialog-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .dialog-icon.warning {
            color: #f59e0b;
        }

        .dialog-icon.error {
            color: #ef4444;
        }

        .dialog-icon.info {
            color: #3b82f6;
        }

        .dialog-icon.success {
            color: #10b981;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .dialog-message {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .dialog-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .dialog-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .dialog-btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-btn-secondary:hover {
            background: var(--border-color);
        }

        .profile-info {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .profile-info p {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .profile-info strong {
            color: var(--text-primary);
        }

        .username-link {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .username-link:hover {
            color: #667eea;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .error {
            background: #742a2a;
            color: #fed7d7;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .success {
            background: #22543d;
            color: #c6f6d5;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            header {
                padding-top: 0;
                margin-bottom: 1rem;
            }

            header h1 {
                font-size: 1.75rem;
            }

            header p {
                font-size: 0.9rem;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .theme-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 1rem;
            }

            .theme-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Search and Filter Styles */
        .search-container {
            max-width: 600px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            opacity: 0.5;
        }

        /* Favorite Star */
        .favorite-star {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }

        .favorite-star:hover {
            transform: scale(1.2);
        }

        .favorite-star.favorited {
            filter: drop-shadow(0 0 3px gold);
        }

        /* Animation Classes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .service-card {
            animation: fadeIn 0.3s ease-out;
            animation-fill-mode: backwards;
        }

        .service-card:nth-child(1) { animation-delay: 0.05s; }
        .service-card:nth-child(2) { animation-delay: 0.1s; }
        .service-card:nth-child(3) { animation-delay: 0.15s; }
        .service-card:nth-child(4) { animation-delay: 0.2s; }
        .service-card:nth-child(5) { animation-delay: 0.25s; }
        .service-card:nth-child(6) { animation-delay: 0.3s; }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            box-shadow: -2px 0 10px var(--shadow);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .settings-panel.open {
            right: 0;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .settings-tab:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .settings-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--button-bg);
            font-weight: 600;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* Easter Egg Container */
        .easter-egg {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .easter-egg.show {
            display: block;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #fc8181;
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Category Color Variants */
        .category-professional .service-icon {
            background: linear-gradient(135deg, var(--color-professional, #667eea) 0%, color-mix(in srgb, var(--color-professional, #667eea) 70%, black) 100%) !important;
        }
        .category-system .service-icon {
            background: linear-gradient(135deg, var(--color-system, #fc8181) 0%, color-mix(in srgb, var(--color-system, #fc8181) 70%, black) 100%) !important;
        }
        .category-external .service-icon {
            background: linear-gradient(135deg, var(--color-external, #48bb78) 0%, color-mix(in srgb, var(--color-external, #48bb78) 70%, black) 100%) !important;
        }
        .category-family .service-icon {
            background: linear-gradient(135deg, var(--color-family, #ed8936) 0%, color-mix(in srgb, var(--color-family, #ed8936) 70%, black) 100%) !important;
        }
        .category-default .service-icon {
            background: linear-gradient(135deg, var(--color-professional, #667eea) 0%, color-mix(in srgb, var(--color-professional, #667eea) 70%, black) 100%) !important;
        }

        /* Dynamic Background Particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: float 20s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0); }
            25% { transform: translateY(-20px) translateX(10px); }
            50% { transform: translateY(-40px) translateX(-10px); }
            75% { transform: translateY(-20px) translateX(5px); }
        }

        /* Responsive adjustments for new features */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }

            .search-container {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="container">
        <header>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="light" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
                <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô Dark</button>
                <button class="theme-btn" data-theme="system" onclick="setTheme('system')">üíª System</button>
            </div>
            <h1>üöÄ Local Services Dashboard</h1>
            <p>Your development environment at a glance</p>
        </header>

        <div class="login-container">
            <div class="login-box">
                <h2>Sign In</h2>
                <div id="login-error" class="login-error hidden"></div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    <p>Local access (localhost) bypasses authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="container hidden">
        <header>
            <div class="header-user-info" id="user-info">
                <a href="#" class="username-link" id="username-display" onclick="showProfile(event)"><span style="margin-right: 0.5rem;">üë§</span><span id="username-text"></span></a>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
            <h1 id="pageTitle">üöÄ Local Services Dashboard</h1>
            <p id="pageSubtitle">Your development environment at a glance</p>
        </header>

        <div class="tabs">
            <div id="category-tabs" class="category-tabs"></div>
            <button id="config-tab-btn" class="tab-btn" onclick="switchTab('config')" style="display: none;">Config</button>
        </div>

        <div id="services-tab" class="tab-content active">
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-box" class="search-box" placeholder="Search services..." oninput="filterServices()">
            </div>
            <div id="loading" class="loading">
                <p>Loading services...</p>
            </div>
            <div id="services-grid" class="services-grid"></div>
        </div>

        <div id="config-tab" class="tab-content">
            <div class="config-section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div id="config-message"></div>

                <!-- Config Sub-tabs -->
                <div class="sub-tabs">
                    <button class="sub-tab-btn active" onclick="switchConfigTab('general')">General Settings</button>
                    <button class="sub-tab-btn" onclick="switchConfigTab('services')">Services</button>
                    <button class="sub-tab-btn" onclick="switchConfigTab('users')">Users & Access</button>
                </div>

                <!-- General Settings Sub-tab -->
                <div id="general-subtab" class="sub-tab-content active">
                    <div id="settings-editor"></div>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Categories</h3>
                    <div id="categories-editor"></div>
                    <button class="btn btn-primary" onclick="addCategory()" style="margin-top: 1rem;">+ Add New Category</button>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                        <button class="btn btn-secondary" onclick="generateCSV()">üìÑ Generate CSV to Server</button>
                    </div>
                </div>

                <!-- Services Sub-tab -->
                <div id="services-subtab" class="sub-tab-content">
                    <div id="services-by-category"></div>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                    </div>
                </div>

                <!-- Users & Access Sub-tab -->
                <div id="users-subtab" class="sub-tab-content">
                    <h3 style="margin-bottom: 1rem;">Users</h3>
                    <div id="users-list"></div>
                    <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-top: 1rem;">+ Add New User</button>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Roles & Access Rights</h3>
                    <div id="roles-editor"></div>
                    <button class="btn btn-primary" onclick="showAddRoleModal()" style="margin-top: 1rem;">+ Add New Role</button>
                </div>
            </div>
        </div>
    </div> <!-- End of config-tab -->
    </div> <!-- End of main-dashboard -->

    <!-- Profile Modal -->
    <!-- Dialog Modal -->
    <div id="dialog-modal" class="modal-overlay hidden">
        <div class="dialog-modal">
            <div class="dialog-header">
                <span id="dialog-icon" class="dialog-icon"></span>
                <h3 id="dialog-title" class="dialog-title"></h3>
            </div>
            <div id="dialog-message" class="dialog-message"></div>
            <div class="dialog-actions" id="dialog-actions"></div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-modal" class="modal-overlay hidden" onclick="closeUserModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
            <h2 id="user-modal-title">Add User</h2>
            <div id="user-modal-message"></div>

            <div class="form-group">
                <label for="user-username">Username *</label>
                <input type="text" id="user-username" required>
            </div>

            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email">
            </div>

            <div class="form-group">
                <label for="user-password">Password *</label>
                <input type="password" id="user-password" required>
                <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Password must be at least 8 characters with uppercase, lowercase, number, and special character
                </small>
            </div>

            <div class="form-group">
                <label>Roles *</label>
                <div id="user-roles-checkboxes"></div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveUser()">Save User</button>
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Role Edit Modal -->
    <div id="role-modal" class="modal-overlay hidden" onclick="closeRoleModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeRoleModal()">&times;</button>
            <h2 id="role-modal-title">Add Role</h2>
            <div id="role-modal-message"></div>

            <div class="form-group">
                <label for="role-name">Role Name *</label>
                <input type="text" id="role-name" required>
            </div>

            <div class="form-group">
                <label for="role-description">Description</label>
                <input type="text" id="role-description">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="role-is-admin">
                    <span>Administrator (can access Config tab)</span>
                </label>
            </div>

            <div class="form-group">
                <label>Access to Categories</label>
                <div id="role-categories-checkboxes"></div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveRole()">Save Role</button>
                <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Service Edit Modal -->
    <div id="service-modal" class="modal-overlay hidden" onclick="closeServiceModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            <h2 id="service-modal-title">Edit Service</h2>
            <div id="service-modal-message"></div>

            <div class="form-group">
                <label for="service-name">Name *</label>
                <input type="text" id="service-name" required>
            </div>

            <div class="form-group">
                <label for="service-icon">Icon (emoji)</label>
                <input type="text" id="service-icon" placeholder="üîß">
            </div>

            <div class="form-group">
                <label for="service-url">URL *</label>
                <input type="text" id="service-url" required placeholder="http://localhost:8080">
            </div>

            <div class="form-group">
                <label for="service-description">Description</label>
                <textarea id="service-description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="service-port">Port</label>
                <input type="number" id="service-port" placeholder="8080">
            </div>

            <div class="form-group">
                <label for="service-category">Category *</label>
                <select id="service-category" required>
                    <option value="">Select category...</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="service-local">
                    <span>Local service</span>
                </label>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveService()">Save Service</button>
                <button class="btn btn-secondary" onclick="closeServiceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">‚öôÔ∏è Settings</h2>
            <button onclick="toggleSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary); padding: 0; line-height: 1;" title="Close">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('favourites')">‚≠ê Favourites</button>
            <button class="settings-tab" onclick="switchSettingsTab('profile')">üë§ Profile</button>
            <button class="settings-tab" onclick="switchSettingsTab('customization')">üé® Customization</button>
        </div>

        <!-- Favourites Tab -->
        <div id="favourites-tab" class="settings-tab-content active">
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Quick access to all your favorited services</p>
            <div id="favourites-list" style="display: grid; gap: 0.75rem;">
                <!-- Favorited services will be populated here -->
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="settings-tab-content">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Profile Information</h3>
            <div id="profile-message"></div>

            <div class="form-group">
                <label for="profile-first-name">First Name</label>
                <input type="text" id="profile-first-name">
            </div>

            <div class="form-group">
                <label for="profile-last-name">Last Name</label>
                <input type="text" id="profile-last-name">
            </div>

            <div class="form-group">
                <label for="profile-email-input">Email</label>
                <input type="email" id="profile-email-input">
            </div>

            <div class="profile-info" style="margin-bottom: 1.5rem;">
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Roles:</strong> <span id="profile-roles"></span></p>
            </div>

            <button class="btn btn-primary" onclick="updateProfile()" style="margin-bottom: 2rem;">Save Profile</button>

            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Change Password</h3>
            <div id="password-message"></div>

            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" required>
            </div>

            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" required>
                <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Password must be at least 8 characters with uppercase, lowercase, number, and special character
                </small>
            </div>

            <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" required>
            </div>

            <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
        </div>

        <!-- Customization Tab -->
        <div id="customization-tab" class="settings-tab-content">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="sound-enabled" onchange="toggleSound()" />
                    Enable Sound Effects
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="particles-enabled" onchange="toggleParticles()" checked />
                    Enable Background Particles
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="animations-enabled" onchange="toggleAnimations()" checked />
                    Enable Animations
                </label>
            </div>

            <div class="form-group">
                <label>Theme</label>
                <div class="theme-switcher" style="margin-top: 0.5rem;">
                    <button class="theme-btn" data-theme="light" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô Dark</button>
                    <button class="theme-btn" data-theme="system" onclick="setTheme('system')">üíª System</button>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="show-favourites-tab" onchange="toggleFavouritesTab()" checked />
                    Show Favourites Tab
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="favorites-only" onchange="filterServices()" />
                    Show Favorites Only
                </label>
            </div>

            <div class="form-group">
                <label>Category Color Theme</label>
                <select id="color-theme" onchange="applyColorTheme()">
                    <option value="default">Default</option>
                    <option value="vibrant">Vibrant</option>
                    <option value="pastel">Pastel</option>
                    <option value="monochrome">Monochrome</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Easter Egg Container -->
    <div id="easter-egg" class="easter-egg"></div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Background Particles -->
    <div id="bg-particles" class="bg-particles"></div>

    <script>
        let config = null;
        let currentUser = null;

        // Custom Dialog System
        function showDialog(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('dialog-modal');
                const icon = document.getElementById('dialog-icon');
                const title = document.getElementById('dialog-title');
                const message = document.getElementById('dialog-message');
                const actions = document.getElementById('dialog-actions');

                // Set icon
                icon.className = 'dialog-icon ' + (options.type || 'info');
                const iconMap = {
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ'
                };
                icon.textContent = iconMap[options.type] || '‚ÑπÔ∏è';

                // Set content
                title.textContent = options.title || 'Notice';
                message.textContent = options.message || '';

                // Build actions
                actions.innerHTML = '';

                if (options.confirm) {
                    // Confirm dialog
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'dialog-btn dialog-btn-secondary';
                    cancelBtn.textContent = options.cancelText || 'Cancel';
                    cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };

                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'dialog-btn dialog-btn-primary';
                    confirmBtn.textContent = options.confirmText || 'OK';
                    confirmBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };

                    actions.appendChild(cancelBtn);
                    actions.appendChild(confirmBtn);
                } else {
                    // Alert dialog
                    const okBtn = document.createElement('button');
                    okBtn.className = 'dialog-btn dialog-btn-primary';
                    okBtn.textContent = 'OK';
                    okBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };
                    actions.appendChild(okBtn);
                }

                // Show modal
                modal.classList.remove('hidden');
            });
        }

        // Replace alert() and confirm()
        function customAlert(message, title = 'Notice', type = 'info') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: false
            });
        }

        function customConfirm(message, title = 'Confirm', type = 'warning') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: true,
                confirmText: 'Confirm',
                cancelText: 'Cancel'
            });
        }

        // Theme Management
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        function applyTheme(theme) {
            if (theme === 'system') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', systemTheme);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }

            // Update active button
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });
        }

        function setTheme(theme) {
            setCookie('theme', theme);
            applyTheme(theme);
        }

        // Initialize theme from cookie
        const savedTheme = getCookie('theme') || 'system';
        applyTheme(savedTheme);

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const currentTheme = getCookie('theme') || 'system';
            if (currentTheme === 'system') {
                applyTheme('system');
            }
        });

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.authenticated) {
                    currentUser = data.user;

                    // Show/hide Config tab based on admin status
                    const configBtn = document.getElementById('config-tab-btn');
                    if (currentUser.is_admin) {
                        configBtn.style.display = 'inline-block';
                    } else {
                        configBtn.style.display = 'none';
                    }

                    showDashboard();
                    loadConfig();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');

            // Update user info display
            if (currentUser) {
                let displayName;
                if (currentUser.is_local) {
                    displayName = `${currentUser.username} (Local Access)`;
                } else if (currentUser.first_name) {
                    displayName = `Hello, ${currentUser.first_name}`;
                } else {
                    displayName = currentUser.username;
                }
                document.getElementById('username-text').textContent = displayName;

                // Hide user info for local access
                if (currentUser.is_local) {
                    document.getElementById('user-info').style.display = 'none';
                }

                // Show/hide Config tab based on admin status
                const configBtn = document.getElementById('config-tab-btn');
                if (currentUser.is_admin) {
                    configBtn.style.display = 'inline-block';
                } else {
                    configBtn.style.display = 'none';
                }
            }
        }

        // Profile functions
        function showProfile(event) {
            if (event) event.preventDefault();

            // Load profile data
            fetch('/api/auth/profile', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-roles').textContent = data.roles.join(', ');

                // Populate editable fields
                document.getElementById('profile-first-name').value = data.first_name || '';
                document.getElementById('profile-last-name').value = data.last_name || '';
                document.getElementById('profile-email-input').value = data.email || '';

                // Open settings panel on Profile tab
                switchSettingsTab('profile');
                document.getElementById('settings-panel').classList.add('open');
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
        }

        async function updateProfile() {
            const messageDiv = document.getElementById('profile-message');
            const first_name = document.getElementById('profile-first-name').value.trim();
            const last_name = document.getElementById('profile-last-name').value.trim();
            const email = document.getElementById('profile-email-input').value.trim();

            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ first_name, last_name, email })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to update profile');
                }

                showToast('Profile updated successfully!', 'success');

                // Update header with new name
                updateHeaderName(first_name);
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast(`Failed to update profile: ${error.message}`, 'error');
            }
        }

        function updateHeaderName(firstName) {
            if (firstName && currentUser) {
                currentUser.first_name = firstName;
                const displayName = `Hello, ${firstName}`;
                document.getElementById('username-text').textContent = displayName;
            }
        }

        function switchSettingsTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab and content
            event?.target?.classList.add('active');
            document.getElementById(`${tabName}-tab`)?.classList.add('active');

            // Also activate the tab button if called programmatically
            const tabButtons = document.querySelectorAll('.settings-tab');
            tabButtons.forEach(button => {
                const tabMap = {
                    'favourites': 'Favourites',
                    'profile': 'Profile',
                    'customization': 'Customization'
                };
                if (button.textContent.includes(tabMap[tabName])) {
                    button.classList.add('active');
                }
            });

            // Populate favourites if that tab is selected
            if (tabName === 'favourites') {
                populateFavourites();
            }
        }

        function populateFavourites() {
            const favouritesList = document.getElementById('favourites-list');
            if (!favouritesList || !config) return;

            const favourites = [];

            // Collect all favorited services from all categories
            Object.keys(config.categories || {}).forEach(categoryName => {
                const category = config.categories[categoryName];
                if (category.services) {
                    category.services.forEach(service => {
                        if (service.favorite) {
                            favourites.push({
                                ...service,
                                category: categoryName,
                                categoryColor: getCategoryColor(categoryName)
                            });
                        }
                    });
                }
            });

            if (favourites.length === 0) {
                favouritesList.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No favorites yet. Click the ‚≠ê icon on any service to add it to your favorites!</p>';
                return;
            }

            // Render favorites as service cards
            favouritesList.innerHTML = favourites.map(service => `
                <div class="service-card" style="display: flex; align-items: center; padding: 1rem; background: var(--card-bg); border-radius: 8px; border: 1px solid var(--border); gap: 1rem;">
                    <div class="service-icon" style="width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, ${service.categoryColor} 0%, color-mix(in srgb, ${service.categoryColor} 70%, black) 100%); font-size: 1.2rem;">
                        ${service.icon || 'üîó'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500; color: var(--text-primary);">${service.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">${service.category}</div>
                    </div>
                    <a href="${service.url}" target="_blank" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem; text-decoration: none;">Open</a>
                </div>
            `).join('');
        }

        function getCategoryColor(categoryName) {
            const colorMap = {
                'professional': 'var(--color-professional, #667eea)',
                'system': 'var(--color-system, #fc8181)',
                'external': 'var(--color-external, #48bb78)',
                'family': 'var(--color-family, #ed8936)'
            };
            return colorMap[categoryName.toLowerCase()] || 'var(--color-professional, #667eea)';
        }

        function toggleFavouritesTab() {
            const checkbox = document.getElementById('show-favourites-tab');
            const favouritesTabBtn = document.querySelector('.settings-tab[onclick*="favourites"]');
            const favouritesTab = document.getElementById('favourites-tab');

            if (checkbox.checked) {
                favouritesTabBtn.style.display = 'inline-block';
                localStorage.setItem('showFavouritesTab', 'true');
            } else {
                favouritesTabBtn.style.display = 'none';
                // If currently viewing favourites tab, switch to profile
                if (favouritesTab.classList.contains('active')) {
                    switchSettingsTab('profile');
                }
                localStorage.setItem('showFavouritesTab', 'false');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageDiv = document.getElementById('password-message');

            messageDiv.innerHTML = '';

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageDiv.innerHTML = '<div class="error">All fields are required</div>';
                return;
            }

            if (newPassword !== confirmPassword) {
                messageDiv.innerHTML = '<div class="error">New passwords do not match</div>';
                return;
            }

            if (newPassword.length < 6) {
                messageDiv.innerHTML = '<div class="error">New password must be at least 6 characters</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Password changed successfully!</div>';
                    // Clear fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    // Clear message after 3 seconds
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${data.error || 'Failed to change password'}</div>`;
                }
            } catch (error) {
                console.error('Error changing password:', error);
                messageDiv.innerHTML = '<div class="error">Connection error. Please try again.</div>';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    showDashboard();
                    loadConfig();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                currentUser = null;
                showLogin();

                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // State Management
        function saveState() {
            // Get current config sub-tab
            const activeSubTab = document.querySelector('.sub-tab-btn.active');
            const currentConfigSubTab = activeSubTab ?
                activeSubTab.textContent.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-') : 'general';

            const state = {
                currentTab: getCurrentTab(),
                currentCategory: window.currentCategory || null,
                currentConfigSubTab: currentConfigSubTab,
                timestamp: Date.now()
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('dashboardState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    return state;
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return null;
        }

        function getCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                return activeTab.id.replace('-tab', '');
            }
            return 'services';
        }

        function restoreTab() {
            const state = loadState();
            if (state) {
                // Prevent non-admin users from restoring config tab
                if (state.currentTab === 'config' && currentUser && !currentUser.is_admin) {
                    // Stay on default services tab for non-admin users
                    return;
                }

                // Restore category if in services view
                if (state.currentCategory && state.currentTab === 'services') {
                    switchCategory(state.currentCategory);
                }

                // Restore main tab
                if (state.currentTab && state.currentTab !== 'services') {
                    const tabButtons = document.querySelectorAll('.tab-btn');
                    tabButtons.forEach((btn) => {
                        if (btn.textContent.toLowerCase().includes(state.currentTab.toLowerCase())) {
                            // Remove active from all
                            tabButtons.forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                            // Add active to target
                            btn.classList.add('active');
                            document.getElementById(`${state.currentTab}-tab`).classList.add('active');

                            // Render config if needed
                            if (state.currentTab === 'config' && config) {
                                renderSettingsEditor();
                                renderCategoriesEditor();
                                renderServicesByCategory_Config();

                                // Restore config sub-tab
                                if (state.currentConfigSubTab) {
                                    // Map display name back to sub-tab name
                                    let subTabName = 'general';
                                    if (state.currentConfigSubTab.includes('users')) {
                                        subTabName = 'users';
                                    } else if (state.currentConfigSubTab.includes('services')) {
                                        subTabName = 'services';
                                    }

                                    // Update sub-tab buttons
                                    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                                        btn.classList.remove('active');
                                        if (btn.textContent.toLowerCase().includes(subTabName) ||
                                            (subTabName === 'general' && btn.textContent.includes('General'))) {
                                            btn.classList.add('active');
                                        }
                                    });

                                    // Update sub-tab content
                                    document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
                                    document.getElementById(`${subTabName}-subtab`)?.classList.add('active');

                                    // Load data if needed
                                    if (subTabName === 'users') {
                                        loadUsers();
                                        loadRoles();
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }

        // Tab Management
        function switchTab(tabName) {
            // Prevent non-admin users from accessing config tab
            if (tabName === 'config' && currentUser && !currentUser.is_admin) {
                // Redirect to dashboard
                tabName = 'dashboard';
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'config' && config) {
                renderSettingsEditor();
                renderCategoriesEditor();
                renderServicesByCategory_Config();
            }

            // Save state
            saveState();
        }

        // Switch between config sub-tabs
        function switchConfigTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${subTabName}-subtab`).classList.add('active');

            // Load users if switching to users tab
            if (subTabName === 'users') {
                loadUsers();
                loadRoles();
            }

            // Save state
            saveState();
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config', {
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // Not authenticated, show login
                    showLogin();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load configuration');

                config = await response.json();

                // Update title and subtitle
                if (config.settings) {
                    document.getElementById('pageTitle').textContent = 'üöÄ ' + (config.settings.title || 'Local Services Dashboard');
                    document.getElementById('pageSubtitle').textContent = config.settings.subtitle || 'Your development environment at a glance';
                }

                // Render category tabs and services
                renderCategoryTabs();

                // Restore tab state after config is loaded
                setTimeout(() => restoreTab(), 100);
            } catch (error) {
                console.error('Error loading config:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #f56565;">Error loading services. Please refresh the page.</p>';
            }
        }

        // Get favicon URL
        function getFaviconUrl(serviceUrl) {
            try {
                const url = new URL(serviceUrl);
                return `${url.protocol}//${url.host}/favicon.ico`;
            } catch (e) {
                return null;
            }
        }

        // Render category tabs
        function renderCategoryTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                return;
            }

            config.categories.forEach((category, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.textContent = category.name;
                btn.onclick = () => switchCategory(category.name);

                if (index === 0 && !window.currentCategory) {
                    btn.classList.add('active');
                    window.currentCategory = category.name;
                }

                container.appendChild(btn);
            });

            // Render services for the first/current category
            renderServicesByCategory(window.currentCategory || config.categories[0].name);
        }

        // Switch category
        function switchCategory(categoryName) {
            // Update active category tab
            document.querySelectorAll('#category-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === categoryName) {
                    btn.classList.add('active');
                }
            });

            // Make sure services tab is active
            document.querySelectorAll('.tabs > .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('services-tab').classList.add('active');

            window.currentCategory = categoryName;
            renderServicesByCategory(categoryName);
            saveState();
        }

        // Render services by category
        function renderServicesByCategory(categoryName) {
            const grid = document.getElementById('services-grid');
            const loading = document.getElementById('loading');

            loading.style.display = 'none';
            grid.innerHTML = '';

            // Apply grid columns setting
            const gridColumns = config.settings?.grid_columns || 'auto';
            if (gridColumns === 'auto') {
                grid.removeAttribute('data-columns');
            } else {
                grid.setAttribute('data-columns', gridColumns);
            }

            if (!config.services || config.services.length === 0) {
                grid.innerHTML = '<p>No services configured. Go to Config tab to add services.</p>';
                return;
            }

            // Filter services by category
            const categoryServices = config.services.filter(s => s.category === categoryName);

            if (categoryServices.length === 0) {
                grid.innerHTML = `<p>No services in ${categoryName} category.</p>`;
                return;
            }

            categoryServices.forEach(service => {
                const card = document.createElement('a');
                card.href = service.url;
                card.className = 'service-card';
                card.target = '_blank';
                card.style.position = 'relative';

                // Add category color class
                const catClass = categoryName.toLowerCase().replace(/\s+/g, '-');
                card.setAttribute('data-category', catClass);
                card.classList.add(`category-${catClass}`);

                const faviconUrl = getFaviconUrl(service.url);
                const iconContent = service.icon || 'üîß';

                // Try to load favicon, fall back to emoji if it fails
                let iconHtml = iconContent;
                if (faviconUrl) {
                    iconHtml = `<img src="${faviconUrl}" alt="${service.name}" onerror="this.parentElement.innerHTML='${iconContent}'" />`;
                }

                // Favorite star
                const isFav = isFavorite(service.name);
                const starClass = isFav ? 'favorited' : '';

                card.innerHTML = `
                    <span class="favorite-star ${starClass}" onclick="toggleFavorite('${service.name}', event)">${isFav ? '‚≠ê' : '‚òÜ'}</span>
                    <div class="service-icon">${iconHtml}</div>
                    <div class="service-header">
                        <div class="service-title">${service.name}</div>
                        <span class="service-status status-${service.status || 'running'}">${service.status || 'Running'}</span>
                    </div>
                    <div class="service-url">${service.url}</div>
                    <div class="service-description">${service.description || ''}</div>
                `;

                grid.appendChild(card);
            });
        }

        // Render settings editor
        function renderSettingsEditor() {
            const editor = document.getElementById('settings-editor');

            if (!config.settings) {
                config.settings = {};
            }

            const settings = config.settings;

            editor.innerHTML = `
                <div class="settings-editor">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Hostname</label>
                            <input type="text" value="${settings.hostname || ''}" onchange="updateSetting('hostname', this.value)">
                        </div>
                        <div class="form-group">
                            <label>SSH User</label>
                            <input type="text" value="${settings.ssh_user || ''}" onchange="updateSetting('ssh_user', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Title</label>
                            <input type="text" value="${settings.title || ''}" onchange="updateSetting('title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Subtitle</label>
                            <input type="text" value="${settings.subtitle || ''}" onchange="updateSetting('subtitle', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Auto-Refresh (minutes)</label>
                            <input type="number" value="${settings.auto_refresh_minutes || 5}" onchange="updateSetting('auto_refresh_minutes', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>CSV Path</label>
                            <input type="text" value="${settings.csv_path || '/scripts/port-mappings.csv'}" onchange="updateSetting('csv_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Backup Path</label>
                            <input type="text" value="${settings.backup_path || '/scripts/backups'}" onchange="updateSetting('backup_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>PowerShell Script Path</label>
                            <input type="text" value="${settings.powershell_script_path || '/scripts/Update-DockerPortProxy.ps1'}" onchange="updateSetting('powershell_script_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Grid Columns</label>
                            <select onchange="updateSetting('grid_columns', this.value)" value="${settings.grid_columns || 'auto'}">
                                <option value="auto" ${!settings.grid_columns || settings.grid_columns === 'auto' ? 'selected' : ''}>Auto (responsive)</option>
                                <option value="1" ${settings.grid_columns === '1' ? 'selected' : ''}>1 column</option>
                                <option value="2" ${settings.grid_columns === '2' ? 'selected' : ''}>2 columns</option>
                                <option value="3" ${settings.grid_columns === '3' ? 'selected' : ''}>3 columns</option>
                                <option value="4" ${settings.grid_columns === '4' ? 'selected' : ''}>4 columns</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update setting
        function updateSetting(key, value) {
            if (!config.settings) {
                config.settings = {};
            }
            config.settings[key] = value;
        }

        // Render categories editor
        function renderCategoriesEditor() {
            const editor = document.getElementById('categories-editor');
            editor.innerHTML = '';

            if (!config.categories) {
                config.categories = [];
            }

            config.categories.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-editor';
                categoryDiv.innerHTML = `
                    <div class="category-editor-content">
                        <span class="category-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>Name</label>
                            <input type="text" value="${category.name || ''}" onchange="updateCategory(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="flex: 2; margin: 0;">
                            <label>Description</label>
                            <input type="text" value="${category.description || ''}" onchange="updateCategory(${index}, 'description', this.value)">
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeCategory(${index})">üóë</button>
                `;
                editor.appendChild(categoryDiv);
            });
        }

        // Render services grouped by category in config
        function renderServicesByCategory_Config() {
            const container = document.getElementById('services-by-category');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                container.innerHTML = '<p>No categories defined. Please add categories in General Settings first.</p>';
                return;
            }

            if (!config.services) {
                config.services = [];
            }

            // Apply grid columns setting to config services view
            const gridColumns = config.settings?.grid_columns || 'auto';

            config.categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.dataset.category = category.name;

                // Add drop zone for services
                categorySection.addEventListener('dragover', handleServiceDragOver);
                categorySection.addEventListener('drop', handleServiceDrop);

                const categoryServices = config.services.filter(s => s.category === category.name);

                categorySection.innerHTML = `
                    <div class="category-section-header">
                        <h3 style="margin: 0;">${category.name}</h3>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">${categoryServices.length} service(s)</span>
                    </div>
                    <div class="services-category-grid ${categoryServices.length === 0 ? 'empty' : ''}" data-category="${category.name}" ${gridColumns !== 'auto' ? `style="grid-template-columns: repeat(${gridColumns}, 1fr);"` : ''}>
                        ${categoryServices.length === 0 ? 'Drop services here or add new service' : ''}
                    </div>
                `;

                const grid = categorySection.querySelector('.services-category-grid');

                categoryServices.forEach((service, localIndex) => {
                    const serviceIndex = config.services.findIndex(s => s === service);
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = 'service-list-item';
                    serviceDiv.dataset.index = serviceIndex;
                    serviceDiv.dataset.category = category.name;

                    serviceDiv.innerHTML = `
                        <div class="service-list-icon">${service.icon || 'üîß'}</div>
                        <div class="service-list-info">
                            <div class="service-list-name">${service.name || 'Service'}</div>
                            <div class="service-list-url">${service.url || ''}</div>
                        </div>
                        <div class="service-list-actions">
                            <button class="btn btn-primary" onclick="openServiceEditor(${serviceIndex}); event.stopPropagation();">Edit</button>
                            <button class="btn btn-danger" onclick="removeService(${serviceIndex}); event.stopPropagation();">Delete</button>
                        </div>
                    `;
                    grid.appendChild(serviceDiv);
                });

                // Add "Add Service" button for this category
                const addButton = document.createElement('button');
                addButton.className = 'btn btn-primary';
                addButton.style.marginTop = '1rem';
                addButton.textContent = `+ Add Service to ${category.name}`;
                addButton.onclick = () => addServiceToCategory(category.name);
                categorySection.appendChild(addButton);

                container.appendChild(categorySection);
            });
        }

        // Legacy function kept for compatibility - now calls the new function
        function renderConfigEditor() {
            renderServicesByCategory_Config();
        }

        // Category management
        function updateCategory(index, property, value) {
            config.categories[index][property] = value;
        }

        function addCategory() {
            if (!config.categories) {
                config.categories = [];
            }
            config.categories.push({
                name: 'New Category',
                description: 'Category description'
            });
            renderCategoriesEditor();
        }

        async function removeCategory(index) {
            const category = config.categories[index];
            const hasServices = config.services && config.services.some(s => s.category === category.name);

            if (hasServices) {
                await customAlert(
                    `Cannot delete category "${category.name}" because it contains services. Please move or delete the services first.`,
                    'Cannot Delete Category',
                    'error'
                );
                return;
            }

            const confirmed = await customConfirm(
                `Are you sure you want to delete category "${category.name}"?`,
                'Delete Category',
                'warning'
            );

            if (confirmed) {
                config.categories.splice(index, 1);
                renderCategoriesEditor();
            }
        }

        // Service drag and drop between categories
        let draggedServiceIndex = null;

        function handleServiceDragStart(e) {
            draggedServiceIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleServiceDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleServiceDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleServiceDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCategory = e.currentTarget.dataset.category;
            if (!targetCategory) return false;

            if (draggedServiceIndex !== null && config.services[draggedServiceIndex]) {
                // Update service category
                config.services[draggedServiceIndex].category = targetCategory;

                // Re-render services
                renderServicesByCategory_Config();
            }

            return false;
        }

        // Old render config editor - kept for backward compatibility
        function renderConfigEditor_OLD() {
            const editor = document.getElementById('services-editor');
            if (!editor) return;
            editor.innerHTML = '';

            if (!config.services) {
                config.services = [];
            }

            config.services.forEach((service, index) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'service-editor';
                serviceDiv.draggable = true;
                serviceDiv.dataset.index = index;

                // Add drag event listeners
                serviceDiv.addEventListener('dragstart', handleDragStart);
                serviceDiv.addEventListener('dragend', handleDragEnd);
                serviceDiv.addEventListener('dragover', handleDragOver);
                serviceDiv.addEventListener('drop', handleDrop);
                serviceDiv.addEventListener('dragleave', handleDragLeave);

                serviceDiv.innerHTML = `
                    <div class="service-editor-header">
                        <div style="display: flex; align-items: center;">
                            <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                            <h4 style="margin: 0;">Service ${index + 1}</h4>
                        </div>
                    </div>
                    <div class="service-editor-fields">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" value="${service.name || ''}" onchange="updateService(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Icon (emoji)</label>
                            <input type="text" value="${service.icon || ''}" onchange="updateService(${index}, 'icon', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>URL</label>
                            <input type="text" value="${service.url || ''}" onchange="updateService(${index}, 'url', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>Description</label>
                            <textarea onchange="updateService(${index}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" value="${service.port || ''}" onchange="updateService(${index}, 'port', parseInt(this.value))">
                        </div>
                        <div class="form-group-inline">
                            <label>
                                <input type="checkbox" ${service.local ? 'checked' : ''} onchange="updateService(${index}, 'local', this.checked)">
                                Local service
                            </label>
                        </div>
                        <div class="field-full-width">
                            <button class="btn btn-danger" onclick="removeService(${index})" style="width: 100%; margin-top: 0.5rem;">üóë Delete</button>
                        </div>
                    </div>
                `;
                editor.appendChild(serviceDiv);
            });
        }

        // Update service property
        function updateService(index, property, value) {
            config.services[index][property] = value;
        }

        // Add new service
        function addService() {
            if (!config.services) {
                config.services = [];
            }

            // Default to first category if available
            const defaultCategory = config.categories && config.categories.length > 0
                ? config.categories[0].name
                : 'Uncategorized';

            config.services.push({
                name: 'New Service',
                icon: 'üîß',
                url: 'http://localhost:8080',
                description: 'Service description',
                port: 8080,
                local: true,
                status: 'running',
                category: defaultCategory
            });

            renderServicesByCategory_Config();
        }

        // Add new service to specific category
        function addServiceToCategory(categoryName) {
            if (!config.services) {
                config.services = [];
            }

            // Open the modal for adding new service
            openServiceEditor(null);

            // Pre-select the category
            document.getElementById('service-category').value = categoryName;
        }

        // Remove service
        async function removeService(index) {
            const confirmed = await customConfirm(
                'Are you sure you want to delete this service?',
                'Delete Service',
                'warning'
            );

            if (confirmed) {
                config.services.splice(index, 1);
                renderServicesByCategory_Config();
            }
        }

        // Drag and Drop handlers
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.service-editor').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const dropIndex = parseInt(e.currentTarget.dataset.index);

            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                // Reorder the services array
                const draggedService = config.services[draggedIndex];
                config.services.splice(draggedIndex, 1);
                config.services.splice(dropIndex, 0, draggedService);

                // Re-render the config editor
                renderConfigEditor();
            }

            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        // Save configuration
        async function saveConfig() {
            const messageDiv = document.getElementById('config-message');

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to save configuration');
                }

                showToast('Configuration saved successfully!', 'success');

                // Re-render config editors with current config
                try {
                    renderSettingsEditor();
                    renderCategoriesEditor();
                    renderServicesByCategory_Config();

                    // Update category tabs in main view
                    if (config.categories) {
                        renderCategoryTabs();
                    }

                    // Update dashboard title and subtitle live
                    if (config.dashboard_title) {
                        document.getElementById('pageTitle').textContent = config.dashboard_title;
                    }
                    if (config.dashboard_subtitle) {
                        document.getElementById('pageSubtitle').textContent = config.dashboard_subtitle;
                    }
                } catch (renderError) {
                    console.error('Error re-rendering:', renderError);
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showToast(`Failed to save configuration: ${error.message}`, 'error');
            }
        }

        // Generate CSV to server
        async function generateCSV() {
            try {
                const response = await fetch('/api/csv/generate', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to generate CSV');

                const result = await response.json();

                if (result.success) {
                    let message = `CSV generated successfully at ${result.csv_path}`;
                    if (result.backup_created) {
                        message += '. Backup created.';
                    }
                    showToast(message, 'success', 5000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error generating CSV:', error);
                showToast(`Failed to generate CSV: ${error.message}`, 'error');
            }
        }

        // User Management
        let currentEditingUser = null;
        let usersData = null;

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const users = await response.json();
                console.log('Loaded users:', users); // Debug
                renderUsersList(users);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = '<p style="color: var(--text-primary);">Failed to load users. Please try refreshing.</p>';
            }
        }

        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            container.innerHTML = '';

            if (!users || users.length === 0) {
                container.innerHTML = '<p>No users found. Add a user to get started.</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        ${user.email ? `<div class="user-email">${user.email}</div>` : ''}
                        <div class="user-roles">
                            ${user.roles.map(role => `<span class="role-badge">${role}</span>`).join('')}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="editUser('${user.username}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadRoles() {
            try {
                const response = await fetch('/api/roles', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load roles');

                const roles = await response.json();
                usersData = { roles };
                renderRolesEditor(roles);
            } catch (error) {
                console.error('Error loading roles:', error);
                document.getElementById('roles-editor').innerHTML = '<p class="error">Failed to load roles</p>';
            }
        }

        function renderRolesEditor(roles) {
            const container = document.getElementById('roles-editor');
            container.innerHTML = '';

            if (!roles || roles.length === 0) {
                container.innerHTML = '<p style="color: var(--text-primary);">No roles defined.</p>';
                return;
            }

            roles.forEach((role, roleIndex) => {
                const card = document.createElement('div');
                card.className = 'role-editor-card';

                // Get all available categories
                const availableCategories = config?.categories || [];

                card.innerHTML = `
                    <div class="role-header">
                        <div>
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description || ''}</div>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="deleteRole('${role.name}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <input type="checkbox"
                                   ${role.is_admin ? 'checked' : ''}
                                   onchange="updateRoleAdmin('${role.name}', this.checked)">
                            <span>Administrator (can access Config tab)</span>
                        </label>
                    </div>
                    <div>
                        <strong>Access to categories:</strong>
                        <div style="margin-top: 0.75rem;" id="role-${roleIndex}-categories">
                            ${availableCategories.map(cat => {
                                const isChecked = role.categories && role.categories.includes(cat.name);
                                return `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox"
                                               value="${cat.name}"
                                               ${isChecked ? 'checked' : ''}
                                               onchange="updateRoleCategory('${role.name}', '${cat.name}', this.checked)">
                                        <span>${cat.name}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add single Save Changes button after all roles
            const saveButtonDiv = document.createElement('div');
            saveButtonDiv.style.marginTop = '1.5rem';
            saveButtonDiv.style.textAlign = 'center';
            saveButtonDiv.innerHTML = `
                <button class="btn btn-primary" onclick="saveRoleChanges()" style="padding: 0.75rem 2rem; font-size: 1rem;">
                    üíæ Save All Changes
                </button>
                <div id="role-save-message" style="margin-top: 1rem;"></div>
            `;
            container.appendChild(saveButtonDiv);
        }

        function updateRoleCategory(roleName, categoryName, isChecked) {
            if (!usersData || !usersData.roles) return;

            const role = usersData.roles.find(r => r.name === roleName);
            if (!role) return;

            if (!role.categories) role.categories = [];

            if (isChecked) {
                if (!role.categories.includes(categoryName)) {
                    role.categories.push(categoryName);
                }
            } else {
                role.categories = role.categories.filter(c => c !== categoryName);
            }
        }

        function updateRoleAdmin(roleName, isAdmin) {
            if (!usersData || !usersData.roles) return;

            const role = usersData.roles.find(r => r.name === roleName);
            if (!role) return;

            role.is_admin = isAdmin;
        }

        async function saveRoleChanges() {
            const messageDiv = document.getElementById('role-save-message');
            messageDiv.innerHTML = '';

            try {
                // Save to users.yaml through backend
                const response = await fetch('/api/roles', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ roles: usersData.roles })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to save roles');
                }

                messageDiv.innerHTML = '<div class="success">‚úÖ All role changes saved successfully!</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
                loadRoles();
            } catch (error) {
                console.error('Error saving roles:', error);
                messageDiv.innerHTML = `<div class="error">‚ùå Failed to save changes: ${error.message}</div>`;
            }
        }

        function showAddUserModal() {
            currentEditingUser = null;
            document.getElementById('user-modal-title').textContent = 'Add New User';
            document.getElementById('user-username').value = '';
            document.getElementById('user-username').disabled = false;
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-modal-message').innerHTML = '';

            // Load roles checkboxes
            renderRolesCheckboxes([]);

            document.getElementById('user-modal').classList.remove('hidden');
        }

        async function editUser(username) {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load user');

                const users = await response.json();
                const user = users.find(u => u.username === username);

                if (!user) throw new Error('User not found');

                currentEditingUser = username;
                document.getElementById('user-modal-title').textContent = 'Edit User';
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-username').disabled = true;
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-password').value = '';
                document.getElementById('user-password').placeholder = 'Leave empty to keep current password';
                document.getElementById('user-modal-message').innerHTML = '';

                // Load roles checkboxes with current user roles
                renderRolesCheckboxes(user.roles);

                document.getElementById('user-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading user:', error);
                await customAlert('Failed to load user details', 'Error', 'error');
            }
        }

        function renderRolesCheckboxes(selectedRoles) {
            const container = document.getElementById('user-roles-checkboxes');
            container.innerHTML = '';

            if (!usersData || !usersData.roles) {
                container.innerHTML = '<p>Loading roles...</p>';
                return;
            }

            usersData.roles.forEach(role => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '0.5rem';
                label.style.marginBottom = '0.5rem';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = role.name;
                checkbox.checked = selectedRoles.includes(role.name);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(`${role.name} - ${role.description || ''}`));
                container.appendChild(label);
            });
        }

        async function saveUser() {
            const username = document.getElementById('user-username').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const messageDiv = document.getElementById('user-modal-message');

            // Get selected roles
            const checkboxes = document.querySelectorAll('#user-roles-checkboxes input[type="checkbox"]:checked');
            const roles = Array.from(checkboxes).map(cb => cb.value);

            // Validation
            if (!username) {
                messageDiv.innerHTML = '<div class="error">Username is required</div>';
                return;
            }

            if (!currentEditingUser && !password) {
                messageDiv.innerHTML = '<div class="error">Password is required for new users</div>';
                return;
            }

            if (roles.length === 0) {
                messageDiv.innerHTML = '<div class="error">Please select at least one role</div>';
                return;
            }

            try {
                const userData = {
                    username,
                    email,
                    roles
                };

                if (password) {
                    userData.password = password;
                }

                const url = currentEditingUser ? `/api/users/${currentEditingUser}` : '/api/users';
                const method = currentEditingUser ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save user');
                }

                await customAlert(
                    `User ${currentEditingUser ? 'updated' : 'created'} successfully`,
                    'Success',
                    'success'
                );

                closeUserModal();
                loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function deleteUser(username) {
            const confirmed = await customConfirm(
                `Are you sure you want to delete user "${username}"?`,
                'Delete User',
                'warning'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/users/${username}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                await customAlert('User deleted successfully', 'Success', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                await customAlert(`Failed to delete user: ${error.message}`, 'Error', 'error');
            }
        }

        function closeUserModal(event) {
            // If event is passed, only close if clicking on the background
            if (event && event.target && event.target.id !== 'user-modal') return;
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('user-password').placeholder = '';
            document.getElementById('user-modal-message').innerHTML = '';
            currentEditingUser = null;
        }

        // Role Management Functions
        function showAddRoleModal() {
            document.getElementById('role-modal-title').textContent = 'Add New Role';
            document.getElementById('role-name').value = '';
            document.getElementById('role-description').value = '';
            document.getElementById('role-is-admin').checked = false;
            document.getElementById('role-modal-message').innerHTML = '';

            // Load categories checkboxes
            renderCategoriesCheckboxes([]);

            document.getElementById('role-modal').classList.remove('hidden');
        }

        function renderCategoriesCheckboxes(selectedCategories = []) {
            const container = document.getElementById('role-categories-checkboxes');
            container.innerHTML = '';

            if (!config || !config.categories || config.categories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No categories available</p>';
                return;
            }

            config.categories.forEach(category => {
                const isChecked = selectedCategories.includes(category.name);
                const checkbox = document.createElement('label');
                checkbox.style.display = 'flex';
                checkbox.style.alignItems = 'center';
                checkbox.style.gap = '0.5rem';
                checkbox.style.marginBottom = '0.5rem';
                checkbox.innerHTML = `
                    <input type="checkbox" value="${category.name}" ${isChecked ? 'checked' : ''}>
                    <span>${category.name}</span>
                `;
                container.appendChild(checkbox);
            });
        }

        async function saveRole() {
            const name = document.getElementById('role-name').value.trim();
            const description = document.getElementById('role-description').value.trim();
            const isAdmin = document.getElementById('role-is-admin').checked;
            const messageDiv = document.getElementById('role-modal-message');

            // Get selected categories
            const checkboxes = document.querySelectorAll('#role-categories-checkboxes input[type="checkbox"]:checked');
            const categories = Array.from(checkboxes).map(cb => cb.value);

            if (!name) {
                messageDiv.innerHTML = '<div class="error">Role name is required</div>';
                return;
            }

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name, description, categories, is_admin: isAdmin })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save role');
                }

                await customAlert('Role created successfully!', 'Success', 'success');
                closeRoleModal();
                loadRoles();
            } catch (error) {
                console.error('Error saving role:', error);
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function deleteRole(roleName) {
            // Prevent deletion of Admins role
            if (roleName === 'Admins') {
                await customAlert('Cannot delete the Admins role. This role is required for system administration.', 'Error', 'error');
                return;
            }

            const confirmed = await customConfirm(
                `Are you sure you want to delete the role "${roleName}"?`,
                'Delete Role',
                'warning'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/roles/${roleName}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete role');
                }

                await customAlert('Role deleted successfully', 'Success', 'success');
                loadRoles();
            } catch (error) {
                console.error('Error deleting role:', error);
                await customAlert(`Failed to delete role: ${error.message}`, 'Error', 'error');
            }
        }

        function closeRoleModal(event) {
            if (event && event.target.id !== 'role-modal') return;
            document.getElementById('role-modal').classList.add('hidden');
        }

        // Service Modal Functions
        let currentServiceIndex = null;

        function openServiceEditor(serviceIndex) {
            currentServiceIndex = serviceIndex;
            const service = serviceIndex !== null ? config.services[serviceIndex] : null;
            const modal = document.getElementById('service-modal');

            // Populate category dropdown
            const categorySelect = document.getElementById('service-category');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            if (config.categories) {
                config.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    if (service && service.category === cat.name) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
            }

            // Populate fields
            if (service) {
                document.getElementById('service-modal-title').textContent = 'Edit Service';
                document.getElementById('service-name').value = service.name || '';
                document.getElementById('service-icon').value = service.icon || '';
                document.getElementById('service-url').value = service.url || '';
                document.getElementById('service-description').value = service.description || '';
                document.getElementById('service-port').value = service.port || '';
                document.getElementById('service-local').checked = service.local || false;
            } else {
                document.getElementById('service-modal-title').textContent = 'Add Service';
                document.getElementById('service-name').value = '';
                document.getElementById('service-icon').value = 'üîß';
                document.getElementById('service-url').value = 'http://localhost:8080';
                document.getElementById('service-description').value = '';
                document.getElementById('service-port').value = '8080';
                document.getElementById('service-local').checked = true;
            }

            modal.classList.remove('hidden');
        }

        function closeServiceModal(event) {
            if (event && event.target.id !== 'service-modal') return;
            document.getElementById('service-modal').classList.add('hidden');
            currentServiceIndex = null;
        }

        function saveService() {
            const name = document.getElementById('service-name').value.trim();
            const icon = document.getElementById('service-icon').value.trim();
            const url = document.getElementById('service-url').value.trim();
            const description = document.getElementById('service-description').value.trim();
            const port = parseInt(document.getElementById('service-port').value) || null;
            const category = document.getElementById('service-category').value;
            const local = document.getElementById('service-local').checked;

            if (!name || !url || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const serviceData = {
                name,
                icon: icon || 'üîß',
                url,
                description,
                port,
                category,
                local,
                status: 'running'
            };

            if (currentServiceIndex !== null) {
                // Update existing service
                config.services[currentServiceIndex] = serviceData;
            } else {
                // Add new service
                if (!config.services) {
                    config.services = [];
                }
                config.services.push(serviceData);
            }

            closeServiceModal();
            renderServicesByCategory_Config();
            showToast('Service saved. Don\'t forget to save configuration!', 'info');
        }

        // UI/UX Enhancement Functions

        // Favorites system (localStorage)
        function getFavorites() {
            const favs = localStorage.getItem('favorites');
            return favs ? JSON.parse(favs) : [];
        }

        function toggleFavorite(serviceName, event) {
            event.preventDefault();
            event.stopPropagation();

            const favorites = getFavorites();
            const index = favorites.indexOf(serviceName);

            if (index === -1) {
                favorites.push(serviceName);
                playSound('favorite');
            } else {
                favorites.splice(index, 1);
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));
            renderServicesByCategory(window.currentCategory || config.categories[0]?.name);
        }

        function isFavorite(serviceName) {
            return getFavorites().includes(serviceName);
        }

        // Search and filter
        function filterServices() {
            const searchTerm = document.getElementById('search-box')?.value.toLowerCase() || '';
            const favoritesOnly = document.getElementById('favorites-only')?.checked || false;
            const grid = document.getElementById('services-grid');
            const cards = grid.querySelectorAll('.service-card');

            cards.forEach(card => {
                const serviceName = card.querySelector('.service-title')?.textContent.toLowerCase() || '';
                const serviceUrl = card.querySelector('.service-url')?.textContent.toLowerCase() || '';
                const serviceDesc = card.querySelector('.service-description')?.textContent.toLowerCase() || '';

                const matchesSearch = !searchTerm ||
                    serviceName.includes(searchTerm) ||
                    serviceUrl.includes(searchTerm) ||
                    serviceDesc.includes(searchTerm);

                const matchesFavorites = !favoritesOnly || card.querySelector('.favorited');

                card.style.display = (matchesSearch && matchesFavorites) ? '' : 'none';
            });
        }

        // Toast Notifications
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = {
                success: '‚úì',
                error: '‚úó',
                info: '‚Ñπ'
            }[type] || '‚Ñπ';

            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${icon}</span>
                <span style="flex: 1;">${message}</span>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 300); // Match animation duration
            }, duration);
        }

        // Settings panel
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('open');
            playSound('click');
        }

        // Sound effects
        let soundEnabled = localStorage.getItem('soundEnabled') === 'true';
        const sounds = {
            click: () => playTone(800, 0.1, 0.05),
            favorite: () => playTone(1200, 0.2, 0.1),
            success: () => playTone(1000, 0.3, 0.15),
            error: () => playTone(400, 0.3, 0.15)
        };

        function playTone(frequency, duration, volume) {
            if (!soundEnabled) return;
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                gainNode.gain.value = volume;

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Sound playback not supported');
            }
        }

        function playSound(soundName) {
            if (sounds[soundName]) sounds[soundName]();
        }

        function toggleSound() {
            soundEnabled = document.getElementById('sound-enabled').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            if (soundEnabled) playSound('click');
        }

        // Background particles
        function initParticles() {
            const container = document.getElementById('bg-particles');
            if (!container) return;

            container.innerHTML = '';
            const particlesEnabled = document.getElementById('particles-enabled')?.checked !== false;

            if (!particlesEnabled) return;

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = Math.random() * 4 + 2 + 'px';
                particle.style.height = particle.style.width;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDuration = (Math.random() * 10 + 15) + 's';
                particle.style.animationDelay = Math.random() * 5 + 's';
                container.appendChild(particle);
            }
        }

        function toggleParticles() {
            initParticles();
        }

        // Animations toggle
        function toggleAnimations() {
            const enabled = document.getElementById('animations-enabled').checked;
            document.documentElement.style.setProperty('--animation-enabled', enabled ? '1' : '0');
            if (!enabled) {
                document.querySelectorAll('.service-card').forEach(card => {
                    card.style.animation = 'none';
                });
            }
        }

        // Color themes - affects background gradient, buttons, and service icons
        // (Dark/Light mode controls card colors, text, shadows, borders)
        const colorThemes = {
            default: {
                'bg-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'button-bg': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'color-professional': '#667eea',
                'color-system': '#fc8181',
                'color-external': '#48bb78',
                'color-family': '#ed8936'
            },
            vibrant: {
                'bg-primary': 'linear-gradient(135deg, #e01e5a 0%, #ff6b9d 100%)',
                'button-bg': 'linear-gradient(135deg, #e01e5a 0%, #ff6b9d 100%)',
                'color-professional': '#e01e5a',
                'color-system': '#2eb67d',
                'color-external': '#ecb22e',
                'color-family': '#36c5f0'
            },
            pastel: {
                'bg-primary': 'linear-gradient(135deg, #b4a7d6 0%, #d4a5a5 100%)',
                'button-bg': 'linear-gradient(135deg, #b4a7d6 0%, #d4a5a5 100%)',
                'color-professional': '#b4a7d6',
                'color-system': '#f4a5a5',
                'color-external': '#a8e6cf',
                'color-family': '#ffd3b6'
            },
            monochrome: {
                'bg-primary': 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
                'button-bg': 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
                'color-professional': '#4a5568',
                'color-system': '#718096',
                'color-external': '#a0aec0',
                'color-family': '#cbd5e0'
            }
        };

        function applyColorTheme() {
            const theme = document.getElementById('color-theme')?.value || 'default';
            const colors = colorThemes[theme];

            console.log('Applying color theme:', theme);

            // Apply only theme-specific colors (not dark/light mode colors)
            Object.keys(colors).forEach(varName => {
                document.documentElement.style.setProperty(`--${varName}`, colors[varName]);
                console.log(`Set --${varName} to ${colors[varName]}`);
            });

            localStorage.setItem('colorTheme', theme);
            console.log('Theme saved to localStorage:', theme);
        }

        // Easter eggs (excluding System and Professional per user request)
        const easterEggs = {
            'konami': {
                code: ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'],
                message: 'üéÆ Konami Code Activated! You found the secret!',
                action: () => {
                    document.body.style.transform = 'rotate(360deg)';
                    document.body.style.transition = 'transform 2s';
                    setTimeout(() => {
                        document.body.style.transform = '';
                    }, 2000);
                }
            },
            'click10': {
                message: 'üéâ You clicked the logo 10 times! Here\'s a cookie: üç™',
                requireClicks: 10
            }
        };

        let konamiIndex = 0;
        let logoClicks = 0;

        document.addEventListener('keydown', (e) => {
            if (e.key === easterEggs.konami.code[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === easterEggs.konami.code.length) {
                    showEasterEgg(easterEggs.konami.message);
                    easterEggs.konami.action();
                    konamiIndex = 0;
                }
            } else {
                konamiIndex = 0;
            }
        });

        function setupEasterEggs() {
            const logo = document.querySelector('header h1');
            if (logo) {
                logo.style.cursor = 'pointer';
                logo.addEventListener('click', () => {
                    // Skip easter eggs for System and Professional categories
                    const currentCat = window.currentCategory?.toLowerCase();
                    if (currentCat === 'system' || currentCat === 'professional') return;

                    logoClicks++;
                    if (logoClicks >= easterEggs.click10.requireClicks) {
                        showEasterEgg(easterEggs.click10.message);
                        logoClicks = 0;
                    }
                });
            }
        }

        function showEasterEgg(message) {
            const container = document.getElementById('easter-egg');
            container.innerHTML = `<p>${message}</p><button onclick="hideEasterEgg()">Close</button>`;
            container.classList.add('show');
            playSound('success');
            setTimeout(hideEasterEgg, 5000);
        }

        function hideEasterEgg() {
            document.getElementById('easter-egg').classList.remove('show');
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize - check authentication first
            checkAuthStatus();

            // Initialize UI/UX features
            try {
                initParticles();
            } catch (e) {
                console.log('Particles initialization failed:', e);
            }

            try {
                setupEasterEggs();
            } catch (e) {
                console.log('Easter eggs setup failed:', e);
            }

            // Load saved preferences
            try {
                const savedTheme = localStorage.getItem('colorTheme');
                if (savedTheme) {
                    const themeSelect = document.getElementById('color-theme');
                    if (themeSelect) {
                        themeSelect.value = savedTheme;
                        applyColorTheme();
                    }
                }

                const savedSound = localStorage.getItem('soundEnabled') === 'true';
                if (savedSound && document.getElementById('sound-enabled')) {
                    document.getElementById('sound-enabled').checked = true;
                }

                // Initialize favourites tab visibility
                const showFavouritesTab = localStorage.getItem('showFavouritesTab') !== 'false'; // default to true
                const favouritesCheckbox = document.getElementById('show-favourites-tab');
                const favouritesTabBtn = document.querySelector('.settings-tab[onclick*="favourites"]');

                if (favouritesCheckbox) {
                    favouritesCheckbox.checked = showFavouritesTab;
                }
                if (favouritesTabBtn) {
                    favouritesTabBtn.style.display = showFavouritesTab ? 'inline-block' : 'none';
                }
            } catch (e) {
                console.log('Preference loading failed:', e);
            }

            // Auto-refresh
            const autoRefreshMinutes = 5;
            setTimeout(() => location.reload(), autoRefreshMinutes * 60 * 1000);
        });
    </script>
</body>
</html>
