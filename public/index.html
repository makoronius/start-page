<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Services Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üöÄ</text></svg>">
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #718096;
            --text-header: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            --border-color: #e2e8f0;
            --input-bg: #f7fafc;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-card: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-header: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
            --border-color: #4a5568;
            --input-bg: #1a202c;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 2rem;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-header);
            position: relative;
            padding-top: 3rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .theme-switcher {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 0.5rem;
            background: var(--bg-card);
            padding: 0.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            z-index: 10;
        }

        .theme-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .theme-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .theme-btn:hover {
            transform: translateY(-2px);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .category-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
        }

        .sub-tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .sub-tab-btn:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .sub-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: var(--input-bg);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .tab-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .services-grid[data-columns="1"] {
            grid-template-columns: 1fr;
        }

        .services-grid[data-columns="2"] {
            grid-template-columns: repeat(2, 1fr);
        }

        .services-grid[data-columns="3"] {
            grid-template-columns: repeat(3, 1fr);
        }

        .services-grid[data-columns="4"] {
            grid-template-columns: repeat(4, 1fr);
        }

        .service-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto auto;
            gap: 0.5rem 1rem;
            align-items: start;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .service-icon {
            grid-row: 1 / 3;
            width: 40px;
            height: 40px;
            background: var(--button-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .service-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            grid-column: 2;
        }

        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-status {
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .service-url {
            grid-column: 2;
            color: #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin-top: -0.25rem;
        }

        .service-description {
            grid-column: 1 / -1;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .status-running {
            background: #c6f6d5;
            color: #22543d;
        }

        .config-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .config-section h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .services-editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .service-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: move;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .service-editor:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .service-editor.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .service-editor.drag-over {
            border-color: #667eea;
            border-style: dashed;
            background: var(--input-bg);
        }

        .service-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
            margin-right: 0.5rem;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .service-editor h4 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
            grid-column: 1 / -1;
        }

        .service-editor-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .field-full-width {
            grid-column: 1 / -1;
        }

        .settings-editor {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .category-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .category-editor-content {
            flex: 1;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .category-drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
        }

        .category-drag-handle:active {
            cursor: grabbing;
        }

        .category-section {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .category-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .services-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            min-height: 100px;
        }

        .services-category-grid.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-group-inline label {
            margin-bottom: 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-header);
        }

        /* Login page styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: #fed7d7;
            color: #742a2a;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        [data-theme="dark"] .login-error {
            background: #742a2a;
            color: #fed7d7;
        }

        .user-info {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info span {
            color: var(--text-primary);
            font-weight: 500;
        }

        .logout-btn {
            padding: 0.4rem 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f56565;
            color: white;
            border-color: #f56565;
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Profile modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .modal-close {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Dialog modal styles */
        .dialog-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            animation: slideIn 0.3s ease;
        }

        .dialog-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .dialog-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .dialog-icon.warning {
            color: #f59e0b;
        }

        .dialog-icon.error {
            color: #ef4444;
        }

        .dialog-icon.info {
            color: #3b82f6;
        }

        .dialog-icon.success {
            color: #10b981;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .dialog-message {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .dialog-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .dialog-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .dialog-btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-btn-secondary:hover {
            background: var(--border-color);
        }

        .profile-info {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .profile-info p {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .profile-info strong {
            color: var(--text-primary);
        }

        .username-link {
            color: var(--text-primary);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 500;
        }

        .username-link:hover {
            color: #667eea;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .error {
            background: #742a2a;
            color: #fed7d7;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .success {
            background: #22543d;
            color: #c6f6d5;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            header {
                padding-top: 0;
                margin-bottom: 1rem;
            }

            header h1 {
                font-size: 1.75rem;
            }

            header p {
                font-size: 0.9rem;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .theme-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 1rem;
            }

            .theme-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="container hidden">
        <header>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="light" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
                <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô Dark</button>
                <button class="theme-btn" data-theme="system" onclick="setTheme('system')">üíª System</button>
            </div>
            <h1>üöÄ Local Services Dashboard</h1>
            <p>Your development environment at a glance</p>
        </header>

        <div class="login-container">
            <div class="login-box">
                <h2>Sign In</h2>
                <div id="login-error" class="login-error hidden"></div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    <p>Local access (localhost) bypasses authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="container hidden">
        <header>
            <div class="user-info" id="user-info">
                <a href="#" class="username-link" id="username-display" onclick="showProfile(event)"></a>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
            <div class="theme-switcher">
                <button class="theme-btn" data-theme="light" onclick="setTheme('light')">‚òÄÔ∏è Light</button>
                <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')">üåô Dark</button>
                <button class="theme-btn" data-theme="system" onclick="setTheme('system')">üíª System</button>
            </div>
            <h1 id="pageTitle">üöÄ Local Services Dashboard</h1>
            <p id="pageSubtitle">Your development environment at a glance</p>
        </header>

        <div class="tabs">
            <div id="category-tabs" class="category-tabs"></div>
            <button class="tab-btn" onclick="switchTab('config')">Config</button>
        </div>

        <div id="services-tab" class="tab-content active">
            <div id="loading" class="loading">
                <p>Loading services...</p>
            </div>
            <div id="services-grid" class="services-grid"></div>
        </div>

        <div id="config-tab" class="tab-content">
            <div class="config-section">
                <h2>‚öôÔ∏è Configuration</h2>
                <div id="config-message"></div>

                <!-- Config Sub-tabs -->
                <div class="sub-tabs">
                    <button class="sub-tab-btn active" onclick="switchConfigTab('general')">General Settings</button>
                    <button class="sub-tab-btn" onclick="switchConfigTab('services')">Services</button>
                </div>

                <!-- General Settings Sub-tab -->
                <div id="general-subtab" class="sub-tab-content active">
                    <div id="settings-editor"></div>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Categories</h3>
                    <div id="categories-editor"></div>
                    <button class="btn btn-primary" onclick="addCategory()" style="margin-top: 1rem;">+ Add New Category</button>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                        <button class="btn btn-secondary" onclick="generateCSV()">üìÑ Generate CSV to Server</button>
                    </div>
                </div>

                <!-- Services Sub-tab -->
                <div id="services-subtab" class="sub-tab-content">
                    <div id="services-by-category"></div>
                    <button class="btn btn-primary" onclick="addService()" style="margin-top: 1rem;">+ Add New Service</button>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">üíæ Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div> <!-- End of config-tab -->
    </div> <!-- End of main-dashboard -->

    <!-- Profile Modal -->
    <div id="profile-modal" class="modal-overlay hidden" onclick="closeProfileIfOutside(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeProfile()">&times;</button>
            <h2>User Profile</h2>

            <div class="profile-info">
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Email:</strong> <span id="profile-email"></span></p>
                <p><strong>Roles:</strong> <span id="profile-roles"></span></p>
            </div>

            <div id="password-change-section">
                <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Change Password</h3>
                <div id="password-message"></div>

                <div class="form-group">
                    <label for="current-password">Current Password</label>
                    <input type="password" id="current-password" required>
                </div>

                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" required>
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" required>
                </div>

                <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
            </div>
        </div>
    </div>

    <!-- Dialog Modal -->
    <div id="dialog-modal" class="modal-overlay hidden">
        <div class="dialog-modal">
            <div class="dialog-header">
                <span id="dialog-icon" class="dialog-icon"></span>
                <h3 id="dialog-title" class="dialog-title"></h3>
            </div>
            <div id="dialog-message" class="dialog-message"></div>
            <div class="dialog-actions" id="dialog-actions"></div>
        </div>
    </div>

    <script>
        let config = null;
        let currentUser = null;

        // Custom Dialog System
        function showDialog(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('dialog-modal');
                const icon = document.getElementById('dialog-icon');
                const title = document.getElementById('dialog-title');
                const message = document.getElementById('dialog-message');
                const actions = document.getElementById('dialog-actions');

                // Set icon
                icon.className = 'dialog-icon ' + (options.type || 'info');
                const iconMap = {
                    'warning': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'info': '‚ÑπÔ∏è',
                    'success': '‚úÖ'
                };
                icon.textContent = iconMap[options.type] || '‚ÑπÔ∏è';

                // Set content
                title.textContent = options.title || 'Notice';
                message.textContent = options.message || '';

                // Build actions
                actions.innerHTML = '';

                if (options.confirm) {
                    // Confirm dialog
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'dialog-btn dialog-btn-secondary';
                    cancelBtn.textContent = options.cancelText || 'Cancel';
                    cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };

                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'dialog-btn dialog-btn-primary';
                    confirmBtn.textContent = options.confirmText || 'OK';
                    confirmBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };

                    actions.appendChild(cancelBtn);
                    actions.appendChild(confirmBtn);
                } else {
                    // Alert dialog
                    const okBtn = document.createElement('button');
                    okBtn.className = 'dialog-btn dialog-btn-primary';
                    okBtn.textContent = 'OK';
                    okBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };
                    actions.appendChild(okBtn);
                }

                // Show modal
                modal.classList.remove('hidden');
            });
        }

        // Replace alert() and confirm()
        function customAlert(message, title = 'Notice', type = 'info') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: false
            });
        }

        function customConfirm(message, title = 'Confirm', type = 'warning') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: true,
                confirmText: 'Confirm',
                cancelText: 'Cancel'
            });
        }

        // Theme Management
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        function applyTheme(theme) {
            if (theme === 'system') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', systemTheme);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }

            // Update active button
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });
        }

        function setTheme(theme) {
            setCookie('theme', theme);
            applyTheme(theme);
        }

        // Initialize theme from cookie
        const savedTheme = getCookie('theme') || 'system';
        applyTheme(savedTheme);

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const currentTheme = getCookie('theme') || 'system';
            if (currentTheme === 'system') {
                applyTheme('system');
            }
        });

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.authenticated) {
                    currentUser = data.user;
                    showDashboard();
                    loadConfig();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');

            // Update user info display
            if (currentUser) {
                const displayName = currentUser.is_local ?
                    `${currentUser.username} (Local Access)` :
                    currentUser.username;
                document.getElementById('username-display').textContent = displayName;

                // Hide user info for local access
                if (currentUser.is_local) {
                    document.getElementById('user-info').style.display = 'none';
                }
            }
        }

        // Profile functions
        function showProfile(event) {
            if (event) event.preventDefault();

            // Load profile data
            fetch('/api/auth/profile', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-email').textContent = data.email || 'Not set';
                document.getElementById('profile-roles').textContent = data.roles.join(', ');

                // Hide password change for local users
                if (data.is_local) {
                    document.getElementById('password-change-section').style.display = 'none';
                } else {
                    document.getElementById('password-change-section').style.display = 'block';
                }

                document.getElementById('profile-modal').classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
        }

        function closeProfile() {
            document.getElementById('profile-modal').classList.add('hidden');
            // Clear password fields
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            document.getElementById('confirm-password').value = '';
            document.getElementById('password-message').innerHTML = '';
        }

        function closeProfileIfOutside(event) {
            if (event.target.id === 'profile-modal') {
                closeProfile();
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageDiv = document.getElementById('password-message');

            messageDiv.innerHTML = '';

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageDiv.innerHTML = '<div class="error">All fields are required</div>';
                return;
            }

            if (newPassword !== confirmPassword) {
                messageDiv.innerHTML = '<div class="error">New passwords do not match</div>';
                return;
            }

            if (newPassword.length < 6) {
                messageDiv.innerHTML = '<div class="error">New password must be at least 6 characters</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Password changed successfully!</div>';
                    // Clear fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    // Close modal after 2 seconds
                    setTimeout(() => {
                        closeProfile();
                    }, 2000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${data.error || 'Failed to change password'}</div>`;
                }
            } catch (error) {
                console.error('Error changing password:', error);
                messageDiv.innerHTML = '<div class="error">Connection error. Please try again.</div>';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    showDashboard();
                    loadConfig();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                currentUser = null;
                showLogin();

                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // State Management
        function saveState() {
            const state = {
                currentTab: getCurrentTab(),
                currentCategory: window.currentCategory || null,
                timestamp: Date.now()
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('dashboardState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    return state;
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return null;
        }

        function getCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                return activeTab.id.replace('-tab', '');
            }
            return 'services';
        }

        function restoreTab() {
            const state = loadState();
            if (state) {
                // Restore category if in services view
                if (state.currentCategory && state.currentTab === 'services') {
                    switchCategory(state.currentCategory);
                }

                // Restore main tab
                if (state.currentTab && state.currentTab !== 'services') {
                    const tabButtons = document.querySelectorAll('.tab-btn');
                    tabButtons.forEach((btn) => {
                        if (btn.textContent.toLowerCase().includes(state.currentTab.toLowerCase())) {
                            // Remove active from all
                            tabButtons.forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                            // Add active to target
                            btn.classList.add('active');
                            document.getElementById(`${state.currentTab}-tab`).classList.add('active');

                            // Render config if needed
                            if (state.currentTab === 'config' && config) {
                                renderSettingsEditor();
                                renderCategoriesEditor();
                                renderServicesByCategory_Config();
                            }
                        }
                    });
                }
            }
        }

        // Tab Management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'config' && config) {
                renderSettingsEditor();
                renderCategoriesEditor();
                renderServicesByCategory_Config();
            }

            // Save state
            saveState();
        }

        // Switch between config sub-tabs
        function switchConfigTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${subTabName}-subtab`).classList.add('active');
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config', {
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // Not authenticated, show login
                    showLogin();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load configuration');

                config = await response.json();

                // Update title and subtitle
                if (config.settings) {
                    document.getElementById('pageTitle').textContent = 'üöÄ ' + (config.settings.title || 'Local Services Dashboard');
                    document.getElementById('pageSubtitle').textContent = config.settings.subtitle || 'Your development environment at a glance';
                }

                // Render category tabs and services
                renderCategoryTabs();

                // Restore tab state after config is loaded
                setTimeout(() => restoreTab(), 100);
            } catch (error) {
                console.error('Error loading config:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #f56565;">Error loading services. Please refresh the page.</p>';
            }
        }

        // Get favicon URL
        function getFaviconUrl(serviceUrl) {
            try {
                const url = new URL(serviceUrl);
                return `${url.protocol}//${url.host}/favicon.ico`;
            } catch (e) {
                return null;
            }
        }

        // Render category tabs
        function renderCategoryTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                return;
            }

            config.categories.forEach((category, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.textContent = category.name;
                btn.onclick = () => switchCategory(category.name);

                if (index === 0 && !window.currentCategory) {
                    btn.classList.add('active');
                    window.currentCategory = category.name;
                }

                container.appendChild(btn);
            });

            // Render services for the first/current category
            renderServicesByCategory(window.currentCategory || config.categories[0].name);
        }

        // Switch category
        function switchCategory(categoryName) {
            // Update active category tab
            document.querySelectorAll('#category-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === categoryName) {
                    btn.classList.add('active');
                }
            });

            // Make sure services tab is active
            document.querySelectorAll('.tabs > .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('services-tab').classList.add('active');

            window.currentCategory = categoryName;
            renderServicesByCategory(categoryName);
            saveState();
        }

        // Render services by category
        function renderServicesByCategory(categoryName) {
            const grid = document.getElementById('services-grid');
            const loading = document.getElementById('loading');

            loading.style.display = 'none';
            grid.innerHTML = '';

            // Apply grid columns setting
            const gridColumns = config.settings?.grid_columns || 'auto';
            if (gridColumns === 'auto') {
                grid.removeAttribute('data-columns');
            } else {
                grid.setAttribute('data-columns', gridColumns);
            }

            if (!config.services || config.services.length === 0) {
                grid.innerHTML = '<p>No services configured. Go to Config tab to add services.</p>';
                return;
            }

            // Filter services by category
            const categoryServices = config.services.filter(s => s.category === categoryName);

            if (categoryServices.length === 0) {
                grid.innerHTML = `<p>No services in ${categoryName} category.</p>`;
                return;
            }

            categoryServices.forEach(service => {
                const card = document.createElement('a');
                card.href = service.url;
                card.className = 'service-card';
                card.target = '_blank';

                const faviconUrl = getFaviconUrl(service.url);
                const iconContent = service.icon || 'üîß';

                // Try to load favicon, fall back to emoji if it fails
                let iconHtml = iconContent;
                if (faviconUrl) {
                    iconHtml = `<img src="${faviconUrl}" alt="${service.name}" onerror="this.parentElement.innerHTML='${iconContent}'" />`;
                }

                card.innerHTML = `
                    <div class="service-icon">${iconHtml}</div>
                    <div class="service-header">
                        <div class="service-title">${service.name}</div>
                        <span class="service-status status-${service.status || 'running'}">${service.status || 'Running'}</span>
                    </div>
                    <div class="service-url">${service.url}</div>
                    <div class="service-description">${service.description || ''}</div>
                `;

                grid.appendChild(card);
            });
        }

        // Render settings editor
        function renderSettingsEditor() {
            const editor = document.getElementById('settings-editor');

            if (!config.settings) {
                config.settings = {};
            }

            const settings = config.settings;

            editor.innerHTML = `
                <div class="settings-editor">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Hostname</label>
                            <input type="text" value="${settings.hostname || ''}" onchange="updateSetting('hostname', this.value)">
                        </div>
                        <div class="form-group">
                            <label>SSH User</label>
                            <input type="text" value="${settings.ssh_user || ''}" onchange="updateSetting('ssh_user', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Title</label>
                            <input type="text" value="${settings.title || ''}" onchange="updateSetting('title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Subtitle</label>
                            <input type="text" value="${settings.subtitle || ''}" onchange="updateSetting('subtitle', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Auto-Refresh (minutes)</label>
                            <input type="number" value="${settings.auto_refresh_minutes || 5}" onchange="updateSetting('auto_refresh_minutes', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>CSV Path</label>
                            <input type="text" value="${settings.csv_path || '/scripts/port-mappings.csv'}" onchange="updateSetting('csv_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Backup Path</label>
                            <input type="text" value="${settings.backup_path || '/scripts/backups'}" onchange="updateSetting('backup_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>PowerShell Script Path</label>
                            <input type="text" value="${settings.powershell_script_path || '/scripts/Update-DockerPortProxy.ps1'}" onchange="updateSetting('powershell_script_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Grid Columns</label>
                            <select onchange="updateSetting('grid_columns', this.value)" value="${settings.grid_columns || 'auto'}">
                                <option value="auto" ${!settings.grid_columns || settings.grid_columns === 'auto' ? 'selected' : ''}>Auto (responsive)</option>
                                <option value="1" ${settings.grid_columns === '1' ? 'selected' : ''}>1 column</option>
                                <option value="2" ${settings.grid_columns === '2' ? 'selected' : ''}>2 columns</option>
                                <option value="3" ${settings.grid_columns === '3' ? 'selected' : ''}>3 columns</option>
                                <option value="4" ${settings.grid_columns === '4' ? 'selected' : ''}>4 columns</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update setting
        function updateSetting(key, value) {
            if (!config.settings) {
                config.settings = {};
            }
            config.settings[key] = value;
        }

        // Render categories editor
        function renderCategoriesEditor() {
            const editor = document.getElementById('categories-editor');
            editor.innerHTML = '';

            if (!config.categories) {
                config.categories = [];
            }

            config.categories.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-editor';
                categoryDiv.innerHTML = `
                    <div class="category-editor-content">
                        <span class="category-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>Name</label>
                            <input type="text" value="${category.name || ''}" onchange="updateCategory(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="flex: 2; margin: 0;">
                            <label>Description</label>
                            <input type="text" value="${category.description || ''}" onchange="updateCategory(${index}, 'description', this.value)">
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeCategory(${index})">üóë</button>
                `;
                editor.appendChild(categoryDiv);
            });
        }

        // Render services grouped by category in config
        function renderServicesByCategory_Config() {
            const container = document.getElementById('services-by-category');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                container.innerHTML = '<p>No categories defined. Please add categories in General Settings first.</p>';
                return;
            }

            if (!config.services) {
                config.services = [];
            }

            // Apply grid columns setting to config services view
            const gridColumns = config.settings?.grid_columns || 'auto';

            config.categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.dataset.category = category.name;

                // Add drop zone for services
                categorySection.addEventListener('dragover', handleServiceDragOver);
                categorySection.addEventListener('drop', handleServiceDrop);

                const categoryServices = config.services.filter(s => s.category === category.name);

                categorySection.innerHTML = `
                    <div class="category-section-header">
                        <h3 style="margin: 0;">${category.name}</h3>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">${categoryServices.length} service(s)</span>
                    </div>
                    <div class="services-category-grid ${categoryServices.length === 0 ? 'empty' : ''}" data-category="${category.name}" ${gridColumns !== 'auto' ? `style="grid-template-columns: repeat(${gridColumns}, 1fr);"` : ''}>
                        ${categoryServices.length === 0 ? 'Drop services here or add new service' : ''}
                    </div>
                `;

                const grid = categorySection.querySelector('.services-category-grid');

                categoryServices.forEach((service, localIndex) => {
                    const serviceIndex = config.services.findIndex(s => s === service);
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = 'service-editor';
                    serviceDiv.draggable = true;
                    serviceDiv.dataset.index = serviceIndex;
                    serviceDiv.dataset.category = category.name;

                    // Add drag event listeners
                    serviceDiv.addEventListener('dragstart', handleServiceDragStart);
                    serviceDiv.addEventListener('dragend', handleServiceDragEnd);

                    serviceDiv.innerHTML = `
                        <div class="service-editor-header">
                            <div style="display: flex; align-items: center;">
                                <span class="drag-handle" title="Drag to move">‚ãÆ‚ãÆ</span>
                                <h4 style="margin: 0;">${service.name || 'Service'}</h4>
                            </div>
                        </div>
                        <div class="service-editor-fields">
                            <div class="form-group">
                                <label>Name</label>
                                <input type="text" value="${service.name || ''}" onchange="updateService(${serviceIndex}, 'name', this.value)">
                            </div>
                            <div class="form-group">
                                <label>Icon (emoji)</label>
                                <input type="text" value="${service.icon || ''}" onchange="updateService(${serviceIndex}, 'icon', this.value)">
                            </div>
                            <div class="form-group field-full-width">
                                <label>URL</label>
                                <input type="text" value="${service.url || ''}" onchange="updateService(${serviceIndex}, 'url', this.value)">
                            </div>
                            <div class="form-group field-full-width">
                                <label>Description</label>
                                <textarea onchange="updateService(${serviceIndex}, 'description', this.value)">${service.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Port</label>
                                <input type="number" value="${service.port || ''}" onchange="updateService(${serviceIndex}, 'port', parseInt(this.value))">
                            </div>
                            <div class="form-group-inline">
                                <label>
                                    <input type="checkbox" ${service.local ? 'checked' : ''} onchange="updateService(${serviceIndex}, 'local', this.checked)">
                                    Local service
                                </label>
                            </div>
                            <div class="field-full-width">
                                <button class="btn btn-danger" onclick="removeService(${serviceIndex})" style="width: 100%; margin-top: 0.5rem;">üóë Delete</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(serviceDiv);
                });

                container.appendChild(categorySection);
            });
        }

        // Legacy function kept for compatibility - now calls the new function
        function renderConfigEditor() {
            renderServicesByCategory_Config();
        }

        // Category management
        function updateCategory(index, property, value) {
            config.categories[index][property] = value;
        }

        function addCategory() {
            if (!config.categories) {
                config.categories = [];
            }
            config.categories.push({
                name: 'New Category',
                description: 'Category description'
            });
            renderCategoriesEditor();
        }

        async function removeCategory(index) {
            const category = config.categories[index];
            const hasServices = config.services && config.services.some(s => s.category === category.name);

            if (hasServices) {
                await customAlert(
                    `Cannot delete category "${category.name}" because it contains services. Please move or delete the services first.`,
                    'Cannot Delete Category',
                    'error'
                );
                return;
            }

            const confirmed = await customConfirm(
                `Are you sure you want to delete category "${category.name}"?`,
                'Delete Category',
                'warning'
            );

            if (confirmed) {
                config.categories.splice(index, 1);
                renderCategoriesEditor();
            }
        }

        // Service drag and drop between categories
        let draggedServiceIndex = null;

        function handleServiceDragStart(e) {
            draggedServiceIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleServiceDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleServiceDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleServiceDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCategory = e.currentTarget.dataset.category;
            if (!targetCategory) return false;

            if (draggedServiceIndex !== null && config.services[draggedServiceIndex]) {
                // Update service category
                config.services[draggedServiceIndex].category = targetCategory;

                // Re-render services
                renderServicesByCategory_Config();
            }

            return false;
        }

        // Old render config editor - kept for backward compatibility
        function renderConfigEditor_OLD() {
            const editor = document.getElementById('services-editor');
            if (!editor) return;
            editor.innerHTML = '';

            if (!config.services) {
                config.services = [];
            }

            config.services.forEach((service, index) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'service-editor';
                serviceDiv.draggable = true;
                serviceDiv.dataset.index = index;

                // Add drag event listeners
                serviceDiv.addEventListener('dragstart', handleDragStart);
                serviceDiv.addEventListener('dragend', handleDragEnd);
                serviceDiv.addEventListener('dragover', handleDragOver);
                serviceDiv.addEventListener('drop', handleDrop);
                serviceDiv.addEventListener('dragleave', handleDragLeave);

                serviceDiv.innerHTML = `
                    <div class="service-editor-header">
                        <div style="display: flex; align-items: center;">
                            <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
                            <h4 style="margin: 0;">Service ${index + 1}</h4>
                        </div>
                    </div>
                    <div class="service-editor-fields">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" value="${service.name || ''}" onchange="updateService(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Icon (emoji)</label>
                            <input type="text" value="${service.icon || ''}" onchange="updateService(${index}, 'icon', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>URL</label>
                            <input type="text" value="${service.url || ''}" onchange="updateService(${index}, 'url', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>Description</label>
                            <textarea onchange="updateService(${index}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" value="${service.port || ''}" onchange="updateService(${index}, 'port', parseInt(this.value))">
                        </div>
                        <div class="form-group-inline">
                            <label>
                                <input type="checkbox" ${service.local ? 'checked' : ''} onchange="updateService(${index}, 'local', this.checked)">
                                Local service
                            </label>
                        </div>
                        <div class="field-full-width">
                            <button class="btn btn-danger" onclick="removeService(${index})" style="width: 100%; margin-top: 0.5rem;">üóë Delete</button>
                        </div>
                    </div>
                `;
                editor.appendChild(serviceDiv);
            });
        }

        // Update service property
        function updateService(index, property, value) {
            config.services[index][property] = value;
        }

        // Add new service
        function addService() {
            if (!config.services) {
                config.services = [];
            }

            // Default to first category if available
            const defaultCategory = config.categories && config.categories.length > 0
                ? config.categories[0].name
                : 'Uncategorized';

            config.services.push({
                name: 'New Service',
                icon: 'üîß',
                url: 'http://localhost:8080',
                description: 'Service description',
                port: 8080,
                local: true,
                status: 'running',
                category: defaultCategory
            });

            renderServicesByCategory_Config();
        }

        // Remove service
        async function removeService(index) {
            const confirmed = await customConfirm(
                'Are you sure you want to delete this service?',
                'Delete Service',
                'warning'
            );

            if (confirmed) {
                config.services.splice(index, 1);
                renderServicesByCategory_Config();
            }
        }

        // Drag and Drop handlers
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.service-editor').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const dropIndex = parseInt(e.currentTarget.dataset.index);

            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                // Reorder the services array
                const draggedService = config.services[draggedIndex];
                config.services.splice(draggedIndex, 1);
                config.services.splice(dropIndex, 0, draggedService);

                // Re-render the config editor
                renderConfigEditor();
            }

            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        // Save configuration
        async function saveConfig() {
            const messageDiv = document.getElementById('config-message');

            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to save configuration');
                }

                messageDiv.innerHTML = '<div class="success">‚úì Configuration saved successfully!</div>';

                // Re-render config editors with current config
                renderSettingsEditor();
                renderCategoriesEditor();
                renderServicesByCategory_Config();

                // Also update the main view's category tabs without switching tabs
                renderCategoryTabs();

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            } catch (error) {
                console.error('Error saving config:', error);
                messageDiv.innerHTML = '<div class="error">Failed to save configuration. Please try again.</div>';
            }
        }

        // Generate CSV to server
        async function generateCSV() {
            const messageDiv = document.getElementById('config-message');

            try {
                const response = await fetch('/api/csv/generate', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to generate CSV');

                const result = await response.json();

                if (result.success) {
                    let message = `‚úì CSV generated successfully at ${result.csv_path}`;
                    if (result.backup_created) {
                        message += '<br>‚úì Backup created';
                    }
                    messageDiv.innerHTML = `<div class="success">${message}</div>`;
                } else {
                    throw new Error(result.error || 'Unknown error');
                }

                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
            } catch (error) {
                console.error('Error generating CSV:', error);
                messageDiv.innerHTML = `<div class="error">Failed to generate CSV: ${error.message}</div>`;
            }
        }

        // Initialize - check authentication first
        checkAuthStatus();

        // Auto-refresh
        const autoRefreshMinutes = 5;
        setTimeout(() => location.reload(), autoRefreshMinutes * 60 * 1000);
    </script>
</body>
</html>
