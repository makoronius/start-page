<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 2025-10-17-color-themes-debug -->
    <title>Local Services Dashboard</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🚀</text></svg>">
    <style>
        :root {
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-card: #ffffff;
            --text-primary: #333333;
            --text-secondary: #718096;
            --text-header: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(0, 0, 0, 0.15);
            --border-color: #e2e8f0;
            --input-bg: #f7fafc;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --bg-card: #2d3748;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-header: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.5);
            --border-color: #4a5568;
            --input-bg: #1a202c;
            --button-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --button-text: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            padding: 2rem;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-header);
            position: relative;
            padding-top: 0.5rem;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px var(--shadow);
        }

        header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .theme-switcher {
            position: absolute;
            top: 0.5rem;
            right: 0;
            display: none; /* Hidden - theme buttons moved to Customization tab */
            gap: 0.3rem;
            z-index: 10;
        }

        .theme-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-header);
            transition: all 0.2s;
            backdrop-filter: blur(10px);
        }

        .theme-btn.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.4);
            font-weight: 600;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .category-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sub-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0;
        }

        .sub-tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            margin-bottom: -2px;
        }

        .sub-tab-btn:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .sub-tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: var(--input-bg);
        }

        .sub-tab-content {
            display: none;
        }

        .sub-tab-content.active {
            display: block;
        }

        .tab-btn {
            padding: 0.75rem 2rem;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
        }

        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .tab-btn.active {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .services-grid[data-columns="1"] {
            grid-template-columns: 1fr;
        }

        .services-grid[data-columns="2"] {
            grid-template-columns: repeat(2, 1fr);
        }

        .services-grid[data-columns="3"] {
            grid-template-columns: repeat(3, 1fr);
        }

        .services-grid[data-columns="4"] {
            grid-template-columns: repeat(4, 1fr);
        }

        .service-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 2px 4px var(--shadow);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
            color: inherit;
            display: grid;
            grid-template-columns: auto 1fr;
            grid-template-rows: auto auto auto;
            gap: 0.5rem 1rem;
            align-items: start;
        }

        .service-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .service-icon {
            grid-row: 1 / 3;
            width: 40px;
            height: 40px;
            background: var(--button-bg);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .service-icon img {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .service-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            grid-column: 2;
        }

        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .service-status {
            padding: 0.2rem 0.5rem;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .service-url {
            grid-column: 2;
            color: #667eea;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            word-break: break-all;
            margin-top: -0.25rem;
        }

        .service-description {
            grid-column: 1 / -1;
            color: var(--text-secondary);
            font-size: 0.85rem;
            line-height: 1.4;
            margin-top: 0.25rem;
        }

        .status-running {
            background: #c6f6d5;
            color: #22543d;
        }

        .config-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .config-section h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .services-editor-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .service-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: move;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .service-editor:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .service-list-item {
            padding: 0.75rem 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .service-list-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .service-list-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .service-list-info {
            flex: 1;
            min-width: 0;
        }

        .service-list-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .service-list-url {
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .service-list-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .service-list-actions button {
            padding: 0.4rem 0.75rem;
            font-size: 0.9rem;
        }

        .service-editor.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .service-editor.drag-over {
            border-color: #667eea;
            border-style: dashed;
            background: var(--input-bg);
        }

        .service-editor-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
            margin-right: 0.5rem;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .service-editor h4 {
            margin-bottom: 0.75rem;
            font-size: 1rem;
            color: var(--text-primary);
            grid-column: 1 / -1;
        }

        .service-editor-fields {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .field-full-width {
            grid-column: 1 / -1;
        }

        .settings-editor {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .category-editor {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .category-editor-content {
            flex: 1;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .category-drag-handle {
            font-size: 1.5rem;
            cursor: grab;
            user-select: none;
        }

        .category-drag-handle:active {
            cursor: grabbing;
        }

        .category-section {
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .category-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .services-category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
            min-height: 100px;
        }

        .services-category-grid.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .user-card {
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .user-roles {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            background: var(--button-bg);
            color: var(--button-text);
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .role-editor-card {
            padding: 1.5rem;
            background: var(--input-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .role-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .role-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-primary);
        }

        .role-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .role-categories {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 0.75rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.3rem;
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 0.5rem;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-group-inline {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .form-group-inline label {
            margin-bottom: 0;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-right: 0.5rem;
        }

        .btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-danger {
            background: var(--danger-bg, #f56565);
            color: var(--danger-text, white);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-hover);
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-header);
        }

        /* Login page styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2.5rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 400px;
        }

        .login-box h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-primary);
        }

        .login-form .form-group {
            margin-bottom: 1.5rem;
        }

        .login-form label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .login-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .login-form input:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--button-bg);
            color: var(--button-text);
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .login-error {
            background: #fed7d7;
            color: #742a2a;
            padding: 0.75rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            text-align: center;
        }

        [data-theme="dark"] .login-error {
            background: #742a2a;
            color: #fed7d7;
        }

        .header-user-info {
            position: absolute;
            top: 0;
            left: 0;
            background: var(--bg-card);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .header-user-info span {
            color: var(--text-primary);
            font-weight: 500;
        }

        .logout-btn {
            padding: 0.4rem 1rem;
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #f56565;
            color: white;
            border-color: #f56565;
        }

        .hidden {
            display: none !important;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Profile modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 16px var(--shadow-hover);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .modal-close {
            float: right;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Dialog modal styles - higher z-index to appear above other modals */
        #dialog-modal {
            z-index: 2000;
        }

        .dialog-modal {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 450px;
            animation: slideIn 0.3s ease;
        }

        .dialog-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            gap: 0.75rem;
        }

        .dialog-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .dialog-icon.warning {
            color: #f59e0b;
        }

        .dialog-icon.error {
            color: #ef4444;
        }

        .dialog-icon.info {
            color: #3b82f6;
        }

        .dialog-icon.success {
            color: #10b981;
        }

        .dialog-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .dialog-message {
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .dialog-actions {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dialog-btn-primary {
            background: var(--button-bg);
            color: var(--button-text);
        }

        .dialog-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .dialog-btn-secondary {
            background: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .dialog-btn-secondary:hover {
            background: var(--border-color);
        }

        /* Folder browser styles */
        .folder-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-item:hover {
            background: var(--border-color);
            transform: translateX(4px);
        }

        .folder-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .folder-item.disabled:hover {
            transform: none;
        }

        .folder-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .folder-name {
            flex: 1;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            word-break: break-all;
        }

        .profile-info {
            margin-bottom: 2rem;
            padding: 1rem;
            background: var(--input-bg);
            border-radius: 8px;
        }

        .profile-info p {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        .profile-info strong {
            color: var(--text-primary);
        }

        .username-link {
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            font-weight: 500;
        }

        .username-link:hover {
            color: #667eea;
        }

        .error {
            background: #fed7d7;
            color: #742a2a;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .error {
            background: #742a2a;
            color: #fed7d7;
        }

        .success {
            background: #c6f6d5;
            color: #22543d;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        [data-theme="dark"] .success {
            background: #22543d;
            color: #c6f6d5;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            header {
                padding-top: 0;
                margin-bottom: 1rem;
            }

            header h1 {
                font-size: 1.75rem;
            }

            header p {
                font-size: 0.9rem;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .theme-switcher {
                position: static;
                justify-content: center;
                margin-bottom: 1rem;
            }

            .theme-btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.8rem;
            }
        }

        /* Search and Filter Styles */
        .search-container {
            max-width: 600px;
            margin: 0 auto 2rem;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            opacity: 0.5;
        }

        /* Favorite Star */
        .favorite-star {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }

        .favorite-star:hover {
            transform: scale(1.2);
        }

        .favorite-star.favorited {
            filter: drop-shadow(0 0 3px gold);
        }

        /* Animation Classes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .service-card {
            animation: fadeIn 0.3s ease-out;
            animation-fill-mode: backwards;
        }

        .service-card:nth-child(1) { animation-delay: 0.05s; }
        .service-card:nth-child(2) { animation-delay: 0.1s; }
        .service-card:nth-child(3) { animation-delay: 0.15s; }
        .service-card:nth-child(4) { animation-delay: 0.2s; }
        .service-card:nth-child(5) { animation-delay: 0.25s; }
        .service-card:nth-child(6) { animation-delay: 0.3s; }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: var(--bg-card);
            box-shadow: -2px 0 10px var(--shadow);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem;
        }

        .settings-panel.open {
            right: 0;
        }

        /* Settings Tabs */
        .settings-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }

        .settings-tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .settings-tab:hover {
            color: var(--text-primary);
            background: var(--input-bg);
        }

        .settings-tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--button-bg);
            font-weight: 600;
        }

        .settings-tab-content {
            display: none;
        }

        .settings-tab-content.active {
            display: block;
        }

        /* Easter Egg Container */
        .easter-egg {
            position: fixed;
            bottom: 100px;
            right: 2rem;
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .easter-egg.show {
            display: block;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            pointer-events: none;
        }

        .toast {
            background: var(--card-bg);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
            pointer-events: auto;
        }

        .toast.success {
            border-left: 4px solid #48bb78;
        }

        .toast.error {
            border-left: 4px solid #fc8181;
        }

        .toast.info {
            border-left: 4px solid #667eea;
        }

        .toast.hiding {
            animation: slideOutRight 0.3s ease forwards;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* Category Color Variants */
        .category-professional .service-icon {
            background: linear-gradient(135deg, var(--color-professional, #667eea) 0%, color-mix(in srgb, var(--color-professional, #667eea) 70%, black) 100%) !important;
        }
        .category-system .service-icon {
            background: linear-gradient(135deg, var(--color-system, #fc8181) 0%, color-mix(in srgb, var(--color-system, #fc8181) 70%, black) 100%) !important;
        }
        .category-external .service-icon {
            background: linear-gradient(135deg, var(--color-external, #48bb78) 0%, color-mix(in srgb, var(--color-external, #48bb78) 70%, black) 100%) !important;
        }
        .category-family .service-icon {
            background: linear-gradient(135deg, var(--color-family, #ed8936) 0%, color-mix(in srgb, var(--color-family, #ed8936) 70%, black) 100%) !important;
        }
        .category-default .service-icon {
            background: linear-gradient(135deg, var(--color-professional, #667eea) 0%, color-mix(in srgb, var(--color-professional, #667eea) 70%, black) 100%) !important;
        }

        /* Dynamic Background Particles */
        .bg-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
            opacity: 0.40;
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: float 20s infinite;
        }

        /* Time of Day - Dramatic color and intensity distinction */

        /* Morning: Warm golden sunrise */
        .particle.morning {
            background: radial-gradient(circle, rgba(255,230,50,1), rgba(255,180,0,0.9), rgba(255,200,80,0.5));
            box-shadow: 0 0 20px rgba(255,200,0,0.9), 0 0 40px rgba(255,160,0,0.6);
            filter: brightness(1.4) saturate(1.3);
        }

        /* Afternoon: Bright clear white-blue */
        .particle.afternoon {
            background: radial-gradient(circle, rgba(255,255,255,0.95), rgba(180,220,255,0.8), rgba(200,230,255,0.6));
            box-shadow: 0 0 15px rgba(200,230,255,0.7), 0 0 30px rgba(150,200,255,0.4);
            filter: brightness(1.2) saturate(0.9);
        }

        /* Evening: Deep orange-to-purple sunset */
        .particle.evening {
            background: radial-gradient(circle, rgba(255,100,50,1), rgba(255,50,120,0.9), rgba(180,80,200,0.7));
            box-shadow: 0 0 25px rgba(255,100,50,0.8), 0 0 45px rgba(255,50,120,0.6);
            filter: brightness(1.3) saturate(1.5);
        }

        /* Night: Deep blue-purple stars */
        .particle.night {
            background: radial-gradient(circle, rgba(150,180,255,1), rgba(100,120,255,0.9), rgba(80,100,200,0.6));
            box-shadow: 0 0 30px rgba(120,150,255,1), 0 0 50px rgba(80,120,255,0.7), 0 0 70px rgba(60,100,200,0.4);
            filter: brightness(1.6) saturate(1.4);
        }

        /* Seasons - Redesigned for clear recognition */

        /* Winter - Snowflakes: Sharp 6-pointed crystalline snowflake */
        .particle.winter {
            background: radial-gradient(circle, rgba(255,255,255,1), rgba(240,248,255,0.95), rgba(220,235,255,0.85));
            animation: winter-fall 15s infinite;
            border-radius: 0;
            /* 6-pointed snowflake with sharp tips */
            clip-path: polygon(
                50% 0%, 55% 25%, 75% 15%, 60% 40%, 85% 50%, 60% 60%,
                75% 85%, 55% 75%, 50% 100%, 45% 75%, 25% 85%, 40% 60%,
                15% 50%, 40% 40%, 25% 15%, 45% 25%
            );
            box-shadow:
                0 0 12px rgba(255,255,255,1),
                0 0 20px rgba(230,240,255,0.8),
                0 0 30px rgba(200,220,255,0.5);
            filter: brightness(1.2);
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* Winter snowflake color variations by time of day */

        /* Morning - Warm golden-white snowflakes (sunrise on snow) */
        .particle.winter.morning {
            background: radial-gradient(circle, rgba(255,250,235,1), rgba(255,245,220,0.95), rgba(245,235,210,0.85));
            box-shadow:
                0 0 12px rgba(255,240,200,1),
                0 0 20px rgba(255,235,180,0.8),
                0 0 30px rgba(240,220,160,0.5);
            border: 1px solid rgba(255,240,200,0.6);
        }

        /* Afternoon - Pure white snowflakes (natural daylight, use base colors) */

        /* Evening - Pink/orange tinted snowflakes (sunset on snow) */
        .particle.winter.evening {
            background: radial-gradient(circle, rgba(255,245,250,1), rgba(255,235,245,0.95), rgba(245,225,235,0.85));
            box-shadow:
                0 0 12px rgba(255,220,240,1),
                0 0 20px rgba(255,200,230,0.8),
                0 0 30px rgba(240,180,220,0.5);
            border: 1px solid rgba(255,220,240,0.6);
        }

        /* Night - Blue/silver snowflakes (moonlight on snow) */
        .particle.winter.night {
            background: radial-gradient(circle, rgba(240,245,255,1), rgba(230,240,255,0.95), rgba(215,230,250,0.85));
            box-shadow:
                0 0 12px rgba(220,235,255,1),
                0 0 20px rgba(200,225,255,0.8),
                0 0 30px rgba(180,215,250,0.5);
            border: 1px solid rgba(220,235,255,0.6);
        }

        /* Spring - Water Droplets: Clear sparkly water drops */
        .particle.spring {
            background: radial-gradient(circle, rgba(180,230,255,0.95), rgba(220,245,255,0.8), rgba(200,240,255,0.6));
            animation: spring-float 12s infinite;
            border-radius: 50% 50% 50% 0%;
            transform: rotate(45deg);
            box-shadow:
                0 0 10px rgba(180,230,255,0.8),
                0 0 18px rgba(150,210,255,0.5),
                inset -3px -3px 8px rgba(255,255,255,0.6),
                inset 3px 3px 6px rgba(100,180,230,0.3);
            filter: brightness(1.3);
            border: 1px solid rgba(200,240,255,0.7);
        }

        .particle.spring::before {
            content: '';
            position: absolute;
            width: 40%;
            height: 40%;
            top: 15%;
            left: 15%;
            background: radial-gradient(circle, rgba(255,255,255,0.9), transparent 60%);
            border-radius: 50%;
            transform: rotate(-45deg);
        }

        /* Spring water droplet color variations by time of day */

        /* Morning - Golden sparkles (sunrise dew) */
        .particle.spring.morning {
            background: radial-gradient(circle, rgba(255,240,200,0.95), rgba(255,245,210,0.8), rgba(245,235,195,0.6));
            box-shadow:
                0 0 10px rgba(255,235,180,0.8),
                0 0 18px rgba(245,225,160,0.5),
                inset -3px -3px 8px rgba(255,255,255,0.6),
                inset 3px 3px 6px rgba(230,210,150,0.3);
            border: 1px solid rgba(255,240,200,0.7);
        }

        .particle.spring.morning::before {
            background: radial-gradient(circle, rgba(255,250,220,0.9), transparent 60%);
        }

        /* Afternoon - Clear blue water drops (natural daylight, use base colors) */

        /* Evening - Pink/purple sparkles (sunset dew) */
        .particle.spring.evening {
            background: radial-gradient(circle, rgba(255,200,230,0.95), rgba(255,220,245,0.8), rgba(240,210,235,0.6));
            box-shadow:
                0 0 10px rgba(255,180,220,0.8),
                0 0 18px rgba(240,160,210,0.5),
                inset -3px -3px 8px rgba(255,255,255,0.6),
                inset 3px 3px 6px rgba(220,150,200,0.3);
            border: 1px solid rgba(255,200,230,0.7);
        }

        .particle.spring.evening::before {
            background: radial-gradient(circle, rgba(255,230,250,0.9), transparent 60%);
        }

        /* Night - Silver/dark blue drops (moonlit dew) */
        .particle.spring.night {
            background: radial-gradient(circle, rgba(200,220,255,0.95), rgba(220,235,255,0.8), rgba(205,225,245,0.6));
            box-shadow:
                0 0 10px rgba(190,215,255,0.8),
                0 0 18px rgba(170,200,245,0.5),
                inset -3px -3px 8px rgba(255,255,255,0.6),
                inset 3px 3px 6px rgba(160,190,230,0.3);
            border: 1px solid rgba(200,220,255,0.7);
        }

        .particle.spring.night::before {
            background: radial-gradient(circle, rgba(230,240,255,0.9), transparent 60%);
        }

        /* Summer - Sun Rays: Bright radiating sun light beams */
        .particle.summer {
            background: radial-gradient(circle, rgba(255,250,150,1), rgba(255,230,100,0.95), rgba(255,200,50,0.8));
            animation: summer-glow 3s infinite, summer-wave 10s infinite;
            border-radius: 50%;
            box-shadow:
                0 0 25px rgba(255,240,100,1),
                0 0 45px rgba(255,220,80,0.8),
                0 0 65px rgba(255,200,50,0.6);
            filter: brightness(1.5) saturate(1.3);
        }

        .particle.summer::before {
            content: '';
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            background:
                linear-gradient(0deg, transparent 48%, rgba(255,240,100,0.6) 49%, rgba(255,240,100,0.6) 51%, transparent 52%),
                linear-gradient(45deg, transparent 48%, rgba(255,240,100,0.5) 49%, rgba(255,240,100,0.5) 51%, transparent 52%),
                linear-gradient(90deg, transparent 48%, rgba(255,240,100,0.6) 49%, rgba(255,240,100,0.6) 51%, transparent 52%),
                linear-gradient(135deg, transparent 48%, rgba(255,240,100,0.5) 49%, rgba(255,240,100,0.5) 51%, transparent 52%);
            border-radius: 50%;
            opacity: 0.7;
        }

        /* Summer Night - Moon: Crescent moon instead of sun */
        .particle.summer.moon {
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,1), rgba(240,245,255,0.95), rgba(230,240,255,0.9));
            animation: float 20s infinite;
            border-radius: 50%;
            box-shadow:
                0 0 20px rgba(230,240,255,0.9),
                0 0 35px rgba(200,220,255,0.7),
                0 0 50px rgba(180,210,255,0.5);
            filter: brightness(1.3);
            position: relative;
        }

        .particle.summer.moon::before {
            content: '';
            position: absolute;
            width: 80%;
            height: 80%;
            top: 5%;
            left: 15%;
            background: radial-gradient(circle, rgba(150,180,255,0.95), rgba(120,160,255,0.8));
            border-radius: 50%;
            box-shadow: inset 3px 3px 8px rgba(100,140,220,0.6);
        }

        /* Autumn - Falling Leaves: Classic maple leaf shape with defined edges */
        .particle.autumn {
            background: linear-gradient(135deg,
                rgba(210,90,0,1) 0%,
                rgba(180,60,0,0.95) 30%,
                rgba(160,50,10,0.9) 60%,
                rgba(140,40,0,0.85) 100%);
            animation: autumn-fall 14s infinite;
            /* Maple leaf shape */
            clip-path: polygon(
                50% 0%, 55% 20%, 70% 15%, 60% 35%, 80% 40%,
                65% 50%, 85% 70%, 60% 65%, 50% 85%, 40% 65%,
                15% 70%, 35% 50%, 20% 40%, 40% 35%, 30% 15%, 45% 20%
            );
            box-shadow:
                0 0 10px rgba(210,90,0,0.7),
                0 0 18px rgba(180,60,0,0.5),
                inset -3px -3px 6px rgba(140,40,0,0.6);
            filter: brightness(1.1) saturate(1.4);
            border: 1px solid rgba(180,60,0,0.7);
        }

        .particle.autumn::before {
            content: '';
            position: absolute;
            width: 50%;
            height: 70%;
            left: 25%;
            top: 15%;
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(220,120,40,0.4) 30%,
                rgba(220,120,40,0.3) 70%,
                transparent 100%);
            clip-path: polygon(50% 0%, 52% 100%, 48% 100%);
        }

        /* Autumn leaf color variations by time of day */

        /* Morning - Golden orange leaves (warm sunrise glow) */
        .particle.autumn.morning {
            background: linear-gradient(135deg,
                rgba(240,150,30,1) 0%,
                rgba(220,130,20,0.95) 30%,
                rgba(200,110,10,0.9) 60%,
                rgba(180,90,0,0.85) 100%);
            box-shadow:
                0 0 10px rgba(240,150,30,0.7),
                0 0 18px rgba(220,130,20,0.5),
                inset -3px -3px 6px rgba(180,90,0,0.6);
            border: 1px solid rgba(220,130,20,0.7);
        }

        .particle.autumn.morning::before {
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(255,180,60,0.4) 30%,
                rgba(255,180,60,0.3) 70%,
                transparent 100%);
        }

        /* Afternoon - Natural autumn colors (use base colors, no override needed) */

        /* Evening - Deep red/burgundy leaves (sunset influence) */
        .particle.autumn.evening {
            background: linear-gradient(135deg,
                rgba(180,40,40,1) 0%,
                rgba(150,30,30,0.95) 30%,
                rgba(120,25,25,0.9) 60%,
                rgba(100,20,20,0.85) 100%);
            box-shadow:
                0 0 10px rgba(180,40,40,0.7),
                0 0 18px rgba(150,30,30,0.5),
                inset -3px -3px 6px rgba(100,20,20,0.6);
            border: 1px solid rgba(150,30,30,0.7);
        }

        .particle.autumn.evening::before {
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(200,60,60,0.4) 30%,
                rgba(200,60,60,0.3) 70%,
                transparent 100%);
        }

        /* Night - Dark brown/deep red leaves (muted nighttime colors) */
        .particle.autumn.night {
            background: linear-gradient(135deg,
                rgba(120,50,30,1) 0%,
                rgba(100,40,25,0.95) 30%,
                rgba(80,30,20,0.9) 60%,
                rgba(60,25,15,0.85) 100%);
            box-shadow:
                0 0 10px rgba(120,50,30,0.7),
                0 0 18px rgba(100,40,25,0.5),
                inset -3px -3px 6px rgba(60,25,15,0.6);
            border: 1px solid rgba(100,40,25,0.7);
        }

        .particle.autumn.night::before {
            background: linear-gradient(180deg,
                transparent 0%,
                rgba(140,70,40,0.4) 30%,
                rgba(140,70,40,0.3) 70%,
                transparent 100%);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg); }
            25% { transform: translateY(-30px) translateX(20px) rotate(90deg); }
            50% { transform: translateY(-60px) translateX(-20px) rotate(180deg); }
            75% { transform: translateY(-30px) translateX(10px) rotate(270deg); }
        }

        @keyframes winter-fall {
            0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
        }

        @keyframes spring-float {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-40px) translateX(25px) rotate(90deg) scale(1.1); }
            50% { transform: translateY(-80px) translateX(-25px) rotate(180deg) scale(0.9); }
            75% { transform: translateY(-40px) translateX(15px) rotate(270deg) scale(1.05); }
        }

        @keyframes summer-wave {
            0%, 100% { transform: translateY(0) translateX(0) rotate(0deg) scale(1); }
            25% { transform: translateY(-50px) translateX(30px) rotate(45deg) scale(1.1); }
            50% { transform: translateY(-30px) translateX(-30px) rotate(90deg) scale(0.95); }
            75% { transform: translateY(-70px) translateX(20px) rotate(135deg) scale(1.05); }
        }

        @keyframes summer-glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255,220,0,0.8), 0 0 35px rgba(255,180,0,0.6), 0 0 50px rgba(255,150,0,0.4);
                opacity: 0.9;
            }
            50% {
                box-shadow: 0 0 30px rgba(255,240,0,1), 0 0 50px rgba(255,200,0,0.8), 0 0 70px rgba(255,180,0,0.6);
                opacity: 1;
            }
        }

        @keyframes autumn-fall {
            0% { transform: translateY(-20px) translateX(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(100vh) translateX(80px) rotate(360deg); opacity: 0.6; }
        }

        /* Cockroach easter egg particles */
        .cockroach {
            position: fixed;
            width: 20px;
            height: 12px;
            pointer-events: none;
            z-index: 9999;
            will-change: transform;
        }

        .cockroach-body {
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center,
                rgba(60,40,30,1) 0%,
                rgba(40,25,20,0.95) 40%,
                rgba(20,15,10,0.9) 100%);
            border-radius: 50% 50% 40% 40%;
            border: 1px solid rgba(30,20,15,0.8);
            box-shadow:
                inset 1px 1px 2px rgba(80,60,50,0.3),
                0 1px 3px rgba(0,0,0,0.6);
        }

        .cockroach-head {
            position: absolute;
            width: 40%;
            height: 35%;
            top: -20%;
            left: 30%;
            background: radial-gradient(circle, rgba(50,35,25,1), rgba(30,20,15,1));
            border-radius: 50%;
            border: 1px solid rgba(25,15,10,0.8);
        }

        .cockroach-antenna {
            position: absolute;
            width: 1px;
            height: 8px;
            background: rgba(40,30,25,0.9);
            top: -25%;
            transform-origin: bottom;
        }

        .cockroach-antenna.left {
            left: 35%;
            transform: rotate(-25deg);
        }

        .cockroach-antenna.right {
            right: 35%;
            transform: rotate(25deg);
        }

        .cockroach-legs {
            position: absolute;
            width: 140%;
            height: 140%;
            top: -20%;
            left: -20%;
        }

        .cockroach-leg {
            position: absolute;
            width: 1px;
            height: 10px;
            background: rgba(35,25,20,0.85);
            transform-origin: top;
        }

        .cockroach-leg.left-1 { left: 15%; top: 20%; transform: rotate(-60deg); }
        .cockroach-leg.left-2 { left: 20%; top: 45%; transform: rotate(-50deg); }
        .cockroach-leg.left-3 { left: 25%; top: 70%; transform: rotate(-40deg); }
        .cockroach-leg.right-1 { right: 15%; top: 20%; transform: rotate(60deg); }
        .cockroach-leg.right-2 { right: 20%; top: 45%; transform: rotate(50deg); }
        .cockroach-leg.right-3 { right: 25%; top: 70%; transform: rotate(40deg); }

        @keyframes cockroach-scuttle-left {
            0% {
                transform: translateX(120vw) translateY(0) rotate(-15deg) scale(1);
                opacity: 1;
            }
            2% {
                transform: translateX(115vw) translateY(-2px) rotate(-18deg) scale(1.05);
            }
            4% {
                transform: translateX(110vw) translateY(2px) rotate(-12deg) scale(0.95);
            }
            100% {
                transform: translateX(-100px) translateY(0) rotate(-15deg) scale(1);
                opacity: 1;
            }
        }

        @keyframes cockroach-scuttle-right {
            0% {
                transform: translateX(-100px) translateY(0) rotate(15deg) scale(1) scaleX(-1);
                opacity: 1;
            }
            2% {
                transform: translateX(-90px) translateY(-2px) rotate(18deg) scale(1.05) scaleX(-1);
            }
            4% {
                transform: translateX(-80px) translateY(2px) rotate(12deg) scale(0.95) scaleX(-1);
            }
            100% {
                transform: translateX(120vw) translateY(0) rotate(15deg) scale(1) scaleX(-1);
                opacity: 1;
            }
        }

        @keyframes cockroach-legs-wiggle {
            0%, 100% { transform: scaleX(1); }
            25% { transform: scaleX(0.85); }
            50% { transform: scaleX(1.15); }
            75% { transform: scaleX(0.9); }
        }

        /* Widget System */
        .widget-layout-container {
            display: grid;
            grid-template-columns: repeat(48, 1fr);
            grid-auto-rows: 80px;
            gap: 1rem;
            padding: 1rem;
            min-height: calc(100vh - 200px);
        }

        .widget {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .widget:hover {
            box-shadow: 0 4px 16px var(--shadow);
            transform: translateY(-2px);
        }

        .widget.dragging {
            opacity: 0.5;
            cursor: move;
        }

        .widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .widget-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .widget-controls {
            display: flex;
            gap: 0.25rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .widget:hover .widget-controls {
            opacity: 1;
        }

        .widget-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .widget-btn:hover {
            background: var(--card-bg-hover);
            color: var(--text-primary);
        }

        .widget-content {
            height: calc(100% - 40px);
            overflow: auto;
        }

        /* In view mode, hide overflow to prevent scrollbars */
        .widget:not(.editing) .widget-content {
            overflow: hidden;
        }

        /* Clock Widget */
        .clock-widget {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .clock-time {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            font-family: 'Courier New', monospace;
            margin-bottom: 0.25rem;
        }

        .clock-date {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .clock-timezone {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Weather Widget */
        .weather-widget {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .weather-main {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .weather-icon {
            font-size: 3rem;
        }

        .weather-temp {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .weather-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }

        .weather-location {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: auto;
        }

        /* Layout Editor */
        .layout-editor-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, var(--primary-color), #667eea);
            color: white;
            padding: 1rem;
            display: none;
            align-items: center;
            gap: 1rem;
            z-index: 10001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .layout-editor-bar.active {
            display: flex;
        }

        .layout-editor-title {
            font-weight: 600;
            margin-right: auto;
        }

        .layout-editor-btn {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .layout-editor-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .layout-editor-btn.primary {
            background: white;
            color: #4c51bf;
            font-weight: 600;
        }

        .layout-editor-btn.primary:hover {
            background: rgba(255,255,255,0.9);
        }

        .widget-palette {
            position: fixed;
            right: 1rem;
            top: 80px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 8px 24px var(--shadow);
            display: none;
            z-index: 10000;
            max-height: 80vh;
            max-width: 280px;
            width: 280px;
            overflow-y: auto;
        }

        .widget-palette.active {
            display: block;
        }

        .palette-title {
            font-weight: 600;
            margin-bottom: 1rem;
            font-size: 1rem;
        }

        .palette-widget {
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: move;
            transition: all 0.2s;
        }

        .palette-widget:hover {
            background: var(--card-bg-hover);
            transform: translateX(-4px);
        }

        .palette-widget-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .palette-widget-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .widget-dropzone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: var(--input-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .widget-dropzone.drag-over {
            border-color: var(--primary-color);
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
        }

        /* Layout mode toggle */
        .layout-mode-indicator {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow);
            transition: all 0.3s;
            z-index: 1000;
        }

        .layout-mode-indicator:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px var(--shadow);
        }

        /* Widget Resize Handles */
        .widget-resize-handle {
            position: absolute;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .widget.editing:hover .widget-resize-handle {
            opacity: 0.7;
        }

        .widget-resize-handle:hover {
            opacity: 1 !important;
        }

        /* Hide widget controls and header in view mode */
        .widget:not(.editing) .widget-header {
            display: none !important;
        }

        /* Show widget header only in edit mode */
        .widget.editing .widget-header {
            display: flex !important;
        }

        /* Adjust padding and height when header is hidden */
        .widget:not(.editing) .widget-content {
            padding-top: 0;
            height: 100% !important;
        }

        .widget-resize-handle.se {
            bottom: 0;
            right: 0;
            width: 30px;
            height: 30px;
            cursor: se-resize;
            border-radius: 0 0 12px 0;
        }

        .widget-resize-handle.e {
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 40px;
            cursor: e-resize;
            border-radius: 0 6px 6px 0;
        }

        .widget-resize-handle.s {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            cursor: s-resize;
            border-radius: 0 0 6px 6px;
        }

        .widget-resize-handle.n {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 6px;
            cursor: n-resize;
            border-radius: 6px 6px 0 0;
        }

        .widget-resize-handle.w {
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 40px;
            cursor: w-resize;
            border-radius: 6px 0 0 6px;
        }

        .widget-resize-handle.ne {
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            cursor: ne-resize;
            border-radius: 0 12px 0 0;
        }

        .widget-resize-handle.nw {
            top: 0;
            left: 0;
            width: 30px;
            height: 30px;
            cursor: nw-resize;
            border-radius: 12px 0 0 0;
        }

        .widget-resize-handle.sw {
            bottom: 0;
            left: 0;
            width: 30px;
            height: 30px;
            cursor: sw-resize;
            border-radius: 0 0 0 12px;
        }

        .widget.resizing {
            opacity: 0.8;
            transition: none;
        }

        /* Emoji Picker */
        .emoji-categories {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .emoji-cat-btn {
            padding: 0.5rem 1rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .emoji-cat-btn:hover {
            background: var(--card-bg-hover);
        }

        .emoji-cat-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .emoji-item {
            font-size: 2rem;
            padding: 0.5rem;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            background: var(--input-bg);
            border: 1px solid transparent;
        }

        .emoji-item:hover {
            background: var(--card-bg-hover);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }

        .emoji-icon-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .emoji-icon-input-wrapper input {
            flex: 1;
        }

        .emoji-icon-input-wrapper button {
            padding: 0.5rem 1rem;
            white-space: nowrap;
        }

        /* Responsive adjustments for new features */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
                right: -100%;
            }

            .search-container {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="container">
        <header>
            <h1>🚀 Local Services Dashboard</h1>
            <p>Your development environment at a glance</p>
        </header>

        <div class="login-container">
            <div class="login-box">
                <h2>Sign In</h2>
                <div id="login-error" class="login-error hidden"></div>
                <form class="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" name="username" required autofocus>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="login-btn">Login</button>
                </form>
                <div style="margin-top: 1.5rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
                    <p>Local access (localhost) bypasses authentication</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="main-dashboard" class="container hidden">
        <header>
            <div class="header-user-info" id="user-info">
                <a href="#" class="username-link" id="username-display" onclick="showProfile(event)"><span style="margin-right: 0.5rem;">👤</span><span id="username-text"></span></a>
                <button class="logout-btn" onclick="handleLogout()">Logout</button>
            </div>
            <h1 id="pageTitle">🚀 Local Services Dashboard</h1>
            <p id="pageSubtitle">Your development environment at a glance</p>
        </header>

        <div class="tabs">
            <button id="favourites-tab-btn" class="tab-btn" onclick="switchToFavourites()" style="display: none;">⭐ Favourites</button>
            <div id="category-tabs" class="category-tabs"></div>
            <button id="tools-tab-btn" class="tab-btn" onclick="switchTab('tools')">🛠️ Tools</button>
            <button id="config-tab-btn" class="tab-btn" onclick="switchTab('config')" style="display: none;">Config</button>
        </div>

        <div id="favourites-content" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">⭐ Favourites</h2>
            <div id="favourites-services-grid" class="services-grid"></div>
        </div>

        <div id="services-tab" class="tab-content active">
            <div class="search-container">
                <span class="search-icon">🔍</span>
                <input type="text" id="search-box" class="search-box" placeholder="Search services..." oninput="filterServices()">
            </div>
            <div id="loading" class="loading">
                <p>Loading services...</p>
            </div>
            <div id="services-grid" class="services-grid"></div>
        </div>

        <div id="tools-tab" class="tab-content">
            <h2 style="margin-bottom: 1.5rem;">🛠️ Fun Tools</h2>

            <!-- AI Image Generator -->
            <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 4px 6px var(--shadow);">
                <h3 style="margin-top: 0; display: flex; align-items: center; gap: 0.75rem;">
                    <span style="font-size: 2rem;">🎨</span>
                    AI Image Generator
                </h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Generate unique images using AI based on your description. Limited to 5 generations per hour.
                </p>

                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label for="ai-image-prompt">Describe the image you want to create</label>
                    <textarea
                        id="ai-image-prompt"
                        rows="4"
                        placeholder="e.g., A serene mountain landscape at sunset with a lake reflection, photorealistic style..."
                        maxlength="500"
                        style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--input-bg); color: var(--text-primary); font-family: inherit; resize: vertical;"
                    ></textarea>
                    <div style="text-align: right; font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        <span id="prompt-char-count">0</span> / 500 characters
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; align-items: center;">
                    <button class="btn btn-primary" onclick="generateAIImage()" id="generate-btn">
                        🎨 Generate Image
                    </button>
                    <div id="generation-status" style="color: var(--text-secondary); font-size: 0.9rem;"></div>
                </div>

                <div id="generated-image-preview" style="margin-top: 1.5rem; display: none;">
                    <h4 style="margin-bottom: 1rem;">Generated Image:</h4>
                    <img id="preview-image" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px var(--shadow);" />
                    <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                        <button class="btn btn-secondary" onclick="downloadGeneratedImage()">📥 Download</button>
                        <button class="btn btn-secondary" onclick="loadImageGallery()">🖼️ View Gallery</button>
                    </div>
                </div>
            </div>

            <!-- Image Gallery -->
            <div style="background: var(--bg-card); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px var(--shadow);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2rem;">🖼️</span>
                        Image Gallery
                    </h3>
                    <button class="btn btn-secondary" onclick="loadImageGallery()">🔄 Refresh</button>
                </div>

                <div id="image-gallery-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem;">
                    <!-- Images will be loaded here -->
                </div>

                <div id="gallery-empty" style="text-align: center; padding: 3rem; color: var(--text-secondary); display: none;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">📷</div>
                    <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 0.5rem;">No images yet</div>
                    <div style="font-size: 0.95rem;">Generate your first AI image above!</div>
                </div>
            </div>
        </div>

        <div id="config-tab" class="tab-content">
            <div class="config-section">
                <h2>⚙️ Configuration</h2>
                <div id="config-message"></div>

                <!-- Config Sub-tabs -->
                <div class="sub-tabs">
                    <button class="sub-tab-btn active" onclick="switchConfigTab('general')">General Settings</button>
                    <button class="sub-tab-btn" onclick="switchConfigTab('services')">Systems</button>
                    <button class="sub-tab-btn" onclick="switchConfigTab('users')">Users & Access</button>
                </div>

                <!-- General Settings Sub-tab -->
                <div id="general-subtab" class="sub-tab-content active">
                    <div id="settings-editor"></div>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">💾 Save Configuration</button>
                        <button class="btn btn-secondary" onclick="generateCSV()">📄 Generate CSV to Server</button>
                    </div>
                </div>

                <!-- Systems Sub-tab (Categories & Services) -->
                <div id="services-subtab" class="sub-tab-content">
                    <h3 style="margin-bottom: 1rem;">📁 Categories</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Organize your services into categories. Services can be assigned to categories below.</p>
                    <div id="categories-editor"></div>
                    <button class="btn btn-primary" onclick="addCategory()" style="margin-top: 1rem;">+ Add New Category</button>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">🔧 Services</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Manage services within each category. Drag and drop to reorder.</p>
                    <div id="services-by-category"></div>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">📊 CSV Export</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">Configure CSV generation for port mapping scripts.</p>

                    <div style="background: var(--input-bg); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="csv-path">CSV Path (Full path including filename)</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="csv-path" placeholder="/mnt/c/scripts/port-mappings.csv" style="font-family: 'Courier New', monospace; flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="browseFolders('csv-path')" style="padding: 0.5rem 1rem; white-space: nowrap;">📁 Browse</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="csv-backup-path">Backup Directory</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" id="csv-backup-path" placeholder="/mnt/c/scripts/backups" style="font-family: 'Courier New', monospace; flex: 1;">
                                <button type="button" class="btn btn-secondary" onclick="browseFolders('csv-backup-path')" style="padding: 0.5rem 1rem; white-space: nowrap;">📁 Browse</button>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button class="btn btn-primary" onclick="saveConfig()">💾 Save Configuration</button>
                        <button class="btn btn-secondary" onclick="generateCSV()">📤 Generate CSV to Server</button>
                        <button class="btn btn-secondary" onclick="downloadCSV()">💾 Download CSV</button>
                    </div>
                </div>

                <!-- Users & Access Sub-tab -->
                <div id="users-subtab" class="sub-tab-content">
                    <h3 style="margin-bottom: 1rem;">Users</h3>
                    <div id="users-list"></div>
                    <button class="btn btn-primary" onclick="showAddUserModal()" style="margin-top: 1rem;">+ Add New User</button>

                    <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Roles & Access Rights</h3>
                    <div id="roles-editor"></div>
                    <button class="btn btn-primary" onclick="showAddRoleModal()" style="margin-top: 1rem;">+ Add New Role</button>
                </div>
            </div>
        </div>
    </div> <!-- End of config-tab -->
    </div> <!-- End of main-dashboard -->

    <!-- Profile Modal -->
    <!-- Dialog Modal -->
    <div id="dialog-modal" class="modal-overlay hidden">
        <div class="dialog-modal">
            <div class="dialog-header">
                <span id="dialog-icon" class="dialog-icon"></span>
                <h3 id="dialog-title" class="dialog-title"></h3>
            </div>
            <div id="dialog-message" class="dialog-message"></div>
            <div class="dialog-actions" id="dialog-actions"></div>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-modal" class="modal-overlay hidden" onclick="closeUserModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeUserModal()">&times;</button>
            <h2 id="user-modal-title">Add User</h2>
            <div id="user-modal-message"></div>

            <div class="form-group">
                <label for="user-username">Username *</label>
                <input type="text" id="user-username" required>
            </div>

            <div class="form-group">
                <label for="user-first-name">First Name</label>
                <input type="text" id="user-first-name">
            </div>

            <div class="form-group">
                <label for="user-last-name">Last Name</label>
                <input type="text" id="user-last-name">
            </div>

            <div class="form-group">
                <label for="user-email">Email</label>
                <input type="email" id="user-email">
            </div>

            <div class="form-group">
                <label for="user-password">Password *</label>
                <input type="password" id="user-password" required>
                <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Password must be at least 8 characters with uppercase, lowercase, number, and special character
                </small>
            </div>

            <div class="form-group">
                <label>Roles *</label>
                <div id="user-roles-checkboxes"></div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveUser()">Save User</button>
                <button class="btn btn-secondary" onclick="closeUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Role Edit Modal -->
    <div id="role-modal" class="modal-overlay hidden" onclick="closeRoleModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="closeRoleModal()">&times;</button>
            <h2 id="role-modal-title">Add Role</h2>
            <div id="role-modal-message"></div>

            <div class="form-group">
                <label for="role-name">Role Name *</label>
                <input type="text" id="role-name" required>
            </div>

            <div class="form-group">
                <label for="role-description">Description</label>
                <input type="text" id="role-description">
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="role-is-admin">
                    <span>Administrator (can access Config tab)</span>
                </label>
            </div>

            <div class="form-group">
                <label>Access to Categories</label>
                <div id="role-categories-checkboxes"></div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveRole()">Save Role</button>
                <button class="btn btn-secondary" onclick="closeRoleModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Service Edit Modal -->
    <div id="service-modal" class="modal-overlay hidden" onclick="closeServiceModal(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 600px;">
            <button class="modal-close" onclick="closeServiceModal()">&times;</button>
            <h2 id="service-modal-title">Edit Service</h2>
            <div id="service-modal-message"></div>

            <div class="form-group">
                <label for="service-name">Name *</label>
                <input type="text" id="service-name" required>
            </div>

            <div class="form-group">
                <label for="service-icon">Icon (emoji)</label>
                <div class="emoji-icon-input-wrapper">
                    <input type="text" id="service-icon" placeholder="🔧">
                    <button type="button" class="btn btn-secondary" onclick="openEmojiPicker('service-icon')">Choose</button>
                </div>
            </div>

            <div class="form-group">
                <label for="service-url">URL *</label>
                <input type="text" id="service-url" required placeholder="http://localhost:8080">
            </div>

            <div class="form-group">
                <label for="service-description">Description</label>
                <textarea id="service-description" rows="3"></textarea>
            </div>

            <div class="form-group">
                <label for="service-port">Port</label>
                <input type="number" id="service-port" placeholder="8080">
            </div>

            <div class="form-group">
                <label for="service-category">Category *</label>
                <select id="service-category" required>
                    <option value="">Select category...</option>
                </select>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="service-local">
                    <span>Local service</span>
                </label>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="saveService()">Save Service</button>
                <button class="btn btn-secondary" onclick="closeServiceModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Folder Browser Modal -->
    <div id="folder-browser-modal" class="modal-overlay hidden" onclick="closeFolderBrowser(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 700px; max-height: 80vh;">
            <button class="modal-close" onclick="closeFolderBrowser()">&times;</button>
            <h2>Browse Folders</h2>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--input-bg); border-radius: 4px; font-family: 'Courier New', monospace; font-size: 0.9rem; color: var(--text-primary); overflow-x: auto;">
                    <span id="browser-current-path">/</span>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="navigateToParent()" id="browser-parent-btn" style="margin-right: 0.5rem;">
                    ⬆️ Parent Directory
                </button>
                <button class="btn btn-secondary" onclick="refreshBrowser()">
                    🔄 Refresh
                </button>
            </div>

            <div id="folder-list" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--input-bg); border-radius: 4px; padding: 0.5rem;">
                <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                    Loading...
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                <button class="btn btn-primary" onclick="selectCurrentFolder()">Select This Folder</button>
                <button class="btn btn-secondary" onclick="closeFolderBrowser()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emoji-picker-modal" class="modal-overlay hidden" onclick="closeEmojiPicker(event)">
        <div class="modal" onclick="event.stopPropagation()" style="max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeEmojiPicker()">&times;</button>
            <h2>Choose an Emoji</h2>

            <div class="emoji-categories">
                <button class="emoji-cat-btn active" onclick="showEmojiCategory('smileys')">😊 Smileys</button>
                <button class="emoji-cat-btn" onclick="showEmojiCategory('objects')">🔧 Objects</button>
                <button class="emoji-cat-btn" onclick="showEmojiCategory('symbols')">⚙️ Symbols</button>
                <button class="emoji-cat-btn" onclick="showEmojiCategory('nature')">🌿 Nature</button>
            </div>

            <div id="emoji-grid" class="emoji-grid"></div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">⚙️ Settings</h2>
            <button onclick="toggleSettings()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary); padding: 0; line-height: 1;" title="Close">&times;</button>
        </div>

        <!-- Tabs -->
        <div class="settings-tabs">
            <button class="settings-tab active" onclick="switchSettingsTab('profile')">👤 Profile</button>
            <button class="settings-tab" onclick="switchSettingsTab('customization')">🎨 Customization</button>
        </div>

        <!-- Profile Tab -->
        <div id="profile-tab" class="settings-tab-content active">
            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Profile Information</h3>
            <div id="profile-message"></div>

            <div class="form-group">
                <label for="profile-first-name">First Name</label>
                <input type="text" id="profile-first-name">
            </div>

            <div class="form-group">
                <label for="profile-last-name">Last Name</label>
                <input type="text" id="profile-last-name">
            </div>

            <div class="form-group">
                <label for="profile-email-input">Email</label>
                <input type="email" id="profile-email-input">
            </div>

            <div class="profile-info" style="margin-bottom: 1.5rem;">
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Roles:</strong> <span id="profile-roles"></span></p>
            </div>

            <button class="btn btn-primary" onclick="updateProfile()" style="margin-bottom: 2rem;">Save Profile</button>

            <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Change Password</h3>
            <div id="password-message"></div>

            <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" required>
            </div>

            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" required>
                <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Password must be at least 8 characters with uppercase, lowercase, number, and special character
                </small>
            </div>

            <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" required>
            </div>

            <button class="btn btn-primary" onclick="changePassword()">Change Password</button>
        </div>

        <!-- Customization Tab -->
        <div id="customization-tab" class="settings-tab-content">
            <div class="form-group">
                <label>
                    <input type="checkbox" id="sound-enabled" onchange="toggleSound()" />
                    Enable Sound Effects
                </label>
            </div>

            <div class="form-group">
                <label for="ambient-sound">Ambient Background Sound</label>
                <select id="ambient-sound" onchange="changeAmbientSound(this.value)">
                    <option value="none">None</option>
                    <option value="rain">Gentle Rain</option>
                    <option value="ocean">Ocean Waves</option>
                    <option value="forest">Forest Birds</option>
                    <option value="cafe">Coffee Shop</option>
                    <option value="fireplace">Fireplace Crackling</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ambient-volume">Ambient Sound Volume</label>
                <input type="range" id="ambient-volume" min="0" max="100" value="15" oninput="changeAmbientVolume(this.value)" style="width: 100%;">
                <span id="ambient-volume-display" style="color: var(--text-secondary); font-size: 0.9rem;">15%</span>
            </div>

            <div class="form-group">
                <label for="particle-time">Time of Day</label>
                <select id="particle-time" onchange="changeParticleTime(this.value)">
                    <option value="auto">Automatic</option>
                    <option value="morning">Morning</option>
                    <option value="afternoon">Afternoon</option>
                    <option value="evening">Evening</option>
                    <option value="night">Night</option>
                </select>
            </div>

            <div class="form-group">
                <label for="particle-season">Season</label>
                <select id="particle-season" onchange="changeParticleSeason(this.value)">
                    <option value="auto">Automatic</option>
                    <option value="summer">Summer</option>
                    <option value="autumn">Autumn</option>
                    <option value="winter">Winter</option>
                    <option value="spring">Spring</option>
                </select>
            </div>

            <div class="form-group">
                <label>Theme Mode</label>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="theme-btn" data-theme="light" onclick="setTheme('light')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; background: var(--input-bg); cursor: pointer;">☀️ Light</button>
                    <button class="theme-btn" data-theme="dark" onclick="setTheme('dark')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; background: var(--input-bg); cursor: pointer;">🌙 Dark</button>
                    <button class="theme-btn" data-theme="system" onclick="setTheme('system')" style="flex: 1; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 6px; background: var(--input-bg); cursor: pointer;">💻 System</button>
                </div>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="particles-enabled" onchange="toggleParticles()" checked />
                    Enable Background Particles
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="animations-enabled" onchange="toggleAnimations()" checked />
                    Enable Animations
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="cockroach-enabled" onchange="toggleCockroaches()" checked />
                    Enable Cockroach Easter Egg 🪳 (Random + Click trigger in bottom-left corner)
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="show-favourites-tab" onchange="toggleFavouritesTab()" checked />
                    Show Favourites Tab
                </label>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" id="favorites-only" onchange="filterServices()" />
                    Show Favorites Only
                </label>
            </div>

            <div class="form-group">
                <label>Category Color Theme</label>
                <select id="color-theme" onchange="applyColorTheme()">
                    <option value="default">Default</option>
                    <option value="vibrant">Vibrant</option>
                    <option value="pastel">Pastel</option>
                    <option value="monochrome">Monochrome</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Easter Egg Container -->
    <div id="easter-egg" class="easter-egg"></div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Background Particles -->
    <div id="bg-particles" class="bg-particles"></div>

    <!-- Cockroach Easter Egg Trigger (bottom-left corner, hidden) -->
    <div id="cockroach-trigger" style="position: fixed; bottom: 0; left: 0; width: 50px; height: 50px; z-index: 10000; cursor: crosshair; opacity: 0;" title="Click me 3 times!"></div>

    <!-- Widget Layout Editor Bar -->
    <div id="layout-editor-bar" class="layout-editor-bar">
        <div class="layout-editor-title">🎨 Layout Editor</div>
        <button class="layout-editor-btn" onclick="widgetSystem.addWidgetFromPalette()">➕ Add Widget</button>
        <button class="layout-editor-btn" onclick="widgetSystem.resetLayout()">🔄 Reset</button>
        <button class="layout-editor-btn" onclick="widgetSystem.switchToClassicMode()">📋 Classic Mode</button>
        <button class="layout-editor-btn primary" onclick="widgetSystem.exitEditMode()">✓ Done</button>
    </div>

    <!-- Widget Palette -->
    <div id="widget-palette" class="widget-palette">
        <div class="palette-title">Available Widgets</div>
        <div class="palette-widget" draggable="true" data-widget-type="clock">
            <div class="palette-widget-title">🕐 Clock</div>
            <div class="palette-widget-desc">Display current time and date</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="weather">
            <div class="palette-widget-title">🌤️ Weather</div>
            <div class="palette-widget-desc">Current weather conditions</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="profile">
            <div class="palette-widget-title">👤 Profile</div>
            <div class="palette-widget-desc">User profile and logout</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="title">
            <div class="palette-widget-title">📝 Title</div>
            <div class="palette-widget-desc">Page title and subtitle</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="categories">
            <div class="palette-widget-title">📁 Categories</div>
            <div class="palette-widget-desc">Service categories navigation</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="search">
            <div class="palette-widget-title">🔍 Search</div>
            <div class="palette-widget-desc">Search services</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="services">
            <div class="palette-widget-title">🚀 Services</div>
            <div class="palette-widget-desc">Service cards grid</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="config">
            <div class="palette-widget-title">⚙️ Settings</div>
            <div class="palette-widget-desc">Quick access to settings</div>
        </div>
        <div class="palette-widget" draggable="true" data-widget-type="tools">
            <div class="palette-widget-title">🛠️ Tools</div>
            <div class="palette-widget-desc">Quick access to tools (SD image gen, etc.)</div>
        </div>
    </div>

    <!-- Layout Mode Toggle Button (Classic Mode - switch to widgets) -->
    <div id="layout-mode-toggle" class="layout-mode-indicator" onclick="widgetSystem.toggleLayoutMode()" title="Switch to Widget Mode" style="display: none;">
        🧩
    </div>

    <!-- Edit Layout Button (shown in widget view mode) -->
    <div id="edit-layout-btn" class="layout-mode-indicator" onclick="widgetSystem.enterEditMode()" title="Edit Layout" style="display: none; bottom: 5rem;">
        ✏️
    </div>

    <!-- Widget Mode Toggle (shown in widget view mode to go back to classic) -->
    <div id="widget-mode-toggle" class="layout-mode-indicator" onclick="widgetSystem.switchToClassicMode()" title="Switch to Classic Mode" style="display: none; bottom: 10rem;">
        📋
    </div>

    <!-- Widget Layout Container (hidden by default, shown when widget mode enabled) -->
    <div id="widget-layout-container" class="widget-layout-container" style="display: none;">
        <!-- Widgets will be dynamically inserted here -->
    </div>

    <script>
        let config = null;
        let currentUser = null;

        // Custom Dialog System
        function showDialog(options) {
            return new Promise((resolve) => {
                const modal = document.getElementById('dialog-modal');
                const icon = document.getElementById('dialog-icon');
                const title = document.getElementById('dialog-title');
                const message = document.getElementById('dialog-message');
                const actions = document.getElementById('dialog-actions');

                // Set icon
                icon.className = 'dialog-icon ' + (options.type || 'info');
                const iconMap = {
                    'warning': '⚠️',
                    'error': '❌',
                    'info': 'ℹ️',
                    'success': '✅'
                };
                icon.textContent = iconMap[options.type] || 'ℹ️';

                // Set content
                title.textContent = options.title || 'Notice';
                message.textContent = options.message || '';

                // Build actions
                actions.innerHTML = '';

                if (options.confirm) {
                    // Confirm dialog
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'dialog-btn dialog-btn-secondary';
                    cancelBtn.textContent = options.cancelText || 'Cancel';
                    cancelBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(false);
                    };

                    const confirmBtn = document.createElement('button');
                    confirmBtn.className = 'dialog-btn dialog-btn-primary';
                    confirmBtn.textContent = options.confirmText || 'OK';
                    confirmBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };

                    actions.appendChild(cancelBtn);
                    actions.appendChild(confirmBtn);
                } else {
                    // Alert dialog
                    const okBtn = document.createElement('button');
                    okBtn.className = 'dialog-btn dialog-btn-primary';
                    okBtn.textContent = 'OK';
                    okBtn.onclick = () => {
                        modal.classList.add('hidden');
                        resolve(true);
                    };
                    actions.appendChild(okBtn);
                }

                // Show modal
                modal.classList.remove('hidden');
            });
        }

        // Replace alert() and confirm()
        function customAlert(message, title = 'Notice', type = 'info') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: false
            });
        }

        function customConfirm(message, title = 'Confirm', type = 'warning') {
            return showDialog({
                title: title,
                message: message,
                type: type,
                confirm: true,
                confirmText: 'Confirm',
                cancelText: 'Cancel'
            });
        }

        // Theme Management
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Color themes - affects background gradient, buttons, and service icons
        // (Dark/Light mode controls card colors, text, shadows, borders)
        const colorThemes = {
            default: {
                light: {
                    'bg-primary': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'bg-card': '#ffffff',
                    'text-primary': '#333333',
                    'text-secondary': '#718096',
                    'text-header': '#ffffff',
                    'border-color': '#e2e8f0',
                    'input-bg': '#f7fafc',
                    'button-bg': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#667eea',
                    'color-system': '#fc8181',
                    'color-external': '#48bb78',
                    'color-family': '#ed8936',
                    'danger-bg': '#f56565',
                    'danger-text': '#ffffff'
                },
                dark: {
                    'bg-primary': 'linear-gradient(135deg, #1a202c 0%, #2d3748 100%)',
                    'bg-card': '#2d3748',
                    'text-primary': '#e2e8f0',
                    'text-secondary': '#a0aec0',
                    'text-header': '#e2e8f0',
                    'border-color': '#4a5568',
                    'input-bg': '#1a202c',
                    'button-bg': 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#8b7fd3',
                    'color-system': '#fc8181',
                    'color-external': '#68d391',
                    'color-family': '#ed8936',
                    'danger-bg': '#e53e3e',
                    'danger-text': '#ffffff'
                }
            },
            vibrant: {
                light: {
                    'bg-primary': 'linear-gradient(135deg, #e01e5a 0%, #ff6b9d 100%)',
                    'bg-card': '#ffffff',
                    'text-primary': '#333333',
                    'text-secondary': '#718096',
                    'text-header': '#ffffff',
                    'border-color': '#e2e8f0',
                    'input-bg': '#f7fafc',
                    'button-bg': 'linear-gradient(135deg, #e01e5a 0%, #ff6b9d 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#e01e5a',
                    'color-system': '#2eb67d',
                    'color-external': '#ecb22e',
                    'color-family': '#36c5f0',
                    'danger-bg': '#f56565',
                    'danger-text': '#ffffff'
                },
                dark: {
                    'bg-primary': 'linear-gradient(135deg, #2d1625 0%, #3d2533 100%)',
                    'bg-card': '#3d2533',
                    'text-primary': '#fce7ef',
                    'text-secondary': '#d4a5b8',
                    'text-header': '#fce7ef',
                    'border-color': '#5a3d4a',
                    'input-bg': '#2d1625',
                    'button-bg': 'linear-gradient(135deg, #e01e5a 0%, #ff6b9d 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#ff6b9d',
                    'color-system': '#3ec993',
                    'color-external': '#f5d042',
                    'color-family': '#4dd4f7',
                    'danger-bg': '#e53e3e',
                    'danger-text': '#ffffff'
                }
            },
            pastel: {
                light: {
                    'bg-primary': 'linear-gradient(135deg, #b4a7d6 0%, #d4a5a5 100%)',
                    'bg-card': '#ffffff',
                    'text-primary': '#333333',
                    'text-secondary': '#718096',
                    'text-header': '#ffffff',
                    'border-color': '#e2e8f0',
                    'input-bg': '#f7fafc',
                    'button-bg': 'linear-gradient(135deg, #b4a7d6 0%, #d4a5a5 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#b4a7d6',
                    'color-system': '#f4a5a5',
                    'color-external': '#a8e6cf',
                    'color-family': '#ffd3b6',
                    'danger-bg': '#f56565',
                    'danger-text': '#ffffff'
                },
                dark: {
                    'bg-primary': 'linear-gradient(135deg, #2e2640 0%, #3d2e2e 100%)',
                    'bg-card': '#3d2e3d',
                    'text-primary': '#e9e4f0',
                    'text-secondary': '#c4b5d9',
                    'text-header': '#e9e4f0',
                    'border-color': '#5a4a5a',
                    'input-bg': '#2e2640',
                    'button-bg': 'linear-gradient(135deg, #b4a7d6 0%, #d4a5a5 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#c4b5e6',
                    'color-system': '#f4a5a5',
                    'color-external': '#b8f0d9',
                    'color-family': '#ffe3c6',
                    'danger-bg': '#e53e3e',
                    'danger-text': '#ffffff'
                }
            },
            monochrome: {
                light: {
                    'bg-primary': 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
                    'bg-card': '#ffffff',
                    'text-primary': '#333333',
                    'text-secondary': '#718096',
                    'text-header': '#ffffff',
                    'border-color': '#e2e8f0',
                    'input-bg': '#f7fafc',
                    'button-bg': 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#4a5568',
                    'color-system': '#718096',
                    'color-external': '#a0aec0',
                    'color-family': '#cbd5e0',
                    'danger-bg': '#f56565',
                    'danger-text': '#ffffff'
                },
                dark: {
                    'bg-primary': 'linear-gradient(135deg, #0f1419 0%, #1a1f2e 100%)',
                    'bg-card': '#1a1f2e',
                    'text-primary': '#e2e8f0',
                    'text-secondary': '#94a3b8',
                    'text-header': '#e2e8f0',
                    'border-color': '#2d3748',
                    'input-bg': '#0f1419',
                    'button-bg': 'linear-gradient(135deg, #4a5568 0%, #2d3748 100%)',
                    'button-text': '#ffffff',
                    'color-professional': '#64748b',
                    'color-system': '#94a3b8',
                    'color-external': '#cbd5e0',
                    'color-family': '#e2e8f0',
                    'danger-bg': '#e53e3e',
                    'danger-text': '#ffffff'
                }
            }
        };

        function setCookie(name, value, days = 365) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        function applyTheme(theme) {
            if (theme === 'system') {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', systemTheme);
            } else {
                document.documentElement.setAttribute('data-theme', theme);
            }

            // Update active button
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.theme === theme) {
                    btn.classList.add('active');
                }
            });

            // Reapply color theme with new light/dark mode
            if (typeof applyColorTheme === 'function') {
                applyColorTheme();
            }
        }

        function setTheme(theme) {
            setCookie('theme', theme);
            applyTheme(theme);
        }

        // Initialize theme from cookie
        const savedTheme = getCookie('theme') || 'system';
        applyTheme(savedTheme);

        // Listen for system theme changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            const currentTheme = getCookie('theme') || 'system';
            if (currentTheme === 'system') {
                applyTheme('system');
            }
        });

        // Authentication functions
        async function checkAuthStatus() {
            try {
                const response = await fetch('/api/auth/status', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.authenticated) {
                    currentUser = data.user;

                    // Show/hide Config tab based on admin status
                    const configBtn = document.getElementById('config-tab-btn');
                    if (currentUser.is_admin) {
                        configBtn.style.display = 'inline-block';
                    } else {
                        configBtn.style.display = 'none';
                    }

                    showDashboard();
                    loadConfig();
                } else {
                    showLogin();
                }
            } catch (error) {
                console.error('Error checking auth status:', error);
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('main-dashboard').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');

            // Update user info display
            if (currentUser) {
                let displayName;
                if (currentUser.is_local) {
                    displayName = `${currentUser.username} (Local Access)`;
                } else if (currentUser.first_name) {
                    displayName = `Hello, ${currentUser.first_name}`;
                } else {
                    displayName = currentUser.username;
                }
                document.getElementById('username-text').textContent = displayName;

                // Hide user info for local access
                if (currentUser.is_local) {
                    document.getElementById('user-info').style.display = 'none';
                }

                // Show/hide Config tab based on admin status
                const configBtn = document.getElementById('config-tab-btn');
                if (currentUser.is_admin) {
                    configBtn.style.display = 'inline-block';
                } else {
                    configBtn.style.display = 'none';
                }
            }
        }

        // Profile functions
        function showProfile(event) {
            if (event) event.preventDefault();

            // Load profile data
            fetch('/api/auth/profile', {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('profile-username').textContent = data.username;
                document.getElementById('profile-roles').textContent = data.roles.join(', ');

                // Populate editable fields
                document.getElementById('profile-first-name').value = data.first_name || '';
                document.getElementById('profile-last-name').value = data.last_name || '';
                document.getElementById('profile-email-input').value = data.email || '';

                // Open settings panel on Profile tab
                switchSettingsTab('profile');
                document.getElementById('settings-panel').classList.add('open');
            })
            .catch(error => {
                console.error('Error loading profile:', error);
            });
        }

        async function updateProfile() {
            const messageDiv = document.getElementById('profile-message');
            const first_name = document.getElementById('profile-first-name').value.trim();
            const last_name = document.getElementById('profile-last-name').value.trim();
            const email = document.getElementById('profile-email-input').value.trim();

            try {
                const response = await fetch('/api/auth/profile', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ first_name, last_name, email })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to update profile');
                }

                showToast('Profile updated successfully!', 'success');

                // Update header with new name
                updateHeaderName(first_name);

                // Refresh users list if currently viewing Config > Users & Access
                const usersSubtab = document.getElementById('users-subtab');
                if (usersSubtab && usersSubtab.classList.contains('active')) {
                    await loadUsers();
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast(`Failed to update profile: ${error.message}`, 'error');
            }
        }

        function updateHeaderName(firstName) {
            if (firstName && currentUser) {
                currentUser.first_name = firstName;
                const displayName = `Hello, ${firstName}`;
                document.getElementById('username-text').textContent = displayName;
            }
        }

        // Show Tools - switches to classic mode and opens tools tab
        function showTools(event) {
            if (event) event.preventDefault();

            // If in widget mode, switch to classic mode first
            if (typeof widgetSystem !== 'undefined' && widgetSystem.layoutMode === 'widget') {
                widgetSystem.switchToClassicMode();
            }

            // Wait a moment for mode switch, then activate tools tab
            setTimeout(() => {
                const toolsBtn = document.getElementById('tools-tab-btn');
                if (toolsBtn) {
                    toolsBtn.click();
                }
            }, 100);
        }

        // Show Settings - opens settings modal
        function showSettings(event) {
            if (event) event.preventDefault();

            const modal = document.getElementById('settings-modal');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function switchSettingsTab(tabName) {
            // Remove active class from all tabs and content
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.settings-tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to selected tab and content
            event?.target?.classList.add('active');
            document.getElementById(`${tabName}-tab`)?.classList.add('active');

            // Also activate the tab button if called programmatically
            const tabButtons = document.querySelectorAll('.settings-tab');
            tabButtons.forEach(button => {
                const tabMap = {
                    'profile': 'Profile',
                    'customization': 'Customization'
                };
                if (button.textContent.includes(tabMap[tabName])) {
                    button.classList.add('active');
                }
            });
        }


        function toggleFavouritesTab() {
            const checkbox = document.getElementById('show-favourites-tab');
            const favouritesTabBtn = document.getElementById('favourites-tab-btn');
            const favouritesContent = document.getElementById('favourites-content');

            if (checkbox.checked) {
                favouritesTabBtn.style.display = 'inline-block';
                localStorage.setItem('showFavouritesTab', 'true');
            } else {
                favouritesTabBtn.style.display = 'none';
                // If currently viewing favourites, switch to first category
                if (favouritesContent && favouritesContent.classList.contains('active')) {
                    if (config.categories && config.categories.length > 0) {
                        switchCategory(config.categories[0].name);
                    }
                }
                localStorage.setItem('showFavouritesTab', 'false');
            }
        }

        async function changePassword() {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const messageDiv = document.getElementById('password-message');

            messageDiv.innerHTML = '';

            // Validation
            if (!currentPassword || !newPassword || !confirmPassword) {
                messageDiv.innerHTML = '<div class="error">All fields are required</div>';
                return;
            }

            if (newPassword !== confirmPassword) {
                messageDiv.innerHTML = '<div class="error">New passwords do not match</div>';
                return;
            }

            if (newPassword.length < 6) {
                messageDiv.innerHTML = '<div class="error">New password must be at least 6 characters</div>';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    messageDiv.innerHTML = '<div class="success">Password changed successfully!</div>';
                    // Clear fields
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';

                    // Clear message after 3 seconds
                    setTimeout(() => {
                        messageDiv.innerHTML = '';
                    }, 3000);
                } else {
                    messageDiv.innerHTML = `<div class="error">${data.error || 'Failed to change password'}</div>`;
                }
            } catch (error) {
                console.error('Error changing password:', error);
                messageDiv.innerHTML = '<div class="error">Connection error. Please try again.</div>';
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    currentUser = data.user;
                    showDashboard();
                    loadConfig();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                currentUser = null;
                showLogin();

                // Clear form
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // State Management
        function saveState() {
            // Get current config sub-tab
            const activeSubTab = document.querySelector('.sub-tab-btn.active');
            const currentConfigSubTab = activeSubTab ?
                activeSubTab.textContent.toLowerCase().replace(/ & /g, '-').replace(/ /g, '-') : 'general';

            const state = {
                currentTab: getCurrentTab(),
                currentCategory: window.currentCategory || null,
                currentConfigSubTab: currentConfigSubTab,
                timestamp: Date.now()
            };
            localStorage.setItem('dashboardState', JSON.stringify(state));
        }

        function loadState() {
            try {
                const savedState = localStorage.getItem('dashboardState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    return state;
                }
            } catch (e) {
                console.error('Error loading state:', e);
            }
            return null;
        }

        function getCurrentTab() {
            const activeTab = document.querySelector('.tab-content.active');
            if (activeTab) {
                return activeTab.id.replace('-tab', '');
            }
            return 'services';
        }

        function restoreTab() {
            const state = loadState();
            if (state) {
                // Prevent non-admin users from restoring config tab
                if (state.currentTab === 'config' && currentUser && !currentUser.is_admin) {
                    // Stay on default services tab for non-admin users
                    return;
                }

                // Restore category if in services view
                if (state.currentCategory && state.currentTab === 'services') {
                    switchCategory(state.currentCategory);
                }

                // Restore main tab
                if (state.currentTab && state.currentTab !== 'services') {
                    const tabButtons = document.querySelectorAll('.tab-btn');
                    tabButtons.forEach((btn) => {
                        if (btn.textContent.toLowerCase().includes(state.currentTab.toLowerCase())) {
                            // Remove active from all
                            tabButtons.forEach(b => b.classList.remove('active'));
                            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                            // Add active to target
                            btn.classList.add('active');
                            document.getElementById(`${state.currentTab}-tab`).classList.add('active');

                            // Render config if needed
                            if (state.currentTab === 'config' && config) {
                                renderSettingsEditor();
                                renderCategoriesEditor();
                                renderCSVSettings();
                                renderServicesByCategory_Config();

                                // Restore config sub-tab
                                if (state.currentConfigSubTab) {
                                    // Map display name back to sub-tab name
                                    let subTabName = 'general';
                                    if (state.currentConfigSubTab.includes('users')) {
                                        subTabName = 'users';
                                    } else if (state.currentConfigSubTab.includes('services')) {
                                        subTabName = 'services';
                                    }

                                    // Update sub-tab buttons
                                    document.querySelectorAll('.sub-tab-btn').forEach(btn => {
                                        btn.classList.remove('active');
                                        if (btn.textContent.toLowerCase().includes(subTabName) ||
                                            (subTabName === 'general' && btn.textContent.includes('General'))) {
                                            btn.classList.add('active');
                                        }
                                    });

                                    // Update sub-tab content
                                    document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
                                    document.getElementById(`${subTabName}-subtab`)?.classList.add('active');

                                    // Load data if needed
                                    if (subTabName === 'users') {
                                        loadUsers();
                                        loadRoles();
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }

        // Tab Management
        function switchTab(tabName) {
            // Prevent non-admin users from accessing config tab
            if (tabName === 'config' && currentUser && !currentUser.is_admin) {
                // Redirect to dashboard
                tabName = 'dashboard';
            }

            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'config' && config) {
                renderSettingsEditor();
                renderCategoriesEditor();
                renderCSVSettings();
                renderServicesByCategory_Config();
            }

            if (tabName === 'tools') {
                loadImageGallery();
            }

            // Save state
            saveState();
        }

        // Switch between config sub-tabs
        function switchConfigTab(subTabName) {
            // Update sub-tab buttons
            document.querySelectorAll('.sub-tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update sub-tab content
            document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${subTabName}-subtab`).classList.add('active');

            // Load users if switching to users tab
            if (subTabName === 'users') {
                loadUsers();
                loadRoles();
            }

            // Save state
            saveState();
        }

        // Load configuration
        async function loadConfig() {
            try {
                const response = await fetch('/api/config', {
                    credentials: 'include'
                });

                if (response.status === 401) {
                    // Not authenticated, show login
                    showLogin();
                    return;
                }

                if (!response.ok) throw new Error('Failed to load configuration');

                config = await response.json();

                // Update title and subtitle
                if (config.settings) {
                    document.getElementById('pageTitle').textContent = '🚀 ' + (config.settings.title || 'Local Services Dashboard');
                    document.getElementById('pageSubtitle').textContent = config.settings.subtitle || 'Your development environment at a glance';
                }

                // Render category tabs and services
                renderCategoryTabs();

                // Restore tab state after config is loaded
                setTimeout(() => restoreTab(), 100);
            } catch (error) {
                console.error('Error loading config:', error);
                document.getElementById('loading').innerHTML = '<p style="color: #f56565;">Error loading services. Please refresh the page.</p>';
            }
        }

        // Get favicon URL
        function getFaviconUrl(serviceUrl) {
            try {
                const url = new URL(serviceUrl);
                return `${url.protocol}//${url.host}/favicon.ico`;
            } catch (e) {
                return null;
            }
        }

        // Render category tabs
        function renderCategoryTabs() {
            const container = document.getElementById('category-tabs');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                return;
            }

            config.categories.forEach((category, index) => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';

                // Add icon if available
                if (category.icon) {
                    btn.textContent = `${category.icon} ${category.name}`;
                } else {
                    btn.textContent = category.name;
                }

                btn.onclick = () => switchCategory(category.name);

                if (index === 0 && !window.currentCategory) {
                    btn.classList.add('active');
                    window.currentCategory = category.name;
                }

                container.appendChild(btn);
            });

            // Render services for the first/current category
            renderServicesByCategory(window.currentCategory || config.categories[0].name);
        }

        // Switch category
        function switchCategory(categoryName) {
            // Update active category tab
            document.querySelectorAll('#category-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === categoryName || btn.textContent.includes(categoryName)) {
                    btn.classList.add('active');
                }
            });

            // Deactivate favourites and config tabs
            document.getElementById('favourites-tab-btn')?.classList.remove('active');
            document.getElementById('config-tab-btn')?.classList.remove('active');

            // Make sure services tab is active
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('services-tab').classList.add('active');

            window.currentCategory = categoryName;
            renderServicesByCategory(categoryName);
            saveState();
        }

        function switchToFavourites() {
            // Deactivate all category tabs
            document.querySelectorAll('#category-tabs .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('config-tab-btn')?.classList.remove('active');

            // Activate favourites tab
            document.getElementById('favourites-tab-btn').classList.add('active');

            // Show favourites content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('favourites-content').classList.add('active');

            // Render favourites
            renderFavouritesServices();
            window.currentCategory = null;
            saveState();
        }

        // Create a single service card element
        function createServiceCard(service) {
            const card = document.createElement('a');
            card.href = service.url;
            card.className = 'service-card';
            card.target = '_blank';
            card.style.position = 'relative';

            // Add category color class
            const catClass = service.category.toLowerCase().replace(/\s+/g, '-');
            card.setAttribute('data-category', catClass);
            card.classList.add(`category-${catClass}`);

            const faviconUrl = getFaviconUrl(service.url);
            const iconContent = service.icon || '🔧';

            // Try to load favicon, fall back to emoji if it fails
            let iconHtml = iconContent;
            if (faviconUrl) {
                iconHtml = `<img src="${faviconUrl}" alt="${service.name}" onerror="this.parentElement.innerHTML='${iconContent}'" />`;
            }

            // Favorite star (use category-name as unique ID)
            const favoriteId = `${service.category}-${service.name}`;
            const isFav = isFavorite(favoriteId);
            const starClass = isFav ? 'favorited' : '';

            card.innerHTML = `
                <span class="favorite-star ${starClass}" onclick="toggleFavorite('${favoriteId}', event)">${isFav ? '⭐' : '☆'}</span>
                <div class="service-icon">${iconHtml}</div>
                <div class="service-header">
                    <div class="service-title">${service.name}</div>
                    <span class="service-status status-${service.status || 'running'}">${service.status || 'Running'}</span>
                </div>
                <div class="service-url">${service.url}</div>
                <div class="service-description">${service.description || ''}</div>
            `;

            return card;
        }

        function renderFavouritesServices() {
            const grid = document.getElementById('favourites-services-grid');
            grid.innerHTML = '';

            if (!config || !config.services) {
                grid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 2rem;">No services configured yet.</p>';
                return;
            }

            // Get all favorited services
            const favorites = config.services.filter(service => {
                const favs = getFavorites();
                return favs.includes(`${service.category}-${service.name}`);
            });

            if (favorites.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--text-primary); opacity: 0.7;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">⭐</div>
                        <div style="font-size: 1.2rem; font-weight: 500; margin-bottom: 0.5rem;">No favorites yet</div>
                        <div style="font-size: 0.95rem; color: var(--text-secondary);">Click the ⭐ icon on any service to add it to your favorites!</div>
                    </div>
                `;
                return;
            }

            // Apply grid columns setting
            const gridColumns = config.settings?.grid_columns || 'auto';
            if (gridColumns === 'auto') {
                grid.removeAttribute('data-columns');
            } else {
                grid.setAttribute('data-columns', gridColumns);
            }

            // Render favorite services
            favorites.forEach(service => {
                const serviceCard = createServiceCard(service);
                grid.appendChild(serviceCard);
            });
        }

        // Render services by category
        function renderServicesByCategory(categoryName) {
            const grid = document.getElementById('services-grid');
            const loading = document.getElementById('loading');

            loading.style.display = 'none';
            grid.innerHTML = '';

            // Apply grid columns setting
            const gridColumns = config.settings?.grid_columns || 'auto';
            if (gridColumns === 'auto') {
                grid.removeAttribute('data-columns');
            } else {
                grid.setAttribute('data-columns', gridColumns);
            }

            if (!config.services || config.services.length === 0) {
                grid.innerHTML = '<p>No services configured. Go to Config tab to add services.</p>';
                return;
            }

            // Filter services by category
            const categoryServices = config.services.filter(s => s.category === categoryName);

            if (categoryServices.length === 0) {
                grid.innerHTML = `<p>No services in ${categoryName} category.</p>`;
                return;
            }

            // Render each service using the shared createServiceCard function
            categoryServices.forEach(service => {
                const card = createServiceCard(service);
                grid.appendChild(card);
            });
        }

        // Render settings editor
        function renderSettingsEditor() {
            const editor = document.getElementById('settings-editor');

            if (!config.settings) {
                config.settings = {};
            }

            const settings = config.settings;

            editor.innerHTML = `
                <div class="settings-editor">
                    <div class="settings-grid">
                        <div class="form-group">
                            <label>Hostname</label>
                            <input type="text" value="${settings.hostname || ''}" onchange="updateSetting('hostname', this.value)">
                        </div>
                        <div class="form-group">
                            <label>SSH User</label>
                            <input type="text" value="${settings.ssh_user || ''}" onchange="updateSetting('ssh_user', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Title</label>
                            <input type="text" value="${settings.title || ''}" onchange="updateSetting('title', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Dashboard Subtitle</label>
                            <input type="text" value="${settings.subtitle || ''}" onchange="updateSetting('subtitle', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Auto-Refresh (minutes)</label>
                            <input type="number" value="${settings.auto_refresh_minutes || 5}" onchange="updateSetting('auto_refresh_minutes', parseInt(this.value))">
                        </div>
                        <div class="form-group">
                            <label>CSV Path</label>
                            <input type="text" value="${settings.csv_path || '/scripts/port-mappings.csv'}" onchange="updateSetting('csv_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Backup Path</label>
                            <input type="text" value="${settings.backup_path || '/scripts/backups'}" onchange="updateSetting('backup_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>PowerShell Script Path</label>
                            <input type="text" value="${settings.powershell_script_path || '/scripts/Update-DockerPortProxy.ps1'}" onchange="updateSetting('powershell_script_path', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Grid Columns</label>
                            <select onchange="updateSetting('grid_columns', this.value)" value="${settings.grid_columns || 'auto'}">
                                <option value="auto" ${!settings.grid_columns || settings.grid_columns === 'auto' ? 'selected' : ''}>Auto (responsive)</option>
                                <option value="1" ${settings.grid_columns === '1' ? 'selected' : ''}>1 column</option>
                                <option value="2" ${settings.grid_columns === '2' ? 'selected' : ''}>2 columns</option>
                                <option value="3" ${settings.grid_columns === '3' ? 'selected' : ''}>3 columns</option>
                                <option value="4" ${settings.grid_columns === '4' ? 'selected' : ''}>4 columns</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        // Update setting
        function updateSetting(key, value) {
            if (!config.settings) {
                config.settings = {};
            }
            config.settings[key] = value;
        }

        // Render CSV settings in Systems tab
        function renderCSVSettings() {
            if (!config.settings) {
                config.settings = {};
            }

            const settings = config.settings;
            const csvPath = settings.csv_path || '/mnt/c/scripts/port-mappings.csv';
            const backupPath = settings.backup_path || '/mnt/c/scripts/backups';

            document.getElementById('csv-path').value = csvPath;
            document.getElementById('csv-backup-path').value = backupPath;
        }

        // Update CSV settings from inputs
        function updateCSVSettings() {
            const csvPath = document.getElementById('csv-path').value.trim();
            const backupPath = document.getElementById('csv-backup-path').value.trim();

            if (!config.settings) {
                config.settings = {};
            }

            config.settings.csv_path = csvPath;
            config.settings.backup_path = backupPath;
        }

        // Render categories editor
        function renderCategoriesEditor() {
            const editor = document.getElementById('categories-editor');
            editor.innerHTML = '';

            if (!config.categories) {
                config.categories = [];
            }

            config.categories.forEach((category, index) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category-editor';
                categoryDiv.innerHTML = `
                    <div class="category-editor-content">
                        <span class="category-drag-handle" title="Drag to reorder">⋮⋮</span>
                        <div class="form-group" style="flex: 0 0 140px; margin: 0;">
                            <label>Icon</label>
                            <div class="emoji-icon-input-wrapper">
                                <input type="text" id="category-icon-${index}" value="${category.icon || ''}" onchange="updateCategory(${index}, 'icon', this.value)" placeholder="📁" style="width: 50px;">
                                <button type="button" class="btn btn-secondary" style="padding: 0.4rem 0.6rem; font-size: 0.8rem;" onclick="openEmojiPicker('category-icon-${index}')">📝</button>
                            </div>
                        </div>
                        <div class="form-group" style="flex: 1; margin: 0;">
                            <label>Name</label>
                            <input type="text" value="${category.name || ''}" onchange="updateCategory(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group" style="flex: 2; margin: 0;">
                            <label>Description</label>
                            <input type="text" value="${category.description || ''}" onchange="updateCategory(${index}, 'description', this.value)">
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="removeCategory(${index})">🗑</button>
                `;
                editor.appendChild(categoryDiv);
            });
        }

        // Render services grouped by category in config
        function renderServicesByCategory_Config() {
            const container = document.getElementById('services-by-category');
            container.innerHTML = '';

            if (!config.categories || config.categories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem; text-align: center;">No categories defined. Please add categories above first.</p>';
                return;
            }

            if (!config.services) {
                config.services = [];
            }

            // Apply grid columns setting to config services view
            const gridColumns = config.settings?.grid_columns || 'auto';

            config.categories.forEach(category => {
                const categorySection = document.createElement('div');
                categorySection.className = 'category-section';
                categorySection.dataset.category = category.name;

                // Add drop zone for services
                categorySection.addEventListener('dragover', handleServiceDragOver);
                categorySection.addEventListener('drop', handleServiceDrop);

                const categoryServices = config.services.filter(s => s.category === category.name);

                categorySection.innerHTML = `
                    <div class="category-section-header">
                        <h3 style="margin: 0;">${category.name}</h3>
                        <span style="color: var(--text-secondary); font-size: 0.9rem;">${categoryServices.length} service(s)</span>
                    </div>
                    <div class="services-category-grid ${categoryServices.length === 0 ? 'empty' : ''}" data-category="${category.name}" ${gridColumns !== 'auto' ? `style="grid-template-columns: repeat(${gridColumns}, 1fr);"` : ''}>
                        ${categoryServices.length === 0 ? 'Drop services here or add new service' : ''}
                    </div>
                `;

                const grid = categorySection.querySelector('.services-category-grid');

                categoryServices.forEach((service, localIndex) => {
                    const serviceIndex = config.services.findIndex(s => s === service);
                    const serviceDiv = document.createElement('div');
                    serviceDiv.className = 'service-list-item';
                    serviceDiv.dataset.index = serviceIndex;
                    serviceDiv.dataset.category = category.name;

                    serviceDiv.innerHTML = `
                        <div class="service-list-icon">${service.icon || '🔧'}</div>
                        <div class="service-list-info">
                            <div class="service-list-name">${service.name || 'Service'}</div>
                            <div class="service-list-url">${service.url || ''}</div>
                        </div>
                        <div class="service-list-actions">
                            <button class="btn btn-primary" onclick="openServiceEditor(${serviceIndex}); event.stopPropagation();">Edit</button>
                            <button class="btn btn-danger" onclick="removeService(${serviceIndex}); event.stopPropagation();">Delete</button>
                        </div>
                    `;
                    grid.appendChild(serviceDiv);
                });

                // Add "Add Service" button for this category
                const addButton = document.createElement('button');
                addButton.className = 'btn btn-primary';
                addButton.style.marginTop = '1rem';
                addButton.textContent = `+ Add Service to ${category.name}`;
                addButton.onclick = () => addServiceToCategory(category.name);
                categorySection.appendChild(addButton);

                container.appendChild(categorySection);
            });
        }

        // Legacy function kept for compatibility - now calls the new function
        function renderConfigEditor() {
            renderServicesByCategory_Config();
        }

        // Category management
        function updateCategory(index, property, value) {
            config.categories[index][property] = value;
        }

        function addCategory() {
            if (!config.categories) {
                config.categories = [];
            }
            config.categories.push({
                name: 'New Category',
                description: 'Category description'
            });
            renderCategoriesEditor();
        }

        async function removeCategory(index) {
            const category = config.categories[index];
            const hasServices = config.services && config.services.some(s => s.category === category.name);

            if (hasServices) {
                await customAlert(
                    `Cannot delete category "${category.name}" because it contains services. Please move or delete the services first.`,
                    'Cannot Delete Category',
                    'error'
                );
                return;
            }

            const confirmed = await customConfirm(
                `Are you sure you want to delete category "${category.name}"?`,
                'Delete Category',
                'warning'
            );

            if (confirmed) {
                config.categories.splice(index, 1);
                renderCategoriesEditor();
            }
        }

        // Service drag and drop between categories
        let draggedServiceIndex = null;

        function handleServiceDragStart(e) {
            draggedServiceIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleServiceDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
        }

        function handleServiceDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleServiceDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCategory = e.currentTarget.dataset.category;
            if (!targetCategory) return false;

            if (draggedServiceIndex !== null && config.services[draggedServiceIndex]) {
                // Update service category
                config.services[draggedServiceIndex].category = targetCategory;

                // Re-render services
                renderServicesByCategory_Config();
            }

            return false;
        }

        // Old render config editor - kept for backward compatibility
        function renderConfigEditor_OLD() {
            const editor = document.getElementById('services-editor');
            if (!editor) return;
            editor.innerHTML = '';

            if (!config.services) {
                config.services = [];
            }

            config.services.forEach((service, index) => {
                const serviceDiv = document.createElement('div');
                serviceDiv.className = 'service-editor';
                serviceDiv.draggable = true;
                serviceDiv.dataset.index = index;

                // Add drag event listeners
                serviceDiv.addEventListener('dragstart', handleDragStart);
                serviceDiv.addEventListener('dragend', handleDragEnd);
                serviceDiv.addEventListener('dragover', handleDragOver);
                serviceDiv.addEventListener('drop', handleDrop);
                serviceDiv.addEventListener('dragleave', handleDragLeave);

                serviceDiv.innerHTML = `
                    <div class="service-editor-header">
                        <div style="display: flex; align-items: center;">
                            <span class="drag-handle" title="Drag to reorder">⋮⋮</span>
                            <h4 style="margin: 0;">Service ${index + 1}</h4>
                        </div>
                    </div>
                    <div class="service-editor-fields">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" value="${service.name || ''}" onchange="updateService(${index}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Icon (emoji)</label>
                            <input type="text" value="${service.icon || ''}" onchange="updateService(${index}, 'icon', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>URL</label>
                            <input type="text" value="${service.url || ''}" onchange="updateService(${index}, 'url', this.value)">
                        </div>
                        <div class="form-group field-full-width">
                            <label>Description</label>
                            <textarea onchange="updateService(${index}, 'description', this.value)">${service.description || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Port</label>
                            <input type="number" value="${service.port || ''}" onchange="updateService(${index}, 'port', parseInt(this.value))">
                        </div>
                        <div class="form-group-inline">
                            <label>
                                <input type="checkbox" ${service.local ? 'checked' : ''} onchange="updateService(${index}, 'local', this.checked)">
                                Local service
                            </label>
                        </div>
                        <div class="field-full-width">
                            <button class="btn btn-danger" onclick="removeService(${index})" style="width: 100%; margin-top: 0.5rem;">🗑 Delete</button>
                        </div>
                    </div>
                `;
                editor.appendChild(serviceDiv);
            });
        }

        // Update service property
        function updateService(index, property, value) {
            config.services[index][property] = value;
        }

        // Add new service
        function addService() {
            if (!config.services) {
                config.services = [];
            }

            // Default to first category if available
            const defaultCategory = config.categories && config.categories.length > 0
                ? config.categories[0].name
                : 'Uncategorized';

            config.services.push({
                name: 'New Service',
                icon: '🔧',
                url: 'http://localhost:8080',
                description: 'Service description',
                port: 8080,
                local: true,
                status: 'running',
                category: defaultCategory
            });

            renderServicesByCategory_Config();
        }

        // Add new service to specific category
        function addServiceToCategory(categoryName) {
            if (!config.services) {
                config.services = [];
            }

            // Open the modal for adding new service
            openServiceEditor(null);

            // Pre-select the category
            document.getElementById('service-category').value = categoryName;
        }

        // Remove service
        async function removeService(index) {
            const confirmed = await customConfirm(
                'Are you sure you want to delete this service?',
                'Delete Service',
                'warning'
            );

            if (confirmed) {
                config.services.splice(index, 1);
                renderServicesByCategory_Config();
            }
        }

        // Drag and Drop handlers
        let draggedIndex = null;

        function handleDragStart(e) {
            draggedIndex = parseInt(e.currentTarget.dataset.index);
            e.currentTarget.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            e.currentTarget.classList.remove('dragging');
            document.querySelectorAll('.service-editor').forEach(el => {
                el.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const dropIndex = parseInt(e.currentTarget.dataset.index);

            if (draggedIndex !== null && draggedIndex !== dropIndex) {
                // Reorder the services array
                const draggedService = config.services[draggedIndex];
                config.services.splice(draggedIndex, 1);
                config.services.splice(dropIndex, 0, draggedService);

                // Re-render the config editor
                renderConfigEditor();
            }

            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        // Save configuration
        async function saveConfig() {
            const messageDiv = document.getElementById('config-message');

            try {
                // Update CSV settings from inputs before saving
                updateCSVSettings();

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to save configuration');
                }

                showToast('Configuration saved successfully!', 'success');

                // Re-render config editors with current config
                try {
                    renderSettingsEditor();
                    renderCategoriesEditor();
                    renderCSVSettings();
                    renderServicesByCategory_Config();

                    // Update category tabs in main view
                    if (config.categories) {
                        renderCategoryTabs();
                    }

                    // Update dashboard title and subtitle live
                    if (config.dashboard_title) {
                        document.getElementById('pageTitle').textContent = config.dashboard_title;
                    }
                    if (config.dashboard_subtitle) {
                        document.getElementById('pageSubtitle').textContent = config.dashboard_subtitle;
                    }
                } catch (renderError) {
                    console.error('Error re-rendering:', renderError);
                }
            } catch (error) {
                console.error('Error saving config:', error);
                showToast(`Failed to save configuration: ${error.message}`, 'error');
            }
        }

        // Generate CSV to server
        async function generateCSV() {
            try {
                // Update CSV settings from inputs before generating
                updateCSVSettings();

                const response = await fetch('/api/csv/generate', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to generate CSV');

                const result = await response.json();

                if (result.success) {
                    let message = `CSV generated successfully at ${result.csv_path}`;
                    if (result.backup_created) {
                        message += '. Backup created.';
                    }
                    showToast(message, 'success', 5000);
                } else {
                    throw new Error(result.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error generating CSV:', error);
                showToast(`Failed to generate CSV: ${error.message}`, 'error');
            }
        }

        // Download CSV file
        async function downloadCSV() {
            try {
                playSound('click');

                // Open download URL in new window
                window.open('/api/csv/download', '_blank');

                showToast('CSV download started', 'success');
            } catch (error) {
                console.error('Error downloading CSV:', error);
                showToast(`Failed to download CSV: ${error.message}`, 'error');
            }
        }

        // Browse folders on server
        // Folder Browser
        let currentBrowserPath = '/';
        let currentBrowserInputId = null;

        async function browseFolders(inputId) {
            playSound('click');
            currentBrowserInputId = inputId;

            // Get the current value from the input to use as starting path
            const input = document.getElementById(inputId);
            let startPath = input.value.trim();

            // If it's a full path with filename, extract directory
            if (startPath && !startPath.endsWith('/')) {
                startPath = startPath.substring(0, startPath.lastIndexOf('/'));
            }

            currentBrowserPath = startPath || '/';

            // Show modal
            document.getElementById('folder-browser-modal').classList.remove('hidden');

            // Load initial directory
            await loadDirectory(currentBrowserPath);
        }

        async function loadDirectory(path) {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Loading...</div>';

            try {
                const response = await fetch('/api/browse-folders', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to load directory');
                }

                const data = await response.json();
                currentBrowserPath = data.current_path;

                // Update path display
                document.getElementById('browser-current-path').textContent = currentBrowserPath;

                // Enable/disable parent button
                const parentBtn = document.getElementById('browser-parent-btn');
                if (data.parent_path) {
                    parentBtn.disabled = false;
                    parentBtn.style.opacity = '1';
                } else {
                    parentBtn.disabled = true;
                    parentBtn.style.opacity = '0.5';
                }

                // Render directory list
                if (data.directories.length === 0) {
                    folderList.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No subdirectories found</div>';
                } else {
                    folderList.innerHTML = '';
                    data.directories.forEach(dir => {
                        const folderItem = document.createElement('div');
                        folderItem.className = 'folder-item' + (dir.accessible ? '' : ' disabled');
                        folderItem.innerHTML = `
                            <div class="folder-icon">📁</div>
                            <div class="folder-name">${dir.name}</div>
                            ${!dir.accessible ? '<div style="color: var(--text-secondary); font-size: 0.85rem;">🔒 No access</div>' : ''}
                        `;

                        if (dir.accessible) {
                            folderItem.onclick = () => navigateToFolder(dir.path);
                        }

                        folderList.appendChild(folderItem);
                    });
                }
            } catch (error) {
                console.error('Error loading directory:', error);
                folderList.innerHTML = `<div style="text-align: center; padding: 2rem; color: var(--danger-text);">${error.message}</div>`;
            }
        }

        async function navigateToFolder(path) {
            playSound('click');
            await loadDirectory(path);
        }

        async function navigateToParent() {
            playSound('click');
            const parentPath = currentBrowserPath.substring(0, currentBrowserPath.lastIndexOf('/'));
            await loadDirectory(parentPath || '/');
        }

        async function refreshBrowser() {
            playSound('click');
            await loadDirectory(currentBrowserPath);
        }

        function selectCurrentFolder() {
            playSound('click');
            if (currentBrowserInputId) {
                const input = document.getElementById(currentBrowserInputId);

                // If the input expects a full path with filename, just set the directory
                // The user can append the filename afterward
                if (input.value.includes('.')) {
                    // Extract filename from current value
                    const filename = input.value.substring(input.value.lastIndexOf('/') + 1);
                    input.value = currentBrowserPath + '/' + filename;
                } else {
                    // Just set the directory
                    input.value = currentBrowserPath;
                }
            }
            closeFolderBrowser();
        }

        function closeFolderBrowser(event) {
            if (event && event.target !== event.currentTarget) return;
            playSound('click');
            document.getElementById('folder-browser-modal').classList.add('hidden');
            currentBrowserInputId = null;
        }

        // AI Tools - Image Generation
        let currentGeneratedImage = null;

        // Character counter for prompt
        document.addEventListener('DOMContentLoaded', function() {
            const promptInput = document.getElementById('ai-image-prompt');
            if (promptInput) {
                promptInput.addEventListener('input', function() {
                    document.getElementById('prompt-char-count').textContent = this.value.length;
                });
            }
        });

        async function generateAIImage() {
            const promptInput = document.getElementById('ai-image-prompt');
            const description = promptInput.value.trim();

            if (!description) {
                showToast('Please enter a description for the image', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            const statusDiv = document.getElementById('generation-status');
            const previewDiv = document.getElementById('generated-image-preview');

            try {
                // Disable button and show status
                generateBtn.disabled = true;
                generateBtn.textContent = '⏳ Generating...';
                statusDiv.textContent = 'Generating image with AI... This may take a moment.';
                previewDiv.style.display = 'none';

                playSound('click');

                const response = await fetch('/api/tools/generate-image', {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ description })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to generate image');
                }

                const data = await response.json();
                currentGeneratedImage = data.filename;

                // Show preview
                const previewImage = document.getElementById('preview-image');
                previewImage.src = data.url + '?t=' + Date.now();
                previewDiv.style.display = 'block';

                statusDiv.textContent = '';
                showToast('Image generated successfully!', 'success');

                // Reload gallery
                await loadImageGallery();

            } catch (error) {
                console.error('Image generation error:', error);
                statusDiv.textContent = '';
                showToast(`Failed to generate image: ${error.message}`, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '🎨 Generate Image';
            }
        }

        async function loadImageGallery() {
            const container = document.getElementById('image-gallery-container');
            const emptyDiv = document.getElementById('gallery-empty');

            try {
                playSound('click');

                const response = await fetch('/api/tools/images', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load images');
                }

                const images = await response.json();

                if (images.length === 0) {
                    container.innerHTML = '';
                    container.style.display = 'none';
                    emptyDiv.style.display = 'block';
                    return;
                }

                container.style.display = 'grid';
                emptyDiv.style.display = 'none';
                container.innerHTML = '';

                images.forEach(image => {
                    const imageCard = document.createElement('div');
                    imageCard.style.cssText = 'background: var(--input-bg); border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px var(--shadow); transition: transform 0.2s;';
                    imageCard.onmouseenter = function() { this.style.transform = 'translateY(-4px)'; };
                    imageCard.onmouseleave = function() { this.style.transform = 'translateY(0)'; };

                    const img = document.createElement('img');
                    img.src = image.url + '?t=' + Date.now();
                    img.style.cssText = 'width: 100%; height: 200px; object-fit: cover; cursor: pointer;';
                    img.title = 'Click to copy prompt and regenerate';
                    img.onclick = () => copyDescriptionToInput(image.description, image.url);

                    const infoDiv = document.createElement('div');
                    infoDiv.style.cssText = 'padding: 1rem;';

                    // Show description/prompt if available
                    if (image.description) {
                        const descDiv = document.createElement('div');
                        const truncated = image.description.length > 80
                            ? image.description.substring(0, 80) + '...'
                            : image.description;
                        descDiv.textContent = truncated;
                        descDiv.title = image.description; // Full text on hover
                        descDiv.style.cssText = 'font-size: 0.9rem; color: var(--text-primary); margin-bottom: 0.75rem; font-style: italic; line-height: 1.4;';
                        infoDiv.appendChild(descDiv);
                    }

                    const dateSpan = document.createElement('div');
                    dateSpan.textContent = new Date(image.created).toLocaleString();
                    dateSpan.style.cssText = 'font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;';

                    const sizeSpan = document.createElement('div');
                    sizeSpan.textContent = `${(image.size / 1024).toFixed(1)} KB`;
                    sizeSpan.style.cssText = 'font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;';

                    const actionsDiv = document.createElement('div');
                    actionsDiv.style.cssText = 'display: flex; gap: 0.5rem;';

                    const downloadBtn = document.createElement('button');
                    downloadBtn.className = 'btn btn-secondary';
                    downloadBtn.textContent = '📥';
                    downloadBtn.style.cssText = 'flex: 1; padding: 0.5rem;';
                    downloadBtn.onclick = () => downloadImage(image.filename, image.url);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.textContent = '🗑️';
                    deleteBtn.style.cssText = 'flex: 1; padding: 0.5rem;';
                    deleteBtn.onclick = () => deleteImage(image.filename);

                    actionsDiv.appendChild(downloadBtn);
                    actionsDiv.appendChild(deleteBtn);

                    infoDiv.appendChild(dateSpan);
                    infoDiv.appendChild(sizeSpan);
                    infoDiv.appendChild(actionsDiv);

                    imageCard.appendChild(img);
                    imageCard.appendChild(infoDiv);

                    container.appendChild(imageCard);
                });

            } catch (error) {
                console.error('Error loading gallery:', error);
                showToast('Failed to load image gallery', 'error');
            }
        }

        function copyDescriptionToInput(description, imageUrl) {
            playSound('click');

            if (description) {
                // Copy description to the input field
                const promptInput = document.getElementById('ai-image-prompt');
                promptInput.value = description;

                // Update character count
                const charCount = document.getElementById('prompt-char-count');
                charCount.textContent = description.length;

                // Show the image in preview
                currentGeneratedImage = imageUrl.split('/').pop();
                const previewDiv = document.getElementById('generated-image-preview');
                const previewImage = document.getElementById('preview-image');
                previewImage.src = imageUrl + '?t=' + Date.now();
                previewDiv.style.display = 'block';

                // Scroll to top to show the input field
                document.getElementById('tools-tab').scrollTop = 0;

                showToast('Prompt copied! Ready to regenerate or modify.', 'success');
            } else {
                // If no description, just open the image
                window.open(imageUrl, '_blank');
            }
        }

        function viewImageFullscreen(imageUrl) {
            playSound('click');
            window.open(imageUrl, '_blank');
        }

        function downloadGeneratedImage() {
            if (currentGeneratedImage) {
                downloadImage(currentGeneratedImage, `/api/tools/images/${currentGeneratedImage}`);
            }
        }

        async function downloadImage(filename, url) {
            try {
                playSound('click');

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to download image');
                }

                const blob = await response.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(downloadUrl);

                showToast('Image downloaded!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showToast('Failed to download image', 'error');
            }
        }

        async function deleteImage(filename) {
            const confirmed = await customConfirm(
                `Are you sure you want to delete this image? This action cannot be undone.`,
                'Delete Image',
                'warning'
            );

            if (!confirmed) return;

            try {
                playSound('click');

                const response = await fetch(`/api/tools/images/${filename}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to delete image');
                }

                showToast('Image deleted successfully', 'success');

                // Reload gallery
                await loadImageGallery();

                // Hide preview if it's the deleted image
                if (currentGeneratedImage === filename) {
                    document.getElementById('generated-image-preview').style.display = 'none';
                    currentGeneratedImage = null;
                }

            } catch (error) {
                console.error('Delete error:', error);
                showToast(`Failed to delete image: ${error.message}`, 'error');
            }
        }

        // User Management
        let currentEditingUser = null;
        let usersData = null;

        async function loadUsers() {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load users');

                const users = await response.json();
                console.log('Loaded users:', users); // Debug
                renderUsersList(users);
            } catch (error) {
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = '<p style="color: var(--text-primary);">Failed to load users. Please try refreshing.</p>';
            }
        }

        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            container.innerHTML = '';

            if (!users || users.length === 0) {
                container.innerHTML = '<p>No users found. Add a user to get started.</p>';
                return;
            }

            users.forEach(user => {
                const card = document.createElement('div');
                card.className = 'user-card';
                const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ');
                card.innerHTML = `
                    <div class="user-info">
                        <div class="user-name">${user.username}</div>
                        ${fullName ? `<div class="user-email" style="font-weight: 500;">${fullName}</div>` : ''}
                        ${user.email ? `<div class="user-email">${user.email}</div>` : ''}
                        <div class="user-roles">
                            ${user.roles.map(role => `<span class="role-badge">${role}</span>`).join('')}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-secondary" onclick="editUser('${user.username}')">✏️ Edit</button>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">🗑️ Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function loadRoles() {
            try {
                const response = await fetch('/api/roles', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load roles');

                const roles = await response.json();
                usersData = { roles };
                renderRolesEditor(roles);
            } catch (error) {
                console.error('Error loading roles:', error);
                document.getElementById('roles-editor').innerHTML = '<p class="error">Failed to load roles</p>';
            }
        }

        function renderRolesEditor(roles) {
            const container = document.getElementById('roles-editor');
            container.innerHTML = '';

            if (!roles || roles.length === 0) {
                container.innerHTML = '<p style="color: var(--text-primary);">No roles defined.</p>';
                return;
            }

            roles.forEach((role, roleIndex) => {
                const card = document.createElement('div');
                card.className = 'role-editor-card';

                // Get all available categories
                const availableCategories = config?.categories || [];

                card.innerHTML = `
                    <div class="role-header">
                        <div>
                            <div class="role-name">${role.name}</div>
                            <div class="role-description">${role.description || ''}</div>
                        </div>
                        <div>
                            <button class="btn btn-danger" onclick="deleteRole('${role.name}')">🗑️ Delete</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <input type="checkbox"
                                   ${role.is_admin ? 'checked' : ''}
                                   onchange="updateRoleAdmin('${role.name}', this.checked)">
                            <span>Administrator (can access Config tab)</span>
                        </label>
                    </div>
                    <div>
                        <strong>Access to categories:</strong>
                        <div style="margin-top: 0.75rem;" id="role-${roleIndex}-categories">
                            ${availableCategories.map(cat => {
                                const isChecked = role.categories && role.categories.includes(cat.name);
                                return `
                                    <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <input type="checkbox"
                                               value="${cat.name}"
                                               ${isChecked ? 'checked' : ''}
                                               onchange="updateRoleCategory('${role.name}', '${cat.name}', this.checked)">
                                        <span>${cat.name}</span>
                                    </label>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add single Save Changes button after all roles
            const saveButtonDiv = document.createElement('div');
            saveButtonDiv.style.marginTop = '1.5rem';
            saveButtonDiv.style.textAlign = 'center';
            saveButtonDiv.innerHTML = `
                <button class="btn btn-primary" onclick="saveRoleChanges()" style="padding: 0.75rem 2rem; font-size: 1rem;">
                    💾 Save All Changes
                </button>
                <div id="role-save-message" style="margin-top: 1rem;"></div>
            `;
            container.appendChild(saveButtonDiv);
        }

        function updateRoleCategory(roleName, categoryName, isChecked) {
            if (!usersData || !usersData.roles) return;

            const role = usersData.roles.find(r => r.name === roleName);
            if (!role) return;

            if (!role.categories) role.categories = [];

            if (isChecked) {
                if (!role.categories.includes(categoryName)) {
                    role.categories.push(categoryName);
                }
            } else {
                role.categories = role.categories.filter(c => c !== categoryName);
            }
        }

        function updateRoleAdmin(roleName, isAdmin) {
            if (!usersData || !usersData.roles) return;

            const role = usersData.roles.find(r => r.name === roleName);
            if (!role) return;

            role.is_admin = isAdmin;
        }

        async function saveRoleChanges() {
            const messageDiv = document.getElementById('role-save-message');
            messageDiv.innerHTML = '';

            try {
                // Save to users.yaml through backend
                const response = await fetch('/api/roles', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ roles: usersData.roles })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to save roles');
                }

                messageDiv.innerHTML = '<div class="success">✅ All role changes saved successfully!</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 5000);
                loadRoles();
            } catch (error) {
                console.error('Error saving roles:', error);
                messageDiv.innerHTML = `<div class="error">❌ Failed to save changes: ${error.message}</div>`;
            }
        }

        function showAddUserModal() {
            currentEditingUser = null;
            document.getElementById('user-modal-title').textContent = 'Add New User';
            document.getElementById('user-username').value = '';
            document.getElementById('user-username').disabled = false;
            document.getElementById('user-first-name').value = '';
            document.getElementById('user-last-name').value = '';
            document.getElementById('user-email').value = '';
            document.getElementById('user-password').value = '';
            document.getElementById('user-modal-message').innerHTML = '';

            // Load roles checkboxes
            renderRolesCheckboxes([]);

            document.getElementById('user-modal').classList.remove('hidden');
        }

        async function editUser(username) {
            try {
                const response = await fetch('/api/users', {
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Failed to load user');

                const users = await response.json();
                const user = users.find(u => u.username === username);

                if (!user) throw new Error('User not found');

                currentEditingUser = username;
                document.getElementById('user-modal-title').textContent = 'Edit User';
                document.getElementById('user-username').value = user.username;
                document.getElementById('user-username').disabled = true;
                document.getElementById('user-first-name').value = user.first_name || '';
                document.getElementById('user-last-name').value = user.last_name || '';
                document.getElementById('user-email').value = user.email || '';
                document.getElementById('user-password').value = '';
                document.getElementById('user-password').placeholder = 'Leave empty to keep current password';
                document.getElementById('user-modal-message').innerHTML = '';

                // Load roles checkboxes with current user roles
                renderRolesCheckboxes(user.roles);

                document.getElementById('user-modal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading user:', error);
                await customAlert('Failed to load user details', 'Error', 'error');
            }
        }

        function renderRolesCheckboxes(selectedRoles) {
            const container = document.getElementById('user-roles-checkboxes');
            container.innerHTML = '';

            if (!usersData || !usersData.roles) {
                container.innerHTML = '<p>Loading roles...</p>';
                return;
            }

            usersData.roles.forEach(role => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '0.5rem';
                label.style.marginBottom = '0.5rem';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = role.name;
                checkbox.checked = selectedRoles.includes(role.name);

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(`${role.name} - ${role.description || ''}`));
                container.appendChild(label);
            });
        }

        async function saveUser() {
            const username = document.getElementById('user-username').value.trim();
            const firstName = document.getElementById('user-first-name').value.trim();
            const lastName = document.getElementById('user-last-name').value.trim();
            const email = document.getElementById('user-email').value.trim();
            const password = document.getElementById('user-password').value;
            const messageDiv = document.getElementById('user-modal-message');

            // Get selected roles
            const checkboxes = document.querySelectorAll('#user-roles-checkboxes input[type="checkbox"]:checked');
            const roles = Array.from(checkboxes).map(cb => cb.value);

            // Validation
            if (!username) {
                messageDiv.innerHTML = '<div class="error">Username is required</div>';
                return;
            }

            if (!currentEditingUser && !password) {
                messageDiv.innerHTML = '<div class="error">Password is required for new users</div>';
                return;
            }

            if (roles.length === 0) {
                messageDiv.innerHTML = '<div class="error">Please select at least one role</div>';
                return;
            }

            try {
                const userData = {
                    username,
                    first_name: firstName,
                    last_name: lastName,
                    email,
                    roles
                };

                if (password) {
                    userData.password = password;
                }

                const url = currentEditingUser ? `/api/users/${currentEditingUser}` : '/api/users';
                const method = currentEditingUser ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(userData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save user');
                }

                closeUserModal();
                loadUsers();

                await customAlert(
                    `User ${currentEditingUser ? 'updated' : 'created'} successfully`,
                    'Success',
                    'success'
                );
            } catch (error) {
                console.error('Error saving user:', error);
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function deleteUser(username) {
            const confirmed = await customConfirm(
                `Are you sure you want to delete user "${username}"?`,
                'Delete User',
                'warning'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/users/${username}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }

                await customAlert('User deleted successfully', 'Success', 'success');
                loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                await customAlert(`Failed to delete user: ${error.message}`, 'Error', 'error');
            }
        }

        function closeUserModal(event) {
            // If event is passed, only close if clicking on the background
            if (event && event.target && event.target.id !== 'user-modal') return;
            document.getElementById('user-modal').classList.add('hidden');
            document.getElementById('user-password').placeholder = '';
            document.getElementById('user-modal-message').innerHTML = '';
            currentEditingUser = null;
        }

        // Role Management Functions
        function showAddRoleModal() {
            document.getElementById('role-modal-title').textContent = 'Add New Role';
            document.getElementById('role-name').value = '';
            document.getElementById('role-description').value = '';
            document.getElementById('role-is-admin').checked = false;
            document.getElementById('role-modal-message').innerHTML = '';

            // Load categories checkboxes
            renderCategoriesCheckboxes([]);

            document.getElementById('role-modal').classList.remove('hidden');
        }

        function renderCategoriesCheckboxes(selectedCategories = []) {
            const container = document.getElementById('role-categories-checkboxes');
            container.innerHTML = '';

            if (!config || !config.categories || config.categories.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-size: 0.9rem;">No categories available</p>';
                return;
            }

            config.categories.forEach(category => {
                const isChecked = selectedCategories.includes(category.name);
                const checkbox = document.createElement('label');
                checkbox.style.display = 'flex';
                checkbox.style.alignItems = 'center';
                checkbox.style.gap = '0.5rem';
                checkbox.style.marginBottom = '0.5rem';
                checkbox.innerHTML = `
                    <input type="checkbox" value="${category.name}" ${isChecked ? 'checked' : ''}>
                    <span>${category.name}</span>
                `;
                container.appendChild(checkbox);
            });
        }

        async function saveRole() {
            const name = document.getElementById('role-name').value.trim();
            const description = document.getElementById('role-description').value.trim();
            const isAdmin = document.getElementById('role-is-admin').checked;
            const messageDiv = document.getElementById('role-modal-message');

            // Get selected categories
            const checkboxes = document.querySelectorAll('#role-categories-checkboxes input[type="checkbox"]:checked');
            const categories = Array.from(checkboxes).map(cb => cb.value);

            if (!name) {
                messageDiv.innerHTML = '<div class="error">Role name is required</div>';
                return;
            }

            try {
                const response = await fetch('/api/roles', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ name, description, categories, is_admin: isAdmin })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to save role');
                }

                closeRoleModal();
                loadRoles();

                await customAlert('Role created successfully!', 'Success', 'success');
            } catch (error) {
                console.error('Error saving role:', error);
                messageDiv.innerHTML = `<div class="error">${error.message}</div>`;
            }
        }

        async function deleteRole(roleName) {
            // Prevent deletion of Admins role
            if (roleName === 'Admins') {
                await customAlert('Cannot delete the Admins role. This role is required for system administration.', 'Error', 'error');
                return;
            }

            const confirmed = await customConfirm(
                `Are you sure you want to delete the role "${roleName}"?`,
                'Delete Role',
                'warning'
            );

            if (!confirmed) return;

            try {
                const response = await fetch(`/api/roles/${roleName}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete role');
                }

                await customAlert('Role deleted successfully', 'Success', 'success');
                loadRoles();
            } catch (error) {
                console.error('Error deleting role:', error);
                await customAlert(`Failed to delete role: ${error.message}`, 'Error', 'error');
            }
        }

        function closeRoleModal(event) {
            if (event && event.target.id !== 'role-modal') return;
            document.getElementById('role-modal').classList.add('hidden');
        }

        // Service Modal Functions
        let currentServiceIndex = null;

        function openServiceEditor(serviceIndex) {
            currentServiceIndex = serviceIndex;
            const service = serviceIndex !== null ? config.services[serviceIndex] : null;
            const modal = document.getElementById('service-modal');

            // Populate category dropdown
            const categorySelect = document.getElementById('service-category');
            categorySelect.innerHTML = '<option value="">Select category...</option>';
            if (config.categories) {
                config.categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.name;
                    option.textContent = cat.name;
                    if (service && service.category === cat.name) {
                        option.selected = true;
                    }
                    categorySelect.appendChild(option);
                });
            }

            // Populate fields
            if (service) {
                document.getElementById('service-modal-title').textContent = 'Edit Service';
                document.getElementById('service-name').value = service.name || '';
                document.getElementById('service-icon').value = service.icon || '';
                document.getElementById('service-url').value = service.url || '';
                document.getElementById('service-description').value = service.description || '';
                document.getElementById('service-port').value = service.port || '';
                document.getElementById('service-local').checked = service.local || false;
            } else {
                document.getElementById('service-modal-title').textContent = 'Add Service';
                document.getElementById('service-name').value = '';
                document.getElementById('service-icon').value = '🔧';
                document.getElementById('service-url').value = 'http://localhost:8080';
                document.getElementById('service-description').value = '';
                document.getElementById('service-port').value = '8080';
                document.getElementById('service-local').checked = true;
            }

            modal.classList.remove('hidden');
        }

        function closeServiceModal(event) {
            if (event && event.target.id !== 'service-modal') return;
            document.getElementById('service-modal').classList.add('hidden');
            currentServiceIndex = null;
        }

        function saveService() {
            const name = document.getElementById('service-name').value.trim();
            const icon = document.getElementById('service-icon').value.trim();
            const url = document.getElementById('service-url').value.trim();
            const description = document.getElementById('service-description').value.trim();
            const port = parseInt(document.getElementById('service-port').value) || null;
            const category = document.getElementById('service-category').value;
            const local = document.getElementById('service-local').checked;

            if (!name || !url || !category) {
                showToast('Please fill in all required fields', 'error');
                return;
            }

            const serviceData = {
                name,
                icon: icon || '🔧',
                url,
                description,
                port,
                category,
                local,
                status: 'running'
            };

            if (currentServiceIndex !== null) {
                // Update existing service
                config.services[currentServiceIndex] = serviceData;
            } else {
                // Add new service
                if (!config.services) {
                    config.services = [];
                }
                config.services.push(serviceData);
            }

            closeServiceModal();
            renderServicesByCategory_Config();
            showToast('Service saved. Don\'t forget to save configuration!', 'info');
        }

        // UI/UX Enhancement Functions

        // Favorites system (localStorage)
        function getFavorites() {
            const favs = localStorage.getItem('favorites');
            return favs ? JSON.parse(favs) : [];
        }

        function toggleFavorite(serviceName, event) {
            event.preventDefault();
            event.stopPropagation();

            const favorites = getFavorites();
            const index = favorites.indexOf(serviceName);

            if (index === -1) {
                favorites.push(serviceName);
                playSound('favorite');
            } else {
                favorites.splice(index, 1);
            }

            localStorage.setItem('favorites', JSON.stringify(favorites));

            // Re-render current view
            if (document.getElementById('favourites-tab-btn')?.classList.contains('active')) {
                // If favourites tab is active, re-render it
                renderFavouritesServices();
            } else if (window.currentCategory) {
                // Otherwise re-render the current category
                renderServicesByCategory(window.currentCategory);
            }
        }

        function isFavorite(serviceName) {
            return getFavorites().includes(serviceName);
        }

        // Search and filter
        function filterServices() {
            const searchTerm = document.getElementById('search-box')?.value.toLowerCase() || '';
            const favoritesOnly = document.getElementById('favorites-only')?.checked || false;
            const grid = document.getElementById('services-grid');
            const cards = grid.querySelectorAll('.service-card');

            cards.forEach(card => {
                const serviceName = card.querySelector('.service-title')?.textContent.toLowerCase() || '';
                const serviceUrl = card.querySelector('.service-url')?.textContent.toLowerCase() || '';
                const serviceDesc = card.querySelector('.service-description')?.textContent.toLowerCase() || '';

                const matchesSearch = !searchTerm ||
                    serviceName.includes(searchTerm) ||
                    serviceUrl.includes(searchTerm) ||
                    serviceDesc.includes(searchTerm);

                const matchesFavorites = !favoritesOnly || card.querySelector('.favorited');

                card.style.display = (matchesSearch && matchesFavorites) ? '' : 'none';
            });
        }

        // Toast Notifications
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;

            const icon = {
                success: '✓',
                error: '✗',
                info: 'ℹ'
            }[type] || 'ℹ';

            toast.innerHTML = `
                <span style="font-size: 1.2rem;">${icon}</span>
                <span style="flex: 1;">${message}</span>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => {
                    if (toast.parentElement) {
                        container.removeChild(toast);
                    }
                }, 300); // Match animation duration
            }, duration);
        }

        // Settings panel
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('open');
            playSound('click');
        }

        // Sound effects - default to true if not set
        let soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        let audioContext = null;

        // Initialize AudioContext on first user interaction
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log('AudioContext not supported');
                }
            }
            // Resume if suspended (required by some browsers)
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        const sounds = {
            click: () => playTone(800, 0.1, 0.05),
            favorite: () => playTone(1200, 0.2, 0.1),
            success: () => playTone(1000, 0.3, 0.15),
            error: () => playTone(400, 0.3, 0.15)
        };

        function playTone(frequency, duration, volume) {
            if (!soundEnabled) return;

            try {
                initAudioContext();
                if (!audioContext) return;

                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                gainNode.gain.value = volume;

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                console.log('Sound playback error:', e);
            }
        }

        function playSound(soundName) {
            if (sounds[soundName]) sounds[soundName]();
        }

        function toggleSound() {
            soundEnabled = document.getElementById('sound-enabled').checked;
            localStorage.setItem('soundEnabled', soundEnabled);
            if (soundEnabled) {
                initAudioContext();
                playSound('click');
            }
        }

        // Ambient background sound
        let ambientSound = null;
        let ambientOscillators = [];
        let ambientNoiseNode = null;
        let ambientMasterGain = null;
        let ambientVolume = parseFloat(localStorage.getItem('ambientVolume') || '15') / 100;

        function stopAmbientSound() {
            ambientOscillators.forEach(item => {
                try {
                    if (item && typeof item.stop === 'function') {
                        item.stop();
                    }
                    if (item && typeof item.disconnect === 'function') {
                        item.disconnect();
                    }
                } catch(e) {}
            });
            ambientOscillators = [];

            if (ambientNoiseNode) {
                try {
                    ambientNoiseNode.disconnect();
                } catch(e) {}
                ambientNoiseNode = null;
            }
        }

        function createWhiteNoise() {
            if (!audioContext) initAudioContext();
            if (!audioContext) return null;

            const bufferSize = 2 * audioContext.sampleRate;
            const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = noiseBuffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }

            const whiteNoise = audioContext.createBufferSource();
            whiteNoise.buffer = noiseBuffer;
            whiteNoise.loop = true;
            return whiteNoise;
        }

        function playAmbientSound(type) {
            stopAmbientSound();

            if (type === 'none') return;

            initAudioContext();
            if (!audioContext) return;

            try {
                ambientMasterGain = audioContext.createGain();
                ambientMasterGain.gain.value = ambientVolume;
                ambientMasterGain.connect(audioContext.destination);

                if (type === 'rain') {
                    // Rain: filtered white noise
                    const noise = createWhiteNoise();
                    const filter = audioContext.createBiquadFilter();
                    filter.type = 'bandpass';
                    filter.frequency.value = 1000;
                    filter.Q.value = 0.5;

                    noise.connect(filter);
                    filter.connect(ambientMasterGain);
                    noise.start(0);
                    ambientOscillators.push(noise);
                    ambientNoiseNode = noise;

                } else if (type === 'ocean') {
                    // Ocean: Realistic multi-layered ocean waves

                    // 1. Deep ocean rumble - bass foundation
                    const deepRumble = createWhiteNoise();
                    const deepFilter = audioContext.createBiquadFilter();
                    deepFilter.type = 'lowpass';
                    deepFilter.frequency.value = 120;
                    deepFilter.Q.value = 2;
                    const deepGain = audioContext.createGain();
                    deepGain.gain.value = 0.25;

                    // Slow breathing LFO for depth
                    const deepLFO = audioContext.createOscillator();
                    deepLFO.frequency.value = 0.08;
                    const deepLFOGain = audioContext.createGain();
                    deepLFOGain.gain.value = 0.04;
                    deepLFO.connect(deepLFOGain);
                    deepLFOGain.connect(deepGain.gain);

                    deepRumble.connect(deepFilter);
                    deepFilter.connect(deepGain);
                    deepGain.connect(ambientMasterGain);
                    deepRumble.start(0);
                    deepLFO.start(0);
                    ambientOscillators.push(deepRumble, deepLFO);

                    // 2. Mid-range wave washing - main wave sound
                    const midWave = createWhiteNoise();
                    const midFilter = audioContext.createBiquadFilter();
                    midFilter.type = 'bandpass';
                    midFilter.frequency.value = 600;
                    midFilter.Q.value = 1.5;
                    const midGain = audioContext.createGain();
                    midGain.gain.value = 0.15;

                    // Wave swell LFO - rises and falls like waves
                    const waveLFO = audioContext.createOscillator();
                    waveLFO.frequency.value = 0.15;
                    const waveLFOGain = audioContext.createGain();
                    waveLFOGain.gain.value = 150;
                    waveLFO.connect(waveLFOGain);
                    waveLFOGain.connect(midFilter.frequency);

                    // Amplitude modulation for wave surge
                    const waveAmpLFO = audioContext.createOscillator();
                    waveAmpLFO.frequency.value = 0.12;
                    const waveAmpLFOGain = audioContext.createGain();
                    waveAmpLFOGain.gain.value = 0.08;
                    waveAmpLFO.connect(waveAmpLFOGain);
                    waveAmpLFOGain.connect(midGain.gain);

                    midWave.connect(midFilter);
                    midFilter.connect(midGain);
                    midGain.connect(ambientMasterGain);
                    midWave.start(0);
                    waveLFO.start(0);
                    waveAmpLFO.start(0);
                    ambientOscillators.push(midWave, waveLFO, waveAmpLFO);

                    // 3. High-frequency foam/spray
                    const foam = createWhiteNoise();
                    const foamFilter = audioContext.createBiquadFilter();
                    foamFilter.type = 'highpass';
                    foamFilter.frequency.value = 2500;
                    const foamGain = audioContext.createGain();
                    foamGain.gain.value = 0.06;

                    // Subtle foam variation
                    const foamLFO = audioContext.createOscillator();
                    foamLFO.frequency.value = 0.25;
                    const foamLFOGain = audioContext.createGain();
                    foamLFOGain.gain.value = 0.02;
                    foamLFO.connect(foamLFOGain);
                    foamLFOGain.connect(foamGain.gain);

                    foam.connect(foamFilter);
                    foamFilter.connect(foamGain);
                    foamGain.connect(ambientMasterGain);
                    foam.start(0);
                    foamLFO.start(0);
                    ambientOscillators.push(foam, foamLFO);

                    // 4. Periodic wave crashes
                    function createWaveCrash() {
                        const crash = createWhiteNoise();
                        const crashFilter = audioContext.createBiquadFilter();
                        crashFilter.type = 'bandpass';
                        crashFilter.frequency.value = 800 + Math.random() * 400;
                        crashFilter.Q.value = 2;

                        const crashGain = audioContext.createGain();
                        const now = audioContext.currentTime;
                        const duration = 1.5 + Math.random() * 1;

                        // Wave crash envelope: slow rise, peak, slow decay
                        crashGain.gain.setValueAtTime(0, now);
                        crashGain.gain.linearRampToValueAtTime(0.25, now + 0.3);
                        crashGain.gain.linearRampToValueAtTime(0.30, now + 0.6);
                        crashGain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                        crash.connect(crashFilter);
                        crashFilter.connect(crashGain);
                        crashGain.connect(ambientMasterGain);

                        crash.start(now);
                        crash.stop(now + duration + 0.1);
                    }

                    // Vary crash timing for natural feel
                    function scheduleWaveCrash() {
                        if (ambientOscillators.length > 0) {
                            createWaveCrash();
                        }
                    }

                    const crashInterval = setInterval(scheduleWaveCrash, 4000 + Math.random() * 3000);
                    ambientOscillators.push({ stop: () => clearInterval(crashInterval) });

                    ambientNoiseNode = deepRumble;

                } else if (type === 'forest') {
                    // Forest: realistic bird chirping with multiple birds
                    // Background ambience
                    const ambientNoise = createWhiteNoise();
                    const ambientFilter = audioContext.createBiquadFilter();
                    ambientFilter.type = 'highpass';
                    ambientFilter.frequency.value = 500;
                    const ambientGain = audioContext.createGain();
                    ambientGain.gain.value = 0.05;

                    ambientNoise.connect(ambientFilter);
                    ambientFilter.connect(ambientGain);
                    ambientGain.connect(ambientMasterGain);
                    ambientNoise.start(0);
                    ambientOscillators.push(ambientNoise);

                    // Create chirping birds with random intervals
                    function createBirdChirp() {
                        const chirpGain = audioContext.createGain();
                        const chirpFilter = audioContext.createBiquadFilter();
                        chirpFilter.type = 'bandpass';
                        chirpFilter.Q.value = 10;

                        // Random bird frequencies (2000-5000 Hz)
                        const baseFreq = 2000 + Math.random() * 3000;
                        chirpFilter.frequency.value = baseFreq;

                        const oscillator = audioContext.createOscillator();
                        oscillator.type = 'sine';
                        oscillator.frequency.value = baseFreq;

                        // Chirp envelope: quick attack, quick decay
                        const now = audioContext.currentTime;
                        chirpGain.gain.setValueAtTime(0, now);
                        chirpGain.gain.linearRampToValueAtTime(0.15, now + 0.01);
                        chirpGain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);

                        // Frequency sweep for chirp effect
                        oscillator.frequency.setValueAtTime(baseFreq, now);
                        oscillator.frequency.exponentialRampToValueAtTime(baseFreq * 1.5, now + 0.05);
                        oscillator.frequency.exponentialRampToValueAtTime(baseFreq * 0.8, now + 0.15);

                        oscillator.connect(chirpFilter);
                        chirpFilter.connect(chirpGain);
                        chirpGain.connect(ambientMasterGain);

                        oscillator.start(now);
                        oscillator.stop(now + 0.2);
                    }

                    // Chirp at random intervals (3-6 seconds)
                    const chirpInterval = setInterval(() => {
                        if (ambientOscillators.length > 0) {
                            createBirdChirp();
                            // Sometimes double chirp
                            if (Math.random() > 0.7) {
                                setTimeout(createBirdChirp, 300 + Math.random() * 500);
                            }
                        }
                    }, 3000 + Math.random() * 3000);
                    ambientOscillators.push({ stop: () => clearInterval(chirpInterval) });

                } else if (type === 'cafe') {
                    // Cafe: layered realistic coffee shop ambience

                    // 1. Low-frequency background rumble (general ambience)
                    const ambience = createWhiteNoise();
                    const ambienceFilter = audioContext.createBiquadFilter();
                    ambienceFilter.type = 'lowpass';
                    ambienceFilter.frequency.value = 300;
                    const ambienceGain = audioContext.createGain();
                    ambienceGain.gain.value = 0.15;

                    ambience.connect(ambienceFilter);
                    ambienceFilter.connect(ambienceGain);
                    ambienceGain.connect(ambientMasterGain);
                    ambience.start(0);
                    ambientOscillators.push(ambience);

                    // 2. Mid-frequency chatter (voices)
                    const chatter = createWhiteNoise();
                    const chatterFilter = audioContext.createBiquadFilter();
                    chatterFilter.type = 'bandpass';
                    chatterFilter.frequency.value = 1200;
                    chatterFilter.Q.value = 1.5;
                    const chatterGain = audioContext.createGain();
                    chatterGain.gain.value = 0.2;

                    // Add LFO to chatter for natural variation
                    const chatterLFO = audioContext.createOscillator();
                    chatterLFO.frequency.value = 0.3;
                    const chatterLFOGain = audioContext.createGain();
                    chatterLFOGain.gain.value = 0.05;
                    chatterLFO.connect(chatterLFOGain);
                    chatterLFOGain.connect(chatterGain.gain);

                    chatter.connect(chatterFilter);
                    chatterFilter.connect(chatterGain);
                    chatterGain.connect(ambientMasterGain);
                    chatter.start(0);
                    chatterLFO.start(0);
                    ambientOscillators.push(chatter, chatterLFO);

                    // 3. Espresso machine - multi-layered
                    // Machine motor hum
                    const machineHum = audioContext.createOscillator();
                    machineHum.type = 'sawtooth';
                    machineHum.frequency.value = 120;
                    const machineHumGain = audioContext.createGain();
                    machineHumGain.gain.value = 0.015;

                    machineHum.connect(machineHumGain);
                    machineHumGain.connect(ambientMasterGain);
                    machineHum.start(0);
                    ambientOscillators.push(machineHum);

                    // Machine pump pulse
                    const machinePump = audioContext.createOscillator();
                    machinePump.type = 'square';
                    machinePump.frequency.value = 4;
                    const machinePumpGain = audioContext.createGain();
                    machinePumpGain.gain.value = 0.01;

                    machinePump.connect(machinePumpGain);
                    machinePumpGain.connect(machineHumGain.gain);
                    machinePump.start(0);
                    ambientOscillators.push(machinePump);

                    // 4. Steam hissing (occasional)
                    function createSteamHiss() {
                        const steam = createWhiteNoise();
                        const steamFilter = audioContext.createBiquadFilter();
                        steamFilter.type = 'highpass';
                        steamFilter.frequency.value = 4000;
                        const steamGain = audioContext.createGain();

                        const now = audioContext.currentTime;
                        steamGain.gain.setValueAtTime(0, now);
                        steamGain.gain.linearRampToValueAtTime(0.15, now + 0.2);
                        steamGain.gain.linearRampToValueAtTime(0.15, now + 1.5);
                        steamGain.gain.exponentialRampToValueAtTime(0.01, now + 2);

                        steam.connect(steamFilter);
                        steamFilter.connect(steamGain);
                        steamGain.connect(ambientMasterGain);
                        steam.start(now);
                        steam.stop(now + 2.1);
                    }

                    const steamInterval = setInterval(() => {
                        if (ambientOscillators.length > 0 && Math.random() > 0.7) {
                            createSteamHiss();
                        }
                    }, 15000 + Math.random() * 15000);
                    ambientOscillators.push({ stop: () => clearInterval(steamInterval) });

                    // 5. Cups and dishes clinks
                    function createClink() {
                        const clinkGain = audioContext.createGain();
                        const clinkFilter = audioContext.createBiquadFilter();
                        clinkFilter.type = 'bandpass';
                        clinkFilter.frequency.value = 3500;
                        clinkFilter.Q.value = 5;

                        const oscillator = audioContext.createOscillator();
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 3000 + Math.random() * 2000;

                        const now = audioContext.currentTime;
                        clinkGain.gain.setValueAtTime(0, now);
                        clinkGain.gain.linearRampToValueAtTime(0.12, now + 0.003);
                        clinkGain.gain.exponentialRampToValueAtTime(0.01, now + 0.12);

                        oscillator.connect(clinkFilter);
                        clinkFilter.connect(clinkGain);
                        clinkGain.connect(ambientMasterGain);

                        oscillator.start(now);
                        oscillator.stop(now + 0.15);
                    }

                    const clinkInterval = setInterval(() => {
                        if (ambientOscillators.length > 0 && Math.random() > 0.5) {
                            createClink();
                            // Sometimes multiple clinks in succession
                            if (Math.random() > 0.6) {
                                setTimeout(createClink, 150 + Math.random() * 400);
                            }
                        }
                    }, 5000 + Math.random() * 5000);
                    ambientOscillators.push({ stop: () => clearInterval(clinkInterval) });

                } else if (type === 'fireplace') {
                    // Fireplace: realistic multi-layered crackling fire with wood burning

                    // 1. Deep rumble - base fire roar
                    const rumble = createWhiteNoise();
                    const rumbleFilter = audioContext.createBiquadFilter();
                    rumbleFilter.type = 'lowpass';
                    rumbleFilter.frequency.value = 120;
                    rumbleFilter.Q.value = 2;
                    const rumbleGain = audioContext.createGain();
                    rumbleGain.gain.value = 0.18;

                    // LFO for breathing/flickering effect
                    const rumbleLFO = audioContext.createOscillator();
                    rumbleLFO.frequency.value = 0.15 + Math.random() * 0.1;
                    const rumbleLFOGain = audioContext.createGain();
                    rumbleLFOGain.gain.value = 0.05;
                    rumbleLFO.connect(rumbleLFOGain);
                    rumbleLFOGain.connect(rumbleGain.gain);

                    rumble.connect(rumbleFilter);
                    rumbleFilter.connect(rumbleGain);
                    rumbleGain.connect(ambientMasterGain);
                    rumble.start(0);
                    rumbleLFO.start(0);
                    ambientOscillators.push(rumble);
                    ambientOscillators.push(rumbleLFO);

                    // 2. Wood burning hiss/sizzle - high frequency continuous
                    const hiss = createWhiteNoise();
                    const hissFilter = audioContext.createBiquadFilter();
                    hissFilter.type = 'highpass';
                    hissFilter.frequency.value = 3000;
                    const hissFilter2 = audioContext.createBiquadFilter();
                    hissFilter2.type = 'lowpass';
                    hissFilter2.frequency.value = 8000;
                    const hissGain = audioContext.createGain();
                    hissGain.gain.value = 0.06;

                    // Subtle LFO for hiss variation
                    const hissLFO = audioContext.createOscillator();
                    hissLFO.frequency.value = 0.3;
                    const hissLFOGain = audioContext.createGain();
                    hissLFOGain.gain.value = 0.02;
                    hissLFO.connect(hissLFOGain);
                    hissLFOGain.connect(hissGain.gain);

                    hiss.connect(hissFilter);
                    hissFilter.connect(hissFilter2);
                    hissFilter2.connect(hissGain);
                    hissGain.connect(ambientMasterGain);
                    hiss.start(0);
                    hissLFO.start(0);
                    ambientOscillators.push(hiss);
                    ambientOscillators.push(hissLFO);

                    // 3. Mid-range fire crackle layer
                    const midCrackle = createWhiteNoise();
                    const midFilter = audioContext.createBiquadFilter();
                    midFilter.type = 'bandpass';
                    midFilter.frequency.value = 600;
                    midFilter.Q.value = 3;
                    const midGain = audioContext.createGain();
                    midGain.gain.value = 0.10;

                    midCrackle.connect(midFilter);
                    midFilter.connect(midGain);
                    midGain.connect(ambientMasterGain);
                    midCrackle.start(0);
                    ambientOscillators.push(midCrackle);

                    // 4. Wood crackles - sharp, varied frequency
                    function createCrackle(intensity = 1, pan = 0) {
                        const crackle = createWhiteNoise();
                        const crackleFilter = audioContext.createBiquadFilter();
                        crackleFilter.type = 'bandpass';

                        const baseFreq = 600 + Math.random() * 2500;
                        crackleFilter.frequency.value = baseFreq;
                        crackleFilter.Q.value = 4 + Math.random() * 6;

                        const crackleGain = audioContext.createGain();
                        const now = audioContext.currentTime;
                        const duration = 0.04 + Math.random() * 0.12;
                        const maxGain = (0.15 + Math.random() * 0.25) * intensity;

                        // Stereo panning
                        const panner = audioContext.createStereoPanner();
                        panner.pan.value = pan;

                        // Very sharp attack, exponential decay
                        crackleGain.gain.setValueAtTime(0, now);
                        crackleGain.gain.linearRampToValueAtTime(maxGain, now + 0.005);
                        crackleGain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                        crackle.connect(crackleFilter);
                        crackleFilter.connect(crackleGain);
                        crackleGain.connect(panner);
                        panner.connect(ambientMasterGain);

                        crackle.start(now);
                        crackle.stop(now + duration + 0.01);
                    }

                    // 5. Heavy pops - deeper, louder
                    function createPop(pan = 0) {
                        const pop = createWhiteNoise();
                        const popFilter = audioContext.createBiquadFilter();
                        popFilter.type = 'bandpass';
                        popFilter.frequency.value = 150 + Math.random() * 350;
                        popFilter.Q.value = 10;

                        const popGain = audioContext.createGain();
                        const now = audioContext.currentTime;
                        const duration = 0.10 + Math.random() * 0.15;

                        // Stereo panning
                        const panner = audioContext.createStereoPanner();
                        panner.pan.value = pan;

                        // Explosive attack, slow decay
                        popGain.gain.setValueAtTime(0, now);
                        popGain.gain.linearRampToValueAtTime(0.45, now + 0.003);
                        popGain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                        pop.connect(popFilter);
                        popFilter.connect(popGain);
                        popGain.connect(panner);
                        panner.connect(ambientMasterGain);

                        pop.start(now);
                        pop.stop(now + duration + 0.01);
                    }

                    // 6. Ember pops - high pitched small crackles
                    function createEmber() {
                        const ember = createWhiteNoise();
                        const emberFilter = audioContext.createBiquadFilter();
                        emberFilter.type = 'highpass';
                        emberFilter.frequency.value = 2000 + Math.random() * 3000;
                        emberFilter.Q.value = 15;

                        const emberGain = audioContext.createGain();
                        const now = audioContext.currentTime;
                        const duration = 0.02 + Math.random() * 0.05;

                        // Quick tick sound
                        emberGain.gain.setValueAtTime(0, now);
                        emberGain.gain.linearRampToValueAtTime(0.12, now + 0.002);
                        emberGain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                        ember.connect(emberFilter);
                        emberFilter.connect(emberGain);
                        emberGain.connect(ambientMasterGain);

                        ember.start(now);
                        ember.stop(now + duration + 0.01);
                    }

                    // 7. Log shifts - deep rumbles
                    function createLogShift() {
                        const shift = createWhiteNoise();
                        const shiftFilter = audioContext.createBiquadFilter();
                        shiftFilter.type = 'lowpass';
                        shiftFilter.frequency.value = 80 + Math.random() * 150;
                        shiftFilter.Q.value = 3;

                        const shiftGain = audioContext.createGain();
                        const now = audioContext.currentTime;
                        const duration = 0.3 + Math.random() * 0.4;

                        // Slow rise and fall
                        shiftGain.gain.setValueAtTime(0, now);
                        shiftGain.gain.linearRampToValueAtTime(0.25, now + 0.15);
                        shiftGain.gain.exponentialRampToValueAtTime(0.01, now + duration);

                        shift.connect(shiftFilter);
                        shiftFilter.connect(shiftGain);
                        shiftGain.connect(ambientMasterGain);

                        shift.start(now);
                        shift.stop(now + duration + 0.01);
                    }

                    // Scheduling functions with dynamic timing
                    let nextCrackleTime = 200;
                    function scheduleCrackles() {
                        if (ambientOscillators.length > 0) {
                            // Multiple crackles in bursts with random panning
                            const burstSize = 1 + Math.floor(Math.random() * 5);
                            for (let i = 0; i < burstSize; i++) {
                                setTimeout(() => {
                                    const pan = (Math.random() - 0.5) * 0.6; // Stereo spread
                                    createCrackle(1 - i * 0.1, pan);
                                }, i * (25 + Math.random() * 60));
                            }
                            // Vary interval for natural feel
                            nextCrackleTime = 250 + Math.random() * 500;
                        }
                    }

                    function schedulePops() {
                        if (ambientOscillators.length > 0) {
                            const pan = (Math.random() - 0.5) * 0.8;
                            createPop(pan);
                        }
                    }

                    function scheduleEmbers() {
                        if (ambientOscillators.length > 0) {
                            // Multiple small ember pops
                            const emberCount = 1 + Math.floor(Math.random() * 3);
                            for (let i = 0; i < emberCount; i++) {
                                setTimeout(() => createEmber(), i * (50 + Math.random() * 100));
                            }
                        }
                    }

                    function scheduleLogShift() {
                        if (ambientOscillators.length > 0) {
                            createLogShift();
                        }
                    }

                    // Interval scheduling with varied timing
                    function crackleLoop() {
                        scheduleCrackles();
                        const delay = nextCrackleTime;
                        const timeout = setTimeout(crackleLoop, delay);
                        ambientOscillators.push({ stop: () => clearTimeout(timeout) });
                    }
                    crackleLoop();

                    const popInterval = setInterval(schedulePops, 1800 + Math.random() * 2500);
                    ambientOscillators.push({ stop: () => clearInterval(popInterval) });

                    const emberInterval = setInterval(scheduleEmbers, 800 + Math.random() * 1200);
                    ambientOscillators.push({ stop: () => clearInterval(emberInterval) });

                    const logShiftInterval = setInterval(scheduleLogShift, 8000 + Math.random() * 12000);
                    ambientOscillators.push({ stop: () => clearInterval(logShiftInterval) });
                }
            } catch (e) {
                console.log('Ambient sound error:', e);
            }
        }

        function changeAmbientSound(type) {
            localStorage.setItem('ambientSound', type);
            playAmbientSound(type);
        }

        function changeAmbientVolume(value) {
            ambientVolume = parseFloat(value) / 100;
            localStorage.setItem('ambientVolume', value);
            document.getElementById('ambient-volume-display').textContent = value + '%';

            // Update existing ambient sound volume
            if (ambientMasterGain) {
                ambientMasterGain.gain.value = ambientVolume;
            }
        }

        function changeParticleTime(time) {
            localStorage.setItem('particleTime', time);
            initParticles();
        }

        function changeParticleSeason(season) {
            localStorage.setItem('particleSeason', season);
            initParticles();
        }

        // Initialize audio context on first click anywhere
        document.addEventListener('click', function initAudio() {
            if (soundEnabled) {
                initAudioContext();
            }
        }, { once: true });

        // Emoji Picker
        let currentEmojiTargetInput = null;

        const emojiData = {
            smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '🤣', '😂', '🙂', '🙃', '😉', '😊', '😇', '🥰', '😍', '🤩', '😘', '😗', '☺️', '😚', '😙', '😋', '😛', '😜', '🤪', '😝', '🤑', '🤗', '🤭', '🤫', '🤔', '🤐'],
            objects: ['⚙️', '🔧', '🔨', '🛠️', '⚡', '💻', '🖥️', '⌨️', '🖱️', '🖨️', '💾', '💿', '📀', '🧮', '📱', '📞', '☎️', '📟', '📠', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '📦', '📫', '📪', '📬'],
            symbols: ['⭐', '✨', '💫', '🌟', '✅', '❌', '❗', '❓', '⚠️', '🚫', '💯', '🔥', '💥', '✔️', '➕', '➖', '✖️', '➗', '♾️', '🔴', '🟠', '🟡', '🟢', '🔵', '🟣', '🟤', '⚫', '⚪', '🟥', '🟧', '🟨', '🟩'],
            nature: ['🌿', '🍀', '🎋', '🎍', '🌱', '🌲', '🌳', '🌴', '🌵', '🌾', '🌷', '🌸', '🌹', '🥀', '🌺', '🌻', '🌼', '🌽', '🍇', '🍈', '🍉', '🍊', '🍋', '🍌', '🍍', '🥭', '🍎', '🍏', '🍐', '🍑', '🍒', '🍓']
        };

        function openEmojiPicker(inputId) {
            currentEmojiTargetInput = inputId;
            document.getElementById('emoji-picker-modal').classList.remove('hidden');
            showEmojiCategory('smileys');
            playSound('click');
        }

        function closeEmojiPicker(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('emoji-picker-modal').classList.add('hidden');
            currentEmojiTargetInput = null;
        }

        function showEmojiCategory(category) {
            // Update active button
            document.querySelectorAll('.emoji-cat-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Render emojis
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = '';

            const emojis = emojiData[category] || [];
            emojis.forEach(emoji => {
                const emojiDiv = document.createElement('div');
                emojiDiv.className = 'emoji-item';
                emojiDiv.textContent = emoji;
                emojiDiv.onclick = () => selectEmoji(emoji);
                grid.appendChild(emojiDiv);
            });
        }

        function selectEmoji(emoji) {
            if (currentEmojiTargetInput) {
                const input = document.getElementById(currentEmojiTargetInput);
                if (input) {
                    input.value = emoji;
                    // Trigger onchange event
                    const event = new Event('change');
                    input.dispatchEvent(event);
                }
            }
            closeEmojiPicker();
            playSound('success');
        }

        // Background particles - time and season aware
        function initParticles() {
            const container = document.getElementById('bg-particles');
            if (!container) return;

            container.innerHTML = '';
            const particlesEnabled = document.getElementById('particles-enabled')?.checked !== false;

            if (!particlesEnabled) return;

            const now = new Date();
            const hour = now.getHours();
            const month = now.getMonth(); // 0-11

            // Get time of day setting
            const particleTime = localStorage.getItem('particleTime') || 'auto';
            let timeClass = 'afternoon';

            if (particleTime === 'auto') {
                // Automatic - determine by current time
                if (hour >= 5 && hour < 9) timeClass = 'morning';
                else if (hour >= 9 && hour < 17) timeClass = 'afternoon';
                else if (hour >= 17 && hour < 21) timeClass = 'evening';
                else timeClass = 'night';
            } else {
                timeClass = particleTime;
            }

            // Get season setting
            const particleSeason = localStorage.getItem('particleSeason') || 'auto';
            let seasonClass = '';

            if (particleSeason === 'auto') {
                // Automatic - determine by current month
                if (month >= 11 || month <= 1) seasonClass = 'winter'; // Winter
                else if (month >= 2 && month <= 4) seasonClass = 'spring'; // Spring
                else if (month >= 5 && month <= 7) seasonClass = 'summer'; // Summer
                else if (month >= 8 && month <= 10) seasonClass = 'autumn'; // Autumn
            } else {
                seasonClass = particleSeason;
            }

            // Time of day affects particle count and intensity
            let baseCount = 40;
            let intensityMultiplier = 1.0;

            if (timeClass === 'morning') {
                baseCount = 45;
                intensityMultiplier = 1.2;
            } else if (timeClass === 'afternoon') {
                baseCount = 40;
                intensityMultiplier = 1.0;
            } else if (timeClass === 'evening') {
                baseCount = 50;
                intensityMultiplier = 1.3;
            } else if (timeClass === 'night') {
                baseCount = 60;
                intensityMultiplier = 1.5;
            }

            // Season affects additional particles
            let seasonBonus = 0;
            if (seasonClass === 'winter') seasonBonus = 30;
            else if (seasonClass === 'summer') seasonBonus = 20;
            else if (seasonClass === 'spring') seasonBonus = 10;
            else if (seasonClass === 'autumn') seasonBonus = 15;

            const particleCount = baseCount + seasonBonus;

            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');

                // Special case: Summer night shows moons instead of suns
                let specialClass = '';
                if (seasonClass === 'summer' && timeClass === 'night') {
                    specialClass = 'moon';
                }

                particle.className = `particle ${timeClass} ${seasonClass} ${specialClass}`;

                // Size varies by season - increased for better visibility
                let size;
                if (seasonClass === 'winter') size = Math.random() * 12 + 8; // Snowflakes: 8-20px
                else if (seasonClass === 'summer' && timeClass === 'night') size = Math.random() * 12 + 10; // Moons: 10-22px
                else if (seasonClass === 'summer') size = Math.random() * 8 + 6; // Sun lights: 6-14px (reduced)
                else if (seasonClass === 'autumn') size = Math.random() * 18 + 12; // Leaves: 12-30px
                else size = Math.random() * 10 + 6; // Spring water drops: 6-16px

                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';

                // Animation duration varies by season and time
                let duration;
                if (seasonClass === 'winter') duration = Math.random() * 10 + 15; // Slow falling
                else if (seasonClass === 'summer') duration = Math.random() * 6 + 8; // Medium wave
                else if (seasonClass === 'autumn') duration = Math.random() * 8 + 12; // Gentle fall
                else duration = Math.random() * 8 + 10; // Spring float

                // Apply time intensity to speed
                duration = duration / intensityMultiplier;

                particle.style.animationDuration = duration + 's';
                particle.style.animationDelay = Math.random() * 5 + 's';

                container.appendChild(particle);
            }
        }

        function toggleParticles() {
            initParticles();
        }

        // Cockroach easter egg
        let cockroachEnabled = localStorage.getItem('cockroachEnabled') !== 'false'; // Default: enabled
        let cockroachTimer = null;

        function createCockroachSound() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            // Create a high-pitched squeaky scream
            const now = audioContext.currentTime;
            const duration = 0.3 + Math.random() * 0.2;

            // Oscillator 1: High-pitched squeak (primary scream)
            const osc1 = audioContext.createOscillator();
            osc1.type = 'square';
            const startFreq = 2000 + Math.random() * 1000;
            osc1.frequency.setValueAtTime(startFreq, now);
            osc1.frequency.exponentialRampToValueAtTime(startFreq * 1.3, now + 0.05);
            osc1.frequency.exponentialRampToValueAtTime(startFreq * 0.7, now + duration);

            // Oscillator 2: Lower screech for depth
            const osc2 = audioContext.createOscillator();
            osc2.type = 'sawtooth';
            osc2.frequency.setValueAtTime(startFreq * 0.6, now);
            osc2.frequency.exponentialRampToValueAtTime(startFreq * 0.8, now + duration);

            // Filter for more realistic insect sound
            const filter = audioContext.createBiquadFilter();
            filter.type = 'bandpass';
            filter.frequency.value = 2500;
            filter.Q.value = 3;

            // Gain envelope
            const gain = audioContext.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(0.08, now + 0.02); // Not too loud
            gain.gain.linearRampToValueAtTime(0.06, now + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration);

            // Connect nodes
            osc1.connect(filter);
            osc2.connect(filter);
            filter.connect(gain);
            gain.connect(audioContext.destination);

            // Start and stop
            osc1.start(now);
            osc2.start(now);
            osc1.stop(now + duration);
            osc2.stop(now + duration);
        }

        function createCockroach() {
            const cockroach = document.createElement('div');
            cockroach.className = 'cockroach';

            // Random vertical position (anywhere on screen)
            const topPosition = Math.random() * (window.innerHeight - 50);
            cockroach.style.top = topPosition + 'px';

            // Random direction (left or right)
            const goingLeft = Math.random() > 0.5;
            const duration = 2 + Math.random() * 2; // 2-4 seconds to cross screen

            cockroach.innerHTML = `
                <div class="cockroach-body">
                    <div class="cockroach-head">
                        <div class="cockroach-antenna left"></div>
                        <div class="cockroach-antenna right"></div>
                    </div>
                    <div class="cockroach-legs">
                        <div class="cockroach-leg left-1"></div>
                        <div class="cockroach-leg left-2"></div>
                        <div class="cockroach-leg left-3"></div>
                        <div class="cockroach-leg right-1"></div>
                        <div class="cockroach-leg right-2"></div>
                        <div class="cockroach-leg right-3"></div>
                    </div>
                </div>
            `;

            // Apply animation
            if (goingLeft) {
                cockroach.style.animation = `cockroach-scuttle-left ${duration}s linear`;
            } else {
                cockroach.style.animation = `cockroach-scuttle-right ${duration}s linear`;
            }

            // Add wiggle to legs
            const legs = cockroach.querySelectorAll('.cockroach-leg');
            legs.forEach(leg => {
                leg.style.animation = `cockroach-legs-wiggle 0.1s infinite`;
            });

            document.body.appendChild(cockroach);

            // Play scream sound
            createCockroachSound();

            // Remove after animation completes
            setTimeout(() => {
                cockroach.remove();
            }, duration * 1000);
        }

        function spawnCockroaches(count = 1) {
            if (!cockroachEnabled) return;

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    createCockroach();
                }, i * (200 + Math.random() * 300)); // Stagger spawns
            }
        }

        function startRandomCockroaches() {
            // Clear existing timer
            if (cockroachTimer) {
                clearTimeout(cockroachTimer);
            }

            if (!cockroachEnabled) return;

            // Schedule next cockroach event (random interval: 30-90 seconds)
            const nextSpawn = 30000 + Math.random() * 60000;
            cockroachTimer = setTimeout(() => {
                // Spawn 1-3 cockroaches
                const count = 1 + Math.floor(Math.random() * 3);
                spawnCockroaches(count);
                startRandomCockroaches(); // Schedule next event
            }, nextSpawn);
        }

        function toggleCockroaches() {
            cockroachEnabled = document.getElementById('cockroach-enabled')?.checked !== false;
            localStorage.setItem('cockroachEnabled', cockroachEnabled);

            if (cockroachEnabled) {
                startRandomCockroaches();
            } else {
                if (cockroachTimer) {
                    clearTimeout(cockroachTimer);
                    cockroachTimer = null;
                }
            }
        }

        // Cockroach click trigger (bottom-left corner)
        let cockroachClickCount = 0;
        let cockroachClickTimer = null;

        function initCockroachTrigger() {
            const trigger = document.getElementById('cockroach-trigger');
            if (!trigger) return;

            trigger.addEventListener('click', () => {
                if (!cockroachEnabled) return;

                cockroachClickCount++;

                // Reset count after 2 seconds
                if (cockroachClickTimer) clearTimeout(cockroachClickTimer);
                cockroachClickTimer = setTimeout(() => {
                    cockroachClickCount = 0;
                }, 2000);

                // Trigger on 3 clicks
                if (cockroachClickCount >= 3) {
                    cockroachClickCount = 0;
                    // Spawn a bunch of cockroaches!
                    spawnCockroaches(5 + Math.floor(Math.random() * 5)); // 5-9 cockroaches
                    showToast('🪳 COCKROACHES!!!', 'error');
                }
            });
        }

        // Animations toggle
        function toggleAnimations() {
            const enabled = document.getElementById('animations-enabled').checked;
            document.documentElement.style.setProperty('--animation-enabled', enabled ? '1' : '0');
            if (!enabled) {
                document.querySelectorAll('.service-card').forEach(card => {
                    card.style.animation = 'none';
                });
            }
        }

        function applyColorTheme() {
            const theme = document.getElementById('color-theme')?.value || 'default';
            const themeData = colorThemes[theme];

            if (!themeData) {
                console.error('Theme not found:', theme);
                return;
            }

            // Get current light/dark mode
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            const mode = isDarkMode ? 'dark' : 'light';
            const colors = themeData[mode];

            console.log('Applying color theme:', theme, 'mode:', mode);

            // Apply all colors for the current theme and mode
            Object.keys(colors).forEach(varName => {
                document.documentElement.style.setProperty(`--${varName}`, colors[varName]);
                console.log(`Set --${varName} to ${colors[varName]}`);
            });

            localStorage.setItem('colorTheme', theme);
            console.log('Theme saved to localStorage:', theme);
        }

        // Easter eggs (excluding System and Professional per user request)
        const easterEggs = {
            'konami': {
                code: ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'],
                message: '🎮 Konami Code Activated! You found the secret!',
                action: () => {
                    document.body.style.transform = 'rotate(360deg)';
                    document.body.style.transition = 'transform 2s';
                    setTimeout(() => {
                        document.body.style.transform = '';
                    }, 2000);
                }
            },
            'click10': {
                message: '🎉 You clicked the logo 10 times! Here\'s a cookie: 🍪',
                requireClicks: 10
            }
        };

        let konamiIndex = 0;
        let logoClicks = 0;

        document.addEventListener('keydown', (e) => {
            if (e.key === easterEggs.konami.code[konamiIndex]) {
                konamiIndex++;
                if (konamiIndex === easterEggs.konami.code.length) {
                    showEasterEgg(easterEggs.konami.message);
                    easterEggs.konami.action();
                    konamiIndex = 0;
                }
            } else {
                konamiIndex = 0;
            }
        });

        function setupEasterEggs() {
            const logo = document.querySelector('header h1');
            if (logo) {
                logo.style.cursor = 'pointer';
                logo.addEventListener('click', () => {
                    // Skip easter eggs for System and Professional categories
                    const currentCat = window.currentCategory?.toLowerCase();
                    if (currentCat === 'system' || currentCat === 'professional') return;

                    logoClicks++;
                    if (logoClicks >= easterEggs.click10.requireClicks) {
                        showEasterEgg(easterEggs.click10.message);
                        logoClicks = 0;
                    }
                });
            }
        }

        function showEasterEgg(message) {
            const container = document.getElementById('easter-egg');
            container.innerHTML = `<p>${message}</p><button onclick="hideEasterEgg()">Close</button>`;
            container.classList.add('show');
            playSound('success');
            setTimeout(hideEasterEgg, 5000);
        }

        function hideEasterEgg() {
            document.getElementById('easter-egg').classList.remove('show');
        }

        // Widget System
        const widgetSystem = {
            widgets: [],
            editMode: false,
            layoutMode: 'classic', // 'classic' or 'widget'
            draggedWidgetId: null, // Track dragged widget for repositioning
            isResizing: false, // Track if currently resizing to prevent drag conflicts

            init() {
                // Load layout mode from localStorage
                this.layoutMode = localStorage.getItem('layoutMode') || 'classic';
                this.loadLayout();

                if (this.layoutMode === 'widget') {
                    // Ensure we start in view mode, NOT edit mode
                    this.editMode = false;

                    this.showWidgetLayout();
                    // Start in view mode, show edit button and widget mode toggle
                    const editBtn = document.getElementById('edit-layout-btn');
                    if (editBtn) {
                        editBtn.style.display = 'flex';
                        editBtn.style.visibility = 'visible';
                        editBtn.style.opacity = '1';
                    }

                    const widgetToggle = document.getElementById('widget-mode-toggle');
                    if (widgetToggle) {
                        widgetToggle.style.display = 'flex';
                        widgetToggle.style.visibility = 'visible';
                        widgetToggle.style.opacity = '1';
                    }

                    // Hide classic mode toggle
                    const classicToggle = document.getElementById('layout-mode-toggle');
                    if (classicToggle) classicToggle.style.display = 'none';
                } else {
                    // Classic mode: show classic dashboard, hide ALL widget stuff
                    const dashboard = document.getElementById('main-dashboard');
                    if (dashboard) dashboard.style.display = 'block';

                    // Hide widget layout container
                    const container = document.getElementById('widget-layout-container');
                    if (container) container.style.display = 'none';

                    // Hide editor bar and palette
                    const editorBar = document.getElementById('layout-editor-bar');
                    if (editorBar) editorBar.classList.remove('active');

                    const palette = document.getElementById('widget-palette');
                    if (palette) palette.classList.remove('active');

                    // Show classic mode toggle (🧩)
                    const toggle = document.getElementById('layout-mode-toggle');
                    if (toggle) {
                        toggle.style.display = 'flex';
                        toggle.style.visibility = 'visible';
                        toggle.style.opacity = '1';
                    }

                    // Hide widget mode buttons
                    const editBtn = document.getElementById('edit-layout-btn');
                    if (editBtn) editBtn.style.display = 'none';

                    const widgetToggle = document.getElementById('widget-mode-toggle');
                    if (widgetToggle) widgetToggle.style.display = 'none';
                }

                // Initialize drag and drop for palette
                this.initPaletteDragDrop();
            },

            toggleLayoutMode() {
                if (this.layoutMode === 'classic') {
                    this.switchToWidgetMode();
                } else {
                    this.switchToClassicMode();
                }
            },

            switchToWidgetMode() {
                this.layoutMode = 'widget';
                localStorage.setItem('layoutMode', 'widget');

                // Ensure we're NOT in edit mode
                this.editMode = false;

                // Hide classic dashboard completely
                const dashboard = document.getElementById('main-dashboard');
                if (dashboard) dashboard.style.display = 'none';

                // Hide classic mode toggle button
                const classicToggle = document.getElementById('layout-mode-toggle');
                if (classicToggle) classicToggle.style.display = 'none';

                // Hide editor bar and palette (make sure they're hidden)
                const editorBar = document.getElementById('layout-editor-bar');
                if (editorBar) editorBar.classList.remove('active');

                const palette = document.getElementById('widget-palette');
                if (palette) palette.classList.remove('active');

                // Show widget layout in view mode (not edit mode)
                this.showWidgetLayout();

                // Show edit button so user can enter edit mode
                const editBtn = document.getElementById('edit-layout-btn');
                if (editBtn) {
                    editBtn.style.display = 'flex';
                    editBtn.style.visibility = 'visible';
                    editBtn.style.opacity = '1';
                }

                // Show widget mode toggle (📋 button to go back to classic)
                const widgetToggle = document.getElementById('widget-mode-toggle');
                if (widgetToggle) {
                    widgetToggle.style.display = 'flex';
                    widgetToggle.style.visibility = 'visible';
                    widgetToggle.style.opacity = '1';
                }

                showToast('Widget mode enabled! Click ✏️ to edit layout', 'success');
            },

            switchToClassicMode() {
                this.layoutMode = 'classic';
                localStorage.setItem('layoutMode', 'classic');

                // Exit edit mode first if in edit mode
                if (this.editMode) {
                    this.exitEditMode();
                }

                // Show classic dashboard
                const dashboard = document.getElementById('main-dashboard');
                if (dashboard) dashboard.style.display = 'block';

                // Hide widget layout completely
                const container = document.getElementById('widget-layout-container');
                if (container) container.style.display = 'none';

                // Show classic mode toggle button (🧩 to switch to widget mode)
                const toggle = document.getElementById('layout-mode-toggle');
                if (toggle) {
                    toggle.style.display = 'flex';
                    toggle.style.visibility = 'visible';
                    toggle.style.opacity = '1';
                }

                // Hide widget mode buttons
                const editBtn = document.getElementById('edit-layout-btn');
                if (editBtn) editBtn.style.display = 'none';

                const widgetToggle = document.getElementById('widget-mode-toggle');
                if (widgetToggle) widgetToggle.style.display = 'none';

                showToast('Classic mode enabled', 'success');
            },

            showWidgetLayout() {
                // Hide classic dashboard
                const dashboard = document.getElementById('main-dashboard');
                if (dashboard) dashboard.style.display = 'none';

                // Show widget container
                const container = document.getElementById('widget-layout-container');
                if (container) {
                    container.style.display = 'grid';
                }

                this.renderWidgets();
            },

            enterEditMode() {
                this.editMode = true;
                document.getElementById('layout-editor-bar').classList.add('active');
                document.getElementById('widget-palette').classList.add('active');

                // Hide edit layout button
                const editBtn = document.getElementById('edit-layout-btn');
                if (editBtn) editBtn.style.display = 'none';

                // Hide widget mode toggle while editing
                const widgetToggle = document.getElementById('widget-mode-toggle');
                if (widgetToggle) widgetToggle.style.display = 'none';

                // Add edit mode class to all widgets
                this.widgets.forEach(widget => {
                    const el = document.getElementById(widget.id);
                    if (el) {
                        el.classList.add('editing');
                        el.draggable = true;
                    }
                });

                showToast('Edit mode: Drag widgets to reposition, grab handles to resize', 'info');
            },

            exitEditMode() {
                this.editMode = false;
                document.getElementById('layout-editor-bar').classList.remove('active');
                document.getElementById('widget-palette').classList.remove('active');

                // Show edit layout button (only in widget mode)
                if (this.layoutMode === 'widget') {
                    const editBtn = document.getElementById('edit-layout-btn');
                    if (editBtn) {
                        editBtn.style.display = 'flex';
                        editBtn.style.visibility = 'visible';
                        editBtn.style.opacity = '1';
                    }

                    // Show widget mode toggle button to switch back to classic
                    const widgetToggle = document.getElementById('widget-mode-toggle');
                    if (widgetToggle) {
                        widgetToggle.style.display = 'flex';
                        widgetToggle.style.visibility = 'visible';
                        widgetToggle.style.opacity = '1';
                    }
                }

                // Remove edit mode class from all widgets
                this.widgets.forEach(widget => {
                    const el = document.getElementById(widget.id);
                    if (el) {
                        el.classList.remove('editing');
                        el.draggable = false;
                    }
                });

                this.saveLayout();
                showToast('Layout saved! Click ✏️ to edit again or 📋 for classic mode', 'success');
            },

            addWidget(type, x, y, width, height, settings = {}) {
                const widget = {
                    id: 'widget-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                    type: type,
                    x: x || 0,
                    y: y || 0,
                    width: width || 3,
                    height: height || 2,
                    settings: settings
                };

                this.widgets.push(widget);
                this.renderWidget(widget);
                this.saveLayout();

                return widget;
            },

            removeWidget(widgetId) {
                this.widgets = this.widgets.filter(w => w.id !== widgetId);
                const el = document.getElementById(widgetId);
                if (el) el.remove();
                this.saveLayout();
            },

            renderWidgets() {
                const container = document.getElementById('widget-layout-container');
                if (!container) return;

                container.innerHTML = '';
                this.widgets.forEach(widget => this.renderWidget(widget));
            },

            renderWidget(widget) {
                const container = document.getElementById('widget-layout-container');
                if (!container) return;

                const el = document.createElement('div');
                el.id = widget.id;
                el.className = 'widget';
                el.style.gridColumn = `${widget.x + 1} / span ${widget.width}`;
                el.style.gridRow = `${widget.y + 1} / span ${widget.height}`;

                // Set edit mode state - only add editing class if in edit mode
                if (this.editMode) {
                    el.draggable = true;
                    el.classList.add('editing');
                } else {
                    el.draggable = false;
                    // Don't add editing class (element is fresh, no need to remove)
                }

                // Add widget content based on type
                el.innerHTML = this.getWidgetContent(widget);

                // Add drag event listeners
                el.addEventListener('dragstart', (e) => this.handleWidgetDragStart(e, widget));
                el.addEventListener('dragend', (e) => this.handleWidgetDragEnd(e, widget));

                container.appendChild(el);

                // Initialize resize handlers
                this.initWidgetResize(el);

                // Start widget updates if needed
                if (widget.type === 'clock') {
                    this.startClockWidget(widget.id);
                } else if (widget.type === 'weather') {
                    this.startWeatherWidget(widget.id);
                } else if (widget.type === 'title') {
                    this.startTitleWidget(widget.id);
                } else if (widget.type === 'categories') {
                    this.startCategoriesWidget(widget.id);
                } else if (widget.type === 'services') {
                    this.startServicesWidget(widget.id);
                } else if (widget.type === 'profile') {
                    this.startProfileWidget(widget.id);
                }
            },

            getWidgetContent(widget) {
                const widgetDefs = {
                    clock: {
                        title: '🕐 Clock',
                        content: '<div class="widget-content clock-widget"><div class="clock-time" id="' + widget.id + '-time">00:00:00</div><div class="clock-date" id="' + widget.id + '-date">Loading...</div><div class="clock-timezone" id="' + widget.id + '-timezone"></div></div>'
                    },
                    weather: {
                        title: '🌤️ Weather',
                        content: '<div class="widget-content weather-widget"><div class="weather-main"><div class="weather-icon" id="' + widget.id + '-icon">☁️</div><div><div class="weather-temp" id="' + widget.id + '-temp">--°</div><div class="weather-desc" id="' + widget.id + '-desc">Loading...</div></div></div><div class="weather-details" id="' + widget.id + '-details"></div><div class="weather-location" id="' + widget.id + '-location"></div></div>'
                    },
                    profile: {
                        title: '👤 Profile',
                        content: '<div class="widget-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 0.5rem; cursor: pointer; padding: 1.5rem;" onclick="showProfile(event)" title="Click to manage profile"><div style="font-size: 2rem;">👤</div><div id="' + widget.id + '-username" style="font-weight: 600; color: var(--text-primary); text-align: center;">Loading...</div><div id="' + widget.id + '-roles" style="font-size: 0.85rem; color: var(--text-secondary); text-align: center;">Loading...</div></div>'
                    },
                    title: {
                        title: '📝 Title',
                        content: '<div class="widget-content" style="text-align: center;"><h1 style="margin: 0;" id="' + widget.id + '-title">🚀 Local Services Dashboard</h1><p style="margin: 0.5rem 0 0 0;" id="' + widget.id + '-subtitle">Your development environment at a glance</p></div>'
                    },
                    categories: {
                        title: '📁 Categories',
                        content: '<div class="widget-content"><div id="' + widget.id + '-tabs" class="category-tabs"></div></div>'
                    },
                    search: {
                        title: '🔍 Search',
                        content: '<div class="widget-content"><input type="text" id="' + widget.id + '-search" class="search-box" placeholder="Search services..." oninput="widgetSystem.handleSearchInput(\'' + widget.id + '\')"></div>'
                    },
                    services: {
                        title: '🚀 Services',
                        content: '<div class="widget-content"><div id="' + widget.id + '-grid" class="services-grid"></div></div>'
                    },
                    config: {
                        title: '⚙️ Settings',
                        content: '<div class="widget-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem;"><button class="btn" onclick="showSettings(event)" style="padding: 1rem 2rem; font-size: 1rem;">⚙️ Open Settings</button></div>'
                    },
                    tools: {
                        title: '🛠️ Tools',
                        content: '<div class="widget-content" style="display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 1rem;"><button class="btn" onclick="showTools(event)" style="padding: 1rem 2rem; font-size: 1rem;">🛠️ Open Tools</button></div>'
                    }
                };

                const def = widgetDefs[widget.type] || { title: 'Unknown', content: '<div>Unknown widget type</div>' };

                return `
                    <div class="widget-header">
                        <div class="widget-title">${def.title}</div>
                        <div class="widget-controls">
                            <button class="widget-btn" onclick="widgetSystem.configureWidget('${widget.id}')" title="Settings">⚙️</button>
                            <button class="widget-btn" onclick="widgetSystem.removeWidget('${widget.id}')" title="Remove">🗑️</button>
                        </div>
                    </div>
                    ${def.content}
                    <div class="widget-resize-handle n" data-widget-id="${widget.id}" data-direction="n" draggable="false"></div>
                    <div class="widget-resize-handle ne" data-widget-id="${widget.id}" data-direction="ne" draggable="false"></div>
                    <div class="widget-resize-handle e" data-widget-id="${widget.id}" data-direction="e" draggable="false"></div>
                    <div class="widget-resize-handle se" data-widget-id="${widget.id}" data-direction="se" draggable="false"></div>
                    <div class="widget-resize-handle s" data-widget-id="${widget.id}" data-direction="s" draggable="false"></div>
                    <div class="widget-resize-handle sw" data-widget-id="${widget.id}" data-direction="sw" draggable="false"></div>
                    <div class="widget-resize-handle w" data-widget-id="${widget.id}" data-direction="w" draggable="false"></div>
                    <div class="widget-resize-handle nw" data-widget-id="${widget.id}" data-direction="nw" draggable="false"></div>
                `;
            },

            // Clock Widget
            startClockWidget(widgetId) {
                const updateClock = () => {
                    const now = new Date();
                    const timeEl = document.getElementById(widgetId + '-time');
                    const dateEl = document.getElementById(widgetId + '-date');
                    const timezoneEl = document.getElementById(widgetId + '-timezone');

                    if (timeEl) {
                        timeEl.textContent = now.toLocaleTimeString('en-US', { hour12: false });
                    }
                    if (dateEl) {
                        dateEl.textContent = now.toLocaleDateString('en-US', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                    }
                    if (timezoneEl) {
                        timezoneEl.textContent = Intl.DateTimeFormat().resolvedOptions().timeZone;
                    }
                };

                updateClock();
                setInterval(updateClock, 1000);
            },

            // Weather Widget
            async startWeatherWidget(widgetId) {
                // Mock weather data - in production, call a weather API
                const mockWeather = {
                    temp: Math.round(15 + Math.random() * 15),
                    description: ['Sunny', 'Cloudy', 'Partly Cloudy', 'Rainy'][Math.floor(Math.random() * 4)],
                    humidity: Math.round(40 + Math.random() * 40),
                    wind: Math.round(5 + Math.random() * 15),
                    location: 'Local'
                };

                const iconEl = document.getElementById(widgetId + '-icon');
                const tempEl = document.getElementById(widgetId + '-temp');
                const descEl = document.getElementById(widgetId + '-desc');
                const detailsEl = document.getElementById(widgetId + '-details');
                const locationEl = document.getElementById(widgetId + '-location');

                const weatherIcons = {
                    'Sunny': '☀️',
                    'Cloudy': '☁️',
                    'Partly Cloudy': '⛅',
                    'Rainy': '🌧️'
                };

                if (iconEl) iconEl.textContent = weatherIcons[mockWeather.description] || '🌤️';
                if (tempEl) tempEl.textContent = mockWeather.temp + '°C';
                if (descEl) descEl.textContent = mockWeather.description;
                if (detailsEl) {
                    detailsEl.innerHTML = `
                        <div class="weather-detail"><span>💧</span> ${mockWeather.humidity}%</div>
                        <div class="weather-detail"><span>💨</span> ${mockWeather.wind} km/h</div>
                    `;
                }
                if (locationEl) locationEl.textContent = '📍 ' + mockWeather.location;
            },

            // Profile Widget
            startProfileWidget(widgetId) {
                const container = document.getElementById(widgetId + '-content');
                if (!container) {
                    console.error('Profile widget container not found:', widgetId + '-content');
                    return;
                }

                // Get current user info
                if (typeof currentUser !== 'undefined' && currentUser) {
                    const fullName = [currentUser.first_name, currentUser.last_name].filter(Boolean).join(' ');
                    container.innerHTML = `
                        <div class="user-card" style="padding: 0.5rem; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">👤</div>
                            <div style="font-weight: 600; font-size: 1.1rem;">${currentUser.username}</div>
                            ${fullName ? `<div style="font-weight: 500; margin-top: 0.25rem;">${fullName}</div>` : ''}
                            ${currentUser.email ? `<div style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.25rem;">${currentUser.email}</div>` : ''}
                            ${currentUser.roles && currentUser.roles.length > 0 ? `<div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">Roles: ${currentUser.roles.join(', ')}</div>` : ''}
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Not logged in</div>';
                }
            },

            // Title Widget
            startTitleWidget(widgetId) {
                const titleEl = document.getElementById(widgetId + '-title');
                const subtitleEl = document.getElementById(widgetId + '-subtitle');

                if (typeof config !== 'undefined' && config !== null && config.settings) {
                    if (titleEl && config.settings.title) {
                        titleEl.textContent = config.settings.title;
                    }
                    if (subtitleEl && config.settings.subtitle) {
                        subtitleEl.textContent = config.settings.subtitle;
                    }
                }
            },

            // Categories Widget
            startCategoriesWidget(widgetId) {
                const container = document.getElementById(widgetId + '-tabs');
                if (!container) {
                    console.error('Categories widget container not found:', widgetId + '-tabs');
                    return;
                }

                container.innerHTML = '';

                if (typeof config === 'undefined' || config === null || !config.categories || config.categories.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem;">No categories</p>';
                    return;
                }

                // Create category tabs
                config.categories.forEach((category, index) => {
                    const btn = document.createElement('button');
                    btn.className = 'tab-btn';

                    if (category.icon) {
                        btn.textContent = `${category.icon} ${category.name}`;
                    } else {
                        btn.textContent = category.name;
                    }

                    btn.onclick = () => {
                        // Update active state
                        container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        // Update services widget if it exists
                        const servicesWidget = widgetSystem.widgets.find(w => w.type === 'services');
                        if (servicesWidget) {
                            widgetSystem.startServicesWidget(servicesWidget.id, category.name);
                        }
                    };

                    if (index === 0) {
                        btn.classList.add('active');
                    }

                    container.appendChild(btn);
                });
            },

            // Services Widget
            startServicesWidget(widgetId, categoryName) {
                const container = document.getElementById(widgetId + '-grid');
                if (!container) {
                    console.error('Services widget container not found:', widgetId + '-grid');
                    return;
                }

                container.innerHTML = '';

                if (typeof config === 'undefined' || config === null || !config.services || config.services.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem;">No services configured</p>';
                    return;
                }

                // Get category to display - use provided or first category
                let targetCategory = categoryName;
                if (!targetCategory && config.categories && config.categories.length > 0) {
                    targetCategory = config.categories[0].name;
                }

                // Filter and render services
                const categoryServices = targetCategory
                    ? config.services.filter(s => s.category === targetCategory)
                    : config.services;

                if (categoryServices.length === 0) {
                    container.innerHTML = `<p style="color: var(--text-secondary); padding: 1rem;">No services in ${targetCategory}</p>`;
                    return;
                }

                // Apply grid columns setting
                const gridColumns = config.settings?.grid_columns || 'auto';
                if (gridColumns === 'auto') {
                    container.removeAttribute('data-columns');
                } else {
                    container.setAttribute('data-columns', gridColumns);
                }

                // Render each service using the shared createServiceCard function
                categoryServices.forEach(service => {
                    if (typeof createServiceCard !== 'undefined') {
                        const card = createServiceCard(service);
                        container.appendChild(card);
                    }
                });
            },

            // Profile Widget
            startProfileWidget(widgetId) {
                const usernameEl = document.getElementById(widgetId + '-username');
                const rolesEl = document.getElementById(widgetId + '-roles');

                if (!usernameEl || !rolesEl) {
                    console.error('Profile widget elements not found:', widgetId);
                    return;
                }

                // Update profile widget with current user data
                if (typeof currentUser !== 'undefined' && currentUser) {
                    let displayName = currentUser.username;
                    if (currentUser.is_local) {
                        displayName = 'localhost';
                    } else if (currentUser.first_name && currentUser.last_name) {
                        displayName = `${currentUser.first_name} ${currentUser.last_name}`;
                    } else if (currentUser.first_name) {
                        displayName = currentUser.first_name;
                    }

                    usernameEl.textContent = displayName;
                    rolesEl.textContent = currentUser.roles ? currentUser.roles.join(', ') : 'No roles';
                } else {
                    usernameEl.textContent = 'Not logged in';
                    rolesEl.textContent = 'Please log in';
                }
            },

            // Drag and Drop
            initPaletteDragDrop() {
                const paletteWidgets = document.querySelectorAll('.palette-widget');
                paletteWidgets.forEach(pw => {
                    pw.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('widget-type', pw.dataset.widgetType);
                        e.dataTransfer.effectAllowed = 'copy';
                        this.draggedWidgetId = null; // Clear dragged widget (this is from palette)
                    });
                });

                const container = document.getElementById('widget-layout-container');
                if (container) {
                    container.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = this.draggedWidgetId ? 'move' : 'copy';
                    });

                    container.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const widgetType = e.dataTransfer.getData('widget-type');

                        // Calculate grid position from drop coordinates
                        // Using finer grid (48 columns) for precise positioning
                        const rect = container.getBoundingClientRect();

                        // Get computed style to get actual gap and padding values
                        const style = window.getComputedStyle(container);
                        const gap = parseFloat(style.gap) || 16; // Default to 16px (1rem)
                        const padding = parseFloat(style.padding) || 16;

                        // Calculate position accounting for padding and gaps
                        const relativeX = e.clientX - rect.left - padding;
                        const relativeY = e.clientY - rect.top - padding;

                        // Calculate cell dimensions including gap
                        const totalGridWidth = rect.width - 2 * padding;
                        const totalGridHeight = rect.height - 2 * padding;

                        // Account for gaps: width of each column = (total - gaps) / columns
                        const cellWidth = (totalGridWidth - gap * 47) / 48;
                        const cellHeight = 80; // Fixed row height

                        // Calculate grid position (add gap to account for spacing between cells)
                        const x = Math.max(0, Math.min(47, Math.floor(relativeX / (cellWidth + gap))));
                        const y = Math.max(0, Math.floor(relativeY / (cellHeight + gap)));

                        if (widgetType) {
                            // Adding new widget from palette
                            this.addWidget(widgetType, x, y);
                            showToast('Widget added', 'success');
                        } else if (this.draggedWidgetId) {
                            // Moving existing widget
                            this.moveWidget(this.draggedWidgetId, x, y);
                            showToast('Widget moved', 'success');
                        }

                        this.draggedWidgetId = null;
                    });
                }
            },

            handleWidgetDragStart(e, widget) {
                if (!this.editMode || this.isResizing) {
                    e.preventDefault();
                    return;
                }
                this.draggedWidgetId = widget.id;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/plain', widget.id); // Required for Firefox
                e.target.classList.add('dragging');
            },

            handleWidgetDragEnd(e, widget) {
                e.target.classList.remove('dragging');
            },

            moveWidget(widgetId, newX, newY) {
                const widget = this.widgets.find(w => w.id === widgetId);
                if (!widget) return;

                // Clamp position to grid (48 columns)
                newX = Math.max(0, Math.min(newX, 48 - widget.width));
                newY = Math.max(0, newY);

                widget.x = newX;
                widget.y = newY;

                // Update visual position
                const el = document.getElementById(widgetId);
                if (el) {
                    el.style.gridColumn = `${widget.x + 1} / span ${widget.width}`;
                    el.style.gridRow = `${widget.y + 1} / span ${widget.height}`;
                }

                this.saveLayout();
            },

            // Resize functionality
            initWidgetResize(widgetEl) {
                if (!this.editMode) return;

                const handles = widgetEl.querySelectorAll('.widget-resize-handle');
                handles.forEach(handle => {
                    handle.addEventListener('mousedown', (e) => this.startResize(e, handle));
                });
            },

            startResize(e, handle) {
                if (!this.editMode) return;
                e.preventDefault();
                e.stopPropagation();

                // Set resizing flag to prevent drag conflicts
                this.isResizing = true;

                const widgetId = handle.dataset.widgetId;
                const direction = handle.dataset.direction;
                const widget = this.widgets.find(w => w.id === widgetId);
                const widgetEl = document.getElementById(widgetId);

                if (!widget || !widgetEl) return;

                // Disable dragging during resize
                widgetEl.draggable = false;

                const container = document.getElementById('widget-layout-container');
                const containerRect = container.getBoundingClientRect();
                const cellWidth = containerRect.width / 48;
                const cellHeight = 80;

                const startX = e.clientX;
                const startY = e.clientY;
                const startWidth = widget.width;
                const startHeight = widget.height;
                const startPosX = widget.x;
                const startPosY = widget.y;

                widgetEl.classList.add('resizing');

                const onMouseMove = (e) => {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;

                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    let newX = startPosX;
                    let newY = startPosY;

                    // Calculate new dimensions and position based on direction
                    // East resize (right edge)
                    if (direction.includes('e')) {
                        newWidth = Math.round((startWidth * cellWidth + deltaX) / cellWidth);
                    }
                    // West resize (left edge) - also changes x position
                    if (direction.includes('w')) {
                        const widthChange = Math.round(deltaX / cellWidth);
                        newWidth = startWidth - widthChange;
                        newX = startPosX + widthChange;
                    }
                    // South resize (bottom edge)
                    if (direction.includes('s')) {
                        newHeight = Math.round((startHeight * cellHeight + deltaY) / cellHeight);
                    }
                    // North resize (top edge) - also changes y position
                    if (direction.includes('n')) {
                        const heightChange = Math.round(deltaY / cellHeight);
                        newHeight = startHeight - heightChange;
                        newY = startPosY + heightChange;
                    }

                    // Constrain to minimum and maximum (48 columns)
                    newWidth = Math.max(1, newWidth);
                    newHeight = Math.max(1, newHeight);
                    newX = Math.max(0, Math.min(newX, 48 - newWidth));
                    newY = Math.max(0, newY);

                    // Update widget dimensions and position
                    widget.width = newWidth;
                    widget.height = newHeight;
                    widget.x = newX;
                    widget.y = newY;

                    // Update visual size and position
                    widgetEl.style.gridColumn = `${widget.x + 1} / span ${widget.width}`;
                    widgetEl.style.gridRow = `${widget.y + 1} / span ${widget.height}`;
                };

                const onMouseUp = () => {
                    widgetEl.classList.remove('resizing');

                    // Re-enable dragging after resize
                    if (this.editMode) {
                        widgetEl.draggable = true;
                    }

                    // Clear resizing flag
                    this.isResizing = false;

                    document.removeEventListener('mousemove', onMouseMove);
                    document.removeEventListener('mouseup', onMouseUp);
                    this.saveLayout();
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            },

            addWidgetFromPalette() {
                document.getElementById('widget-palette').classList.toggle('active');
            },

            configureWidget(widgetId) {
                showToast('Widget configuration coming soon', 'info');
            },

            resetLayout() {
                if (confirm('Reset layout to default? This will remove all widgets.')) {
                    this.widgets = [];
                    this.createDefaultLayout();
                    this.renderWidgets();
                    this.saveLayout();
                    showToast('Layout reset to default', 'success');
                }
            },

            createDefaultLayout() {
                // Improved default layout for 48-column grid
                // Top row: Title centered with clock on right
                this.addWidget('title', 0, 0, 36, 1);      // Title: full left side
                this.addWidget('clock', 36, 0, 12, 2);      // Clock: right side, 2 rows tall

                // Second row: Profile, search, and categories
                this.addWidget('profile', 0, 1, 8, 1);      // Profile: compact left
                this.addWidget('search', 8, 1, 12, 1);      // Search: next to profile
                this.addWidget('categories', 20, 1, 16, 1); // Categories: center-right

                // Main content area: Services and weather
                this.addWidget('services', 0, 2, 36, 5);    // Services: large main area
                this.addWidget('weather', 36, 2, 12, 3);    // Weather: right column, 3 rows
            },

            saveLayout() {
                // Only save widgets, NOT mode (mode is saved separately via layoutMode localStorage key)
                const layout = {
                    widgets: this.widgets
                };
                localStorage.setItem('widgetLayout', JSON.stringify(layout));
            },

            loadLayout() {
                try {
                    const saved = localStorage.getItem('widgetLayout');
                    if (saved) {
                        const layout = JSON.parse(saved);
                        this.widgets = layout.widgets || [];
                        // Don't load mode from widgetLayout - it's loaded separately in init()
                    }

                    // Create default layout if no widgets
                    if (this.widgets.length === 0 && this.layoutMode === 'widget') {
                        this.createDefaultLayout();
                    }
                } catch (e) {
                    console.error('Failed to load widget layout:', e);
                }
            },

            // Search Widget Handler
            handleSearchInput(searchWidgetId) {
                const searchInput = document.getElementById(searchWidgetId + '-search');
                if (!searchInput) return;

                const query = searchInput.value.toLowerCase().trim();

                // Find all services widgets
                const servicesWidgets = this.widgets.filter(w => w.type === 'services');

                servicesWidgets.forEach(servicesWidget => {
                    const container = document.getElementById(servicesWidget.id + '-grid');
                    if (!container) return;

                    container.innerHTML = '';

                    if (typeof config === 'undefined' || !config.services || config.services.length === 0) {
                        container.innerHTML = '<p style="color: var(--text-secondary); padding: 1rem;">No services configured</p>';
                        return;
                    }

                    // Filter services by search query
                    let filteredServices = config.services;

                    if (query) {
                        filteredServices = config.services.filter(service => {
                            const nameMatch = service.name.toLowerCase().includes(query);
                            const descMatch = service.description && service.description.toLowerCase().includes(query);
                            const urlMatch = service.url && service.url.toLowerCase().includes(query);
                            const categoryMatch = service.category && service.category.toLowerCase().includes(query);
                            return nameMatch || descMatch || urlMatch || categoryMatch;
                        });
                    }

                    if (filteredServices.length === 0) {
                        container.innerHTML = `<p style="color: var(--text-secondary); padding: 1rem;">No services match "${query}"</p>`;
                        return;
                    }

                    // Apply grid columns setting
                    const gridColumns = config.settings?.grid_columns || 'auto';
                    if (gridColumns === 'auto') {
                        container.removeAttribute('data-columns');
                    } else {
                        container.setAttribute('data-columns', gridColumns);
                    }

                    // Render filtered services
                    filteredServices.forEach(service => {
                        if (typeof createServiceCard !== 'undefined') {
                            const card = createServiceCard(service);
                            container.appendChild(card);
                        }
                    });
                });
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize - check authentication first
            checkAuthStatus();

            // Initialize UI/UX features
            try {
                initParticles();
            } catch (e) {
                console.log('Particles initialization failed:', e);
            }

            try {
                setupEasterEggs();
            } catch (e) {
                console.log('Easter eggs setup failed:', e);
            }

            // Load saved preferences
            try {
                const savedTheme = localStorage.getItem('colorTheme');
                if (savedTheme) {
                    const themeSelect = document.getElementById('color-theme');
                    if (themeSelect) {
                        themeSelect.value = savedTheme;
                        applyColorTheme();
                    }
                }

                // Initialize sound checkbox - default to true if not set
                const savedSound = localStorage.getItem('soundEnabled') !== 'false';
                const soundCheckbox = document.getElementById('sound-enabled');
                if (soundCheckbox) {
                    soundCheckbox.checked = savedSound;
                }

                // Initialize ambient sound
                const savedAmbient = localStorage.getItem('ambientSound') || 'none';
                const ambientSelect = document.getElementById('ambient-sound');
                if (ambientSelect) {
                    ambientSelect.value = savedAmbient;
                    // Start ambient sound immediately
                    if (savedAmbient !== 'none') {
                        setTimeout(() => {
                            initAudioContext();
                            playAmbientSound(savedAmbient);
                        }, 500);
                    }
                }

                // Initialize ambient volume
                const savedVolume = localStorage.getItem('ambientVolume') || '15';
                const volumeSlider = document.getElementById('ambient-volume');
                const volumeDisplay = document.getElementById('ambient-volume-display');
                if (volumeSlider && volumeDisplay) {
                    volumeSlider.value = savedVolume;
                    volumeDisplay.textContent = savedVolume + '%';
                }

                // Initialize particle time of day
                const savedParticleTime = localStorage.getItem('particleTime') || 'auto';
                const particleTimeSelect = document.getElementById('particle-time');
                if (particleTimeSelect) {
                    particleTimeSelect.value = savedParticleTime;
                }

                // Initialize particle season
                const savedParticleSeason = localStorage.getItem('particleSeason') || 'auto';
                const particleSeasonSelect = document.getElementById('particle-season');
                if (particleSeasonSelect) {
                    particleSeasonSelect.value = savedParticleSeason;
                }

                // Initialize favourites tab visibility
                const showFavouritesTab = localStorage.getItem('showFavouritesTab') !== 'false'; // default to true
                const favouritesCheckbox = document.getElementById('show-favourites-tab');
                const favouritesTabBtn = document.getElementById('favourites-tab-btn');

                if (favouritesCheckbox) {
                    favouritesCheckbox.checked = showFavouritesTab;
                }
                if (favouritesTabBtn) {
                    favouritesTabBtn.style.display = showFavouritesTab ? 'inline-block' : 'none';
                }
            } catch (e) {
                console.log('Preference loading failed:', e);
            }

            // Initialize cockroach easter egg
            try {
                const cockroachCheckbox = document.getElementById('cockroach-enabled');
                if (cockroachCheckbox) {
                    const savedCockroach = localStorage.getItem('cockroachEnabled') !== 'false';
                    cockroachCheckbox.checked = savedCockroach;
                    cockroachEnabled = savedCockroach;
                }
                initCockroachTrigger();
                if (cockroachEnabled) {
                    startRandomCockroaches();
                }
            } catch (e) {
                console.log('Cockroach initialization failed:', e);
            }

            // Initialize widget system
            try {
                widgetSystem.init();
                console.log('Widget system initialized');
            } catch (e) {
                console.log('Widget system initialization failed:', e);
            }

            // Auto-refresh
            const autoRefreshMinutes = 5;
            setTimeout(() => location.reload(), autoRefreshMinutes * 60 * 1000);
        });
    </script>
</body>
</html>
